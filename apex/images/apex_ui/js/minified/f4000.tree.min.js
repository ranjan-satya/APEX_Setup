/*!
 * Copyright (c) 2013, 2024, Oracle and/or its affiliates.
 */
!function(e,t,n,o){"use strict";e.widget("apex.designerTree",e.apex.treeView,{_create:function(){let t=this;e.extend(this.options,{selectionChange:function(){let n,o=this.id;n=t.getSelectedComponents(e(this)),e(document).trigger("selectionChanged",[o,n,t.getSelectedNodes()])},copied:function(e,n){t.nodesCopied(n)},moved:function(e,n){t.nodesMoved(n)},deleted:function(e,n){t.nodesDeleted(n)}}),this.options.contextMenuEntries&&(this.options.contextMenu={items:this._getContextMenu(this.options.contextMenuEntries)}),this.createComponent=function(e,n){t.options.createComponent.call(t,e,n)},this._super("init",this.options)},nodesDeleted:function(e){let o,i,s,a,r=this;const p=["region_slot","page_slot","branches","processes","validations","computations","workflow_outgoing_links","workflow_incoming_links","workflow_params"];if(e.items.length>0){a=r.getSelectedNodes();for(let e=0;e<a.length;e++)p.includes(a[e].type)&&a[e].children.length<1&&(a[e]=a[e]._parent);i=t.transaction.message({action:t.MESSAGE_ACTION.DELETE,component:r.getComponent(e.items[0].node),count:e.items.length}),s=t.transaction.start("",i);for(let t=0;t<e.items.length;t++)if(o=r.getComponent(e.items[t].node),o)try{o.remove()}catch(e){return s.cancel(),r.element.trigger("refresh"),void n.showError(e)}}apex.commandHistory.execute(s),r.setSelectedNodes(a,!0,!0)},nodesCopied:function(e,n){let o,i,s,a,r=this,p=[];if(e.items.length>0){s=t.transaction.message({action:t.MESSAGE_ACTION.DUPLICATE,component:r.getComponent(e.items[0].toNode),count:e.items.length}),a=t.transaction.start("",s);for(let t=0;t<e.items.length;t++)o=r.getComponent(e.items[t].toNode),0===e.items[t].toIndex?i=null:(i=r.getComponent(e.parentNode.children[e.items[t].toIndex-1]),i||(i="last")),p[t]=o.duplicate(),p[t].move({previousComponent:i,values:r.getComponentHierarchyValues(e.items[t].toNode)});apex.commandHistory.execute(a),n.designerTree("setSelectedComponents",p,e.items[0].toNode._parent.id,!0)}},nodesMoved:function(e){let n,o,i,s=this,a=[];if(e.items.length>0){o=t.transaction.message({action:t.MESSAGE_ACTION.MOVE,component:s.getComponent(e.items[0].toNode),count:e.items.length}),i=t.transaction.start("",o);for(let t=0;t<e.items.length;t++)a[t]=s.getComponent(e.items[t].toNode),0===e.items[t].toIndex?n=null:(n=s.getComponent(e.parentNode.children[e.items[t].toIndex-1]),n||(n="last")),a[t].move({previousComponent:n,values:s.getComponentHierarchyValues(e.items[t].toNode)});apex.commandHistory.execute(i)}},updateComponentNode:function(t,n,o){let i=this;this.getComponentDomNodes$(t,n).each((function(){let t=e(this);o.call(i.getNodes(t,n)[0]),i.update(t)}))},getSelectedComponents:function(){let e=this.getSelectedNodes(),n=[];for(let o=0;o<e.length;o++)e[o].data&&Object.prototype.hasOwnProperty.call(e[o].data,"componentId")&&n.push(t.getComponents(e[o].data.typeId,{id:e[o].data.componentId})[0]);return n},getComponentDomNodes$:function(e,t,n){let o;return n&&(o=this.find({depth:-1,match:function(e){return e.id===n}})),this.find({parentNodeContent$:o,depth:-1,findAll:!0,match:function(t){return t.data.typeId===e.typeId&&t.data.componentId===e.id}})},getComponent:function(e){let n,o=[];if(n=e instanceof jQuery?this.getNodes(e)[0]:e,n.data&&n.data.typeId&&n.data.componentId&&(o=t.getComponents(n.data.typeId,{id:n.data.componentId})),1===o.length)return o[0]},getNearestComponent:function(t,n){let o,i=Array.isArray(t)?t:[t];return n&&(o=this.getComponent(n),(void 0===o||o&&-1===e.inArray(o.typeId,i))&&(o=this.getNearestComponent(i,n._parent))),o},getNearestValue:function(e,t){let n;return n=t?Object.prototype.hasOwnProperty.call(t.data,e)?t.data[e]:this.getNearestValue(e,t._parent):"",n},getComponentNode:function(e,t){return this.getNodes(this.getComponentDomNodes$(e,null,t))[0]},getComponentNodes:function(e,t){return this.getNodes(this.getComponentDomNodes$(e,null,t))},setSelectedComponents:function(t,n,o,i){let s,a=[],r=e(),p=n;if(n||"PDdynamicActionTree"!==this.element[0].id||(p="da_da_events"),o){for(let e=0;e<t.length;e++)r=r.add(this.getComponentDomNodes$(t[e],p));this.setSelection(r)}else{for(let e=0;e<t.length;e++)i?(s=this.getComponentNodes(t[e],p),a.push(...s)):(s=this.getComponentNode(t[e],p),s&&a.push(s));this.setSelectedNodes(a,!1,!0)}},duplicateNodes:function(e,n){let o,i,s,a,r=[];if(e.length>0){o=t.transaction.message({action:t.MESSAGE_ACTION.DUPLICATE,component:this.getComponent(e[0]),count:e.length}),i=t.transaction.start("",o);for(let n=0;n<e.length;n++){if(s=this.getComponent(e[n]),a=s.duplicate(),s.typeId===t.COMP_TYPE.WORKFLOW_VERSION){let e=a.getProperty(t.PROP.STATE);e.setValue("DEVELOPMENT"),"DEVELOPMENT"===e.getValue()&&a.getProperties().forEach((e=>{[t.PROP.CHANGED_ON,t.PROP.CHANGED_BY].includes(e.id)||e.enable()}))}else if(s.typeId===t.COMP_TYPE.WORKFLOW)t.getComponents(t.COMP_TYPE.WORKFLOW_VERSION,{parentId:a.id}).forEach((e=>{let n=e.getProperty(t.PROP.STATE);"INACTIVE"!==n.getValue()?(n.setValue("DEVELOPMENT",!0),e.getProperties().forEach((e=>{[t.PROP.CHANGED_ON,t.PROP.CHANGED_BY].includes(e.id)||e.enable()}))):(e.disable(),e.getProperties().forEach((e=>e.disable())))}));else if(s.typeId===t.COMP_TYPE.WORKFLOW_PARAM){const e=a.getProperty(t.PROP.API_DIRECTION);e.setValue(e.getValue(),!0)}r.push(a)}apex.commandHistory.execute(i),this.setSelectedComponents(r,n,e[0]._parent.id,!0)}},checkComponentHasNode:function(n){let o;return o=e.inArray(n.typeId,t.NO_NODE_COMP_TYPES)>-1?this.checkComponentHasNode(n.getParent()):n,o},addComponentClass:function(e,t,n){let o=this.checkComponentHasNode(e);this.updateComponentNode(o,n,(function(){this.data&&this.data.isPlain||(this.classes+=" "+t)}))},removeComponentClass:function(t,n,o){let i=this.checkComponentHasNode(t);this.updateComponentNode(i,o,(function(){this.classes=e.grep(this.classes.split(" "),(function(e){return e!==n})).join(" ")}))},getComponentHierarchyValues:function(e){let n=this;function o(t){let o;Object.prototype.hasOwnProperty.call(t,"value")?i.push({id:t.id,value:t.value}):t.typeId?(o=n.getNearestComponent(t.typeId,e._parent),i.push({id:t.id,value:o?o.id:""})):t.id&&i.push({id:t.id,value:n.getNearestValue(t.id,e._parent)+""})}let i=[];switch(e.type){case"region":"page_slot"===e._parent.type?(o({id:t.PROP.PARENT_REGION,value:""}),o({id:t.PROP.SLOT_PLACEHOLDER})):"region"===e._parent.type?(o({id:t.PROP.PARENT_REGION,typeId:t.COMP_TYPE.REGION}),o({id:t.PROP.SLOT_PLACEHOLDER,value:""})):(o({id:t.PROP.PARENT_REGION,typeId:t.COMP_TYPE.REGION}),o({id:t.PROP.SLOT_PLACEHOLDER}));break;case"item":case"button":"page_slot"===e._parent.type?(o({id:t.PROP.REGION,value:""}),o({id:t.PROP.SLOT_PLACEHOLDER})):"region"===e._parent.type?(o({id:t.PROP.REGION,typeId:t.COMP_TYPE.REGION}),o({id:t.PROP.SLOT_PLACEHOLDER,value:""})):(o({id:t.PROP.REGION,typeId:t.COMP_TYPE.REGION}),o({id:t.PROP.SLOT_PLACEHOLDER}));break;case"da_action":o({id:t.PROP.DA_EVENT,typeId:t.COMP_TYPE.DA_EVENT}),o({id:t.PROP.FIRE_WHEN_EVENT_RESULT_IS});break;case"computation":o({id:t.PROP.COMPUTATION_POINT});break;case"process":"processes"===e._parent.type&&"process"===e._parent._parent.type?o({id:t.PROP.PARENT_PROCESS,typeId:t.COMP_TYPE.PAGE_PROCESS}):o({id:t.PROP.PROCESS_POINT});break;case"branch":o({id:t.PROP.BRANCH_POINT});break;case"facet_group_item":o({id:t.PROP.FACET_GROUP,typeId:t.COMP_TYPE.FACET_GROUP}),o({id:t.PROP.HIDDEN_PARENT_REGION,typeId:t.COMP_TYPE.REGION});break;case"sfilter_group_item":o({id:t.PROP.SFILTER_GROUP,typeId:t.COMP_TYPE.SFILTER_GROUP}),o({id:t.PROP.HIDDEN_PARENT_REGION,typeId:t.COMP_TYPE.REGION})}return i},isCreatable:function(n,o){return 1===n.length&&-1!==e.inArray(n[0].type,o)&&!t.isPageReadOnly()},_getContextMenu:function(e){let n=this,i=0;function s(e){return function(e){function t(e){return o.getMessage("PD.TREE."+e)}let n=[t(e)].concat(Array.prototype.slice.call(arguments,1));return o.formatNoEscape.apply(this,n)}("CREATE",t.getComponentType(e).title.singular)}function a(e){return e.call(n.getSelectedNodes())}function r(e){let o,r,p={label:e.label,accelerator:e.accelerator,type:e.type};return i+=1,p.id=n.id+"_ctx_"+i,p.type||(p.type="action",o=e.action),e.typeId&&(e.label||(p.label=s(e.typeId)),o||(o=function(){n.createComponent(this[0],e.typeId)})),p.action=function(){return a(o)},e.visible&&(r="function"==typeof e.visible?e.visible:Array.isArray(e.visible)?function(){return n._isCreatable(this,e.visible)}:!1===e.visible.global?function(){return o=this,i=e.visible.types,!t.isGlobalPage()&&n._isCreatable(o,i);var o,i}:function(){return n._isCreatable(this,e.visible.types)},p.hide=function(){return!a(r)}),e.disabled&&(p.disabled=function(){return a(e.disabled)}),p}return e.map((e=>r(e)))}}),e.apex.designerTree.addNode=function(n,o){let i,s,a,r,p,d,l=o.setFilter,c=[],m={};if(void 0===l&&(l="parent"),!1===o.header){if(r=n,"parent"===l)for(d=0;d<o.component.filter.properties.length;d++)n.data[o.component.filter.properties[d].id]=o.component.filter.properties[d].value}else{if(i=o.header.component instanceof t.Component?o.header.component.getDisplayTitle():o.header.title?o.header.title:t.getComponentType(o.component.typeId).title.plural,l)if(a={setFilter:l,properties:[]},Array.isArray(o.component))for(d=0;d<o.component.length;d++)a.properties=a.properties.concat(o.component[d].filter.properties);else o.component.filter.properties&&(a.properties=o.component.filter.properties);r=e.apex.designerTree.addHeaderNode(n,{title:i,type:o.header.type,id:o.header.id,idPostfix:o.header.idPostfix,isPlain:o.header.isPlain,hasWarnings:o.header.hasWarnings,hasErrors:o.header.hasErrors,isOpen:o.header.isOpen,openAllParents:o.header.openAllParents,omitIfEmpty:o.header.omitIfEmpty,component:o.header.component,filter:a})}if(Array.isArray(o.component))for(d=0;d<o.component.length;d++)c[d]={typeId:o.component[d].typeId,filter:o.component[d].filter},m[o.component[d].typeId]=o.component[d];else c[0]={typeId:o.component.typeId,filter:o.component.filter},m[o.component.typeId]=o.component;for(s=t.getComponentsAdvanced(c),d=0;d<s.length;d++)m[s[d].typeId].addSubComponents?(p=e.apex.designerTree.addChildNode(r,{title:s[d].getDisplayTitle(),type:m[s[d].typeId].type,component:s[d],isHeader:!1,isPlain:m[s[d].typeId].isPlain,isOpen:m[s[d].typeId].isOpen,openAllParents:!s[d].isOnGlobalPage()&&m[s[d].typeId].openAllParents,omitIfEmpty:m[s[d].typeId].omitIfEmpty}),m[s[d].typeId].addSubComponents(p,s[d])):e.apex.designerTree.addLeafNode(r,{title:s[d].getDisplayTitle(),type:m[s[d].typeId].type,isPlain:m[s[d].typeId].isPlain,component:s[d],openAllParents:!s[d].isOnGlobalPage()&&m[s[d].typeId].openAllParents})},e.apex.designerTree.addLeafNode=function(e,o){let i={type:o.type,label:o.title,classes:"",data:{},commands:{}};if(o.component instanceof t.Component){if(i.data={typeId:o.component.typeId,componentId:o.component.id,isPlain:o.isPlain},!o.isPlain&&(n.isNever(o.component)||n.isInactive(o.component)?i.classes=n.CSS.IS_NEVER:n.isConditional(o.component)&&(i.classes=n.CSS.IS_CONDITIONAL),o.component.hasChanged()&&(i.classes+=" "+n.CSS.IS_CHANGED),o.component.hasErrors()&&(i.classes+=" "+n.CSS.IS_ERROR,i.commands.openAllParents=!0),o.component.hasWarnings()&&(i.classes+=" "+n.CSS.IS_WARNING),o.component.typeId===t.COMP_TYPE.WORKFLOW_VERSION)){let e=o.component.getProperty(t.PROP.STATE).getValue();"ACTIVE"===e?i.label+=` [${n.msg("WF.ACTIVE")}]`:"DEVELOPMENT"===e&&(i.label+=` [${n.msg("WF.DEV")}]`)}o.title||(i.label=o.component.getDisplayTitle())}else o.hasWarnings&&(i.classes+=" "+n.CSS.IS_WARNING),o.hasErrors&&(i.classes+=" "+n.CSS.IS_ERROR,i.commands.openAllParents=!0);return o.isNotImportant&&(i.classes+=" "+n.CSS.IS_NOT_IMPORTANT),Object.prototype.hasOwnProperty.call(o,"id")?i.id=o.id:o.component instanceof t.Component?(i.id=i.type+"_"+o.component.typeId+"_"+o.component.id,0!==i.type.indexOf("inline_")&&0!==i.type.indexOf("page_load_da_")&&"workflow_transition"!==i.type&&"workflow_branch"!==i.type||(i.id=e.id+"_"+i.id)):(i.id=o.type,o.idPostfix&&(i.id+=o.idPostfix),e&&(i.id=e.id+"_"+i.id)),o.tooltip&&(i.tooltip=o.tooltip),Object.prototype.hasOwnProperty.call(o,"icon")&&(!1===o.icon?i.icon=null:i.icon=o.icon),o.openAllParents&&(i.commands.openAllParents=!0),e&&e.children.push(i),i},e.apex.designerTree.addChildNode=function(t,n){let o=e.apex.designerTree.addLeafNode(t,e.extend({isHeader:!0},n));return o.children=[],o.state={},n.isOpen&&(o.state={opened:!0}),n.omitIfEmpty&&(o.commands.omitIfEmpty=!0),n.showHasComponents&&(o.commands.showHasComponents=!0),o},e.apex.designerTree.addHeaderNode=function(t,n){let o;if((n=e.extend({component:{},hasWarnings:!1,hasErrors:!1,isOpen:!1,isPlain:!1,openAllParents:!1,omitIfEmpty:!1,showHasComponents:!1},n)).isHeader=!0,n.isNotImportant=!0,o=e.apex.designerTree.addChildNode(t,n),n.filter)if("parent"===n.filter.setFilter)for(let e=0;e<n.filter.properties.length;e++)t.data[n.filter.properties[e].id]=n.filter.properties[e].value;else if(n.filter.properties)for(let e=0;e<n.filter.properties.length;e++)o.data[n.filter.properties[e].id]=n.filter.properties[e].value;if(n.data)for(let e in n.data)Object.prototype.hasOwnProperty.call(n.data,e)&&(o.data[e]=n.data[e]);return o},e.apex.designerTree.postProcessNodes=function(o){if(o.children){for(let i=0;i<o.children.length;)e.apex.designerTree.postProcessNodes(o.children[i])?o.children.splice(i,1):(o.children[i].commands.openAllParents&&(o.state.opened||(o.state.opened=!0),o.commands.openAllParents||(o.commands.openAllParents=!0)),(o.children[i].state&&o.children[i].state.hasComponents||Object.prototype.hasOwnProperty.call(o.children[i].data,"componentId")&&!t.getComponents(o.children[i].data.typeId,{id:o.children[i].data.componentId})[0].isOnGlobalPage())&&(o.state.hasComponents||(o.state.hasComponents=!0,o.commands.showHasComponents&&(o.classes+=" "+n.CSS.IS_POPULATED))),i+=1);return 0===o.children.length&&delete o.state,o.commands.omitIfEmpty&&(o.children&&0===o.children.length||!o.children)}return delete o.state,!1}}(apex.jQuery,window.pe,window.pageDesigner,apex.lang);