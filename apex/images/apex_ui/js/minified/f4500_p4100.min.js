/*!
 * Copyright (c) 2021, 2023, Oracle and/or its affiliates.
 */
!function(e,t,n,r,o){"use strict";var a,i,l,c,d=e("#treeNav"),s=e("#peMain"),u=apex.widget.waitPopup();const p="blueprint-mode",E="table",g="column",f="column-blueprint",m="column-builtin",A="column-inline",b="column-formula",h="column-sequence",y="column-data_source",T="datasource",P="TablesParent",D="DataSourcesParent",N="action",w="separator",_=t.hasOwnProperty,O="click";var S={id:9999,type:g,label:"NEWCOLUMN",display:"NewColumn",parentTable:"NEWTABLE",seq:99,lang:"en",source:"BUILTIN",ds:"number.guid",builtin:"number.guid:NUMBER",inline:"",min:"1",max:"1000",precision:"0",minDate:"",maxDate:"",formatMask:"",seqStart:"",seqIncrement:"",dsTable:"",dsCustomDataSource:"",dsName:"",dsQuery:"",dsQueryColumn:"",dependsOn:"",formula:"",required:"true",blank:"0",mv:"N",mvDelimiter:"",mvMin:"",mvMax:"",mvPartition:"",mvFormat:"",mvUnique:"",maxLength:"",nodeAction:"addColumn"},C={id:9999,label:"NEWTABLE",display:"NewTable",type:E,seq:99,rows:50,nodeAction:"addTable",children:[]},v={label:"NEWDATASOURCE",type:T,oldLabel:"NEWDATASOURCE",dsType:"SQL_QUERY",table:"",sqlQuery:"",whereClause:"",nodeAction:"addDataSource"};function V(){var e=[];return e.push({id:"add-column-action",label:L("ODG.PE.CONTEXT.ADD_COLUMN"),type:N,action:function(){!function(){var e,t,n,r=d.treeView("getSelection"),o=d.treeView("getNodes",r);o[0].type===E?(e=r,t=o[0]):(e=r.first().parent().parent(),t=o[0]._parent);n=t.children.length,S.blueprintName=c,S.parentTable=t.label,S.seq=G(t),S.label=x(t,S.label),d.treeView("addNode",e,n,S)}()},hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![E].includes(e[0].type)}},{id:"add-table-action",label:L("ODG.PE.CONTEXT.ADD_TABLE"),type:N,action:function(){!function(){var e,t,n,r=d.treeView("getSelection"),o=d.treeView("getNodes",r);o[0].type===P?(t=r,n=o[0].children.length,e=o[0]):(t=d.treeView("getSelection").first().parent().parent().siblings("div.a-TreeView-content"),n=0,e=o[0]._parent);C.blueprintName=c,C.seq=G(e),C.label=x(e,C.label),d.treeView("addNode",t,n,C)}()},hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![P].includes(e[0].type)}},{id:"add-datasource-action",label:L("ODG.PE.CONTEXT.ADD_DATA_SOURCE"),type:N,action:function(){!function(){var e,t,n,r=d.treeView("getSelection"),o=d.treeView("getNodes",r);o[0].type===D?(e=r,n=(t=o[0]).children.length):(e=d.treeView("getSelection").first().parent().parent(),t=o[0]._parent,n=0);v.blueprintName=c,v.label=x(t,v.label),d.treeView("addNode",e,n,v)}()},hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![D].includes(e[0].type)}}),e.push({type:w,hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![E,g,m,f,A,y,b,h,T].includes(e[0].type)}},{id:"delete-table-action",label:L("ODG.PE.CONTEXT.DELETE_TABLE"),type:N,action:function(){var e,t;e=d.treeView("getSelection"),"none"===(t=d.treeView("getNodes",e))[0].nodeAction||"updateTable"===t[0].nodeAction?k(t[0].label,E):(t[0].nodeAction="none",t[0].children.forEach((function(e){e.nodeAction="none"})),d.treeView("deleteTreeNodes",e))},hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![E].includes(e[0].type)}},{id:"delete-column-action",label:L("ODG.PE.CONTEXT.DELETE_COLUMN"),type:N,action:function(){var e,t;e=d.treeView("getSelection"),"none"===(t=d.treeView("getNodes",e))[0].nodeAction||"updateColumn"===t[0].nodeAction?k(t[0].label,g,t[0].parentTable):(t[0].nodeAction="none",d.treeView("deleteTreeNodes",e))},hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![g,m,f,A,y,b,h].includes(e[0].type)}},{id:"delete-datasource-action",label:L("ODG.PE.CONTEXT.DELETE_DATA_SOURCE"),type:N,action:function(){var e,t;e=d.treeView("getSelection"),"none"===(t=d.treeView("getNodes",e))[0].nodeAction||"updateDataSource"===t[0].nodeAction?k(t[0].label,T):(t[0].nodeAction="none",d.treeView("deleteTreeNodes",e))},hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![T].includes(e[0].type)}}),e.push({type:w,hide:function(){var e=d.treeView("getSelectedNodes");return!!(e&&e.length>0)&&![E].includes(e[0].type)}}),{items:e}}function L(e){return o.getMessage(e)}function R(e){var t=[L(e)].concat(Array.prototype.slice.call(arguments,1));return o.format.apply(this,t)}function G(e){let t=10;return e.children.length>0&&(t=Math.max(0,...e.children.map((e=>e.seq)))+10),t}function x(e,t){let n,r=1,o=t;return e.children.forEach((function(e){e.label===o&&(n=o.lastIndexOf("_"),n>0&&(r=parseInt(o.substring(n+1),10)+1,o=o.replace(o.substring(n),"_"+r)))})),o.includes("_")?o:o+="_"+r}function B(){let e=[],t=[],n=[];a.root().children.forEach((function(r){r.type===D?r.children.forEach((function(t){t.label&&"addDataSource"!==t.nodeAction&&e.push({d:t.label,r:t.label,type:t.dsType,query:t.sqlQuery})})):r.type===P&&r.children.forEach((function(e){if(e.label&&"addTable"!==e.nodeAction){var r=[];t.push({d:e.label,r:e.label,seq:e.seq}),e.children.forEach((function(e){r.push({d:e.label,r:e.label})})),n.push({table:e.label,columns:r})}}))})),s.tdPropertyEditor("setCustomDataSources",e),s.tdPropertyEditor("setBlueprintTablesAndColumns",t,n)}function I(t){return(a=e.apex.treeView.makeDefaultNodeAdapter(t,{blueprint:{icon:"icon-dg-blueprint",operations:{canAdd:!0}},table:{icon:"icon-dg-table",operations:{canAdd:!0,canPreview:!0,canDrag:!0}},column:{icon:"icon-dg-built-in",operations:{canAdd:!0,canDrag:!0}},"column-builtin":{icon:"icon-dg-built-in",operations:{canAdd:!0,canDrag:!0}},"column-data_source":{icon:"icon-dg-data-source",operations:{canAdd:!0,canDrag:!0}},"column-blueprint":{icon:"icon-dg-blueprint",operations:{canAdd:!0,canDrag:!0}},"column-sequence":{icon:"icon-dg-seq",operations:{canAdd:!0,canDrag:!0}},"column-inline":{icon:"icon-dg-inline",operations:{canAdd:!0,canDrag:!0}},"column-formula":{icon:"icon-dg-formula",operations:{canAdd:!0,canDrag:!0}},datasource:{icon:"icon-dg-data-source",operations:{canAdd:!0,canDrag:!0}}})).sortCompare=function(e,t){return e.seq-t.seq},a.renderNodeContent=function(e,t,n,r){var o,i;a.getIcon&&null!==(i=a.getIcon(e))&&t.markup("<span").attr("class",n.iconType+" "+i).markup("></span>"),o="&nbsp;"+a.getLabel(e),t.markup("<span tabIndex='-1' role='treeitem'").attr("class",n.labelClass).attr("aria-level",r.level).attr("aria-selected",r.selected?"true":"false").optionalAttr("area-disabled",r.disabled?"true":null).optionalAttr("aria-expanded",!1===r.hasChildren?null:r.expanded?"true":"false").optionalAttr("aria-owns",r.owns).markup(">").markup(o).markup("</span>")},a}function M(e,t){if(e.nodeAction&&"none"!==e.nodeAction)if(e.nodeReady&&"N"===e.nodeReady)r.error("The blueprint object with name "+e.label+" is in inconsistent state and will not be saved.");else{let n,r=jQuery.extend({},e);delete r._parent,delete r.children,[g,m,f,A,y,b,h].includes(r.type)?n=4:r.type===E?n=3:r.type===T?n=2:"blueprint"===r.type&&(n=1),r.priority=n,t.push(r)}if(_(e,"children")&&e.children instanceof Array)for(const n of e.children)M(n,t);return t}function U(e,t){let n=jQuery.extend({},e);if(delete n._parent,delete n.children,[g,m,f,A,y,b,h].includes(n.type)&&t.push(n),_(e,"children")&&e.children instanceof Array)for(const n of e.children)U(n,t);return t}function q(t,a,i){let c,u,p=[],P=[];if(l=apex.widget.waitPopup(),apex.message.clearErrors(),apex.item("P4100_REQUIRED_SAVE").setValue(s.tdPropertyEditor("isBlueprintChanged")),s.tdPropertyEditor("hasBlueprintErrors"))return apex.message.showErrors([{type:"error",location:["page"],message:R("ODG.PE.CORRECT_BEFORE_SAVE",s.tdPropertyEditor("getBlueprintErrorList")),unsafe:!1}]),void l.remove();async function D(e){try{return await n.process("SaveBlueprintObject",{f01:n.chunk(JSON.stringify(e))})}catch(e){r(e)}}c=s.tdPropertyEditor("getTreeNode"),u=s.tdPropertyEditor("getCurrentNode"),M(i,p),p.sort((function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:0})),(async()=>{apex.message.clearErrors();for(const e of p){const t=await D(e);if(t&&!t.success){let n;[g,m,f,A,y,b,h].includes(e.type)?n=o.getMessage("ODG.PE.COLUMN"):e.type===E?n=o.getMessage("ODG.PE.TABLE"):e.type===T?n=o.getMessage("ODG.PE.DATA_SOURCE"):"blueprint"===e.type&&(n=o.getMessage("ODG.PE.BLUEPRINT")),P.push({type:"error",location:["page"],message:R("ODG.BLUEPRINT_ERRORS",n,e.label,t.message),unsafe:!1})}}P.length>0?(apex.message.showErrors(P),l.remove()):(s.tdPropertyEditor("setBlueprintChanges",!1),e(window).off("beforeunload"),a?(l.remove(),Q(t)):n.process("GetBPTablesAndColumns",{},{success:function(e){if(d.treeView("option","getNodeAdapter",(function(){return I(e)})),d.treeView("refresh"),d.treeView("expandAll"),B(),s.tdPropertyEditor("refreshUI"),apex.message.showPageSuccess(o.getMessage("ODG.BLUEPRINT_SAVED")),["addColumn","addTable","addDataSource"].includes(c.nodeAction)){let e=d.treeView("find",{depth:-1,match:function(e){return e.label===c.label}});d.treeView("setSelection",e)}else d.treeView("setSelectedNodes",[c]),s.tdPropertyEditor("setSelectedNode",c,u);l.remove()}}))})()}function k(e,t,o){let i,l=!1,c="",d=[];U(a.root(),d);for(let n of d)if("DATA_SOURCE"===n.source&&e===n.dsName)l=!0,[g,m,f,A,y,b,h].includes(t)?i=L("ODG.PE.COLUMN"):t===E?i=L("ODG.PE.TABLE"):t===T&&(i=L("ODG.PE.DATA_SOURCE")),c+=n.parentTable+"."+n.label+" ";else if("BLUEPRINT"===n.source){let r=n.ds.split(".");e!==r[0]&&e!==r[1]||(l=!0,[g,m,f,A,y,b,h].includes(t)?i=L("ODG.PE.COLUMN"):t===E?i=L("ODG.PE.TABLE"):t===T&&(i=L("ODG.PE.DATA_SOURCE")),c+=n.parentTable+"."+n.label+" ")}l?apex.message.showDialog(R("ODG.PE.UNABLE_TO_DELETE.BODY",e,i.toLowerCase(),c,i.toLowerCase()),{title:R("ODG.PE.UNABLE_TO_DELETE.TITLE",i.toLowerCase()),dialogClass:"ui-dialog--notification",unsafe:!1,modern:!0,style:"warning",iconClass:"a-Icon icon-warning"}):([g,m,f,A,y,b,h].includes(t)?i=L("ODG.PE.COLUMN"):t===E?i=L("ODG.PE.TABLE"):t===T&&(i=L("ODG.PE.DATA_SOURCE")),apex.message.confirm(R("ODG.PE.CONFIRM_DELETE",i,e),(function(i){i&&n.process("DeleteFromBlueprint",{x01:e,x02:t,x03:o},{success:function(e){!0===e.success?s.tdPropertyEditor("isBlueprintChanged")?q(4e3,!1,a.root()):(B(),location.reload()):(apex.message.clearErrors(),apex.message.showErrors([{type:"error",location:["page","inline"],message:L("ODG.PE.ERROR_DELETE"),unsafe:!1}]))},error:function(e){r(e)}})})))}function Q(e,t){var o,a=apex.item("P4100_BLUEPRINT_ID").getValue();o=(o=(o=(o=(o=(o=t?"f?p=#APP_ID#:#TARGET_PAGE#:#SESSION#::NO:Y,#TARGET_PAGE#:P#TARGET_PAGE#_BP_NAME,P#TARGET_PAGE#_TABLE_NAME:#P4100_BLUEPRINT_NAME#,#TABLE_NAME#":"f?p=#APP_ID#:#TARGET_PAGE#:#SESSION#::NO:Y,#TARGET_PAGE#:P#TARGET_PAGE#_BLUEPRINT_ID:#P4100_BLUEPRINT_ID#").replace("#APP_ID#",apex.env.APP_ID)).replace("#SESSION#",apex.env.APP_SESSION)).replace(/#TARGET_PAGE#/g,e)).replace("#P4100_BLUEPRINT_ID#",a)).replace("#TABLE_NAME#",t),n.process("PrepareURL",{x01:o},{success:function(e){!0===e.success&&apex.navigation.redirect(e.url)},error:function(e){r(e)}})}(async()=>{await o.loadMessages(["ODG.%"]),i=V(),await n.process("GetBPTablesAndColumns",{},{success:function(t){let n=[],r=[],o=[];d.treeView({getNodeAdapter:function(){return I(t)},iconType:"a-Icon",collapsibleRoot:!1,expandRoot:!0,contextMenu:i,contextMenuId:"TDrenderingTreeMenu",multiple:!1,distance:5}),s.tdPropertyEditor({mode:p,schemas:apex.item("P4100_AVAILABLE_SCHEMA").getValue()}),s.tdPropertyEditor("addCustomProperties"),d.treeView("expandAll"),d.treeView("setSelection",e("[aria-level='1']",d).first().parent()),s.tdPropertyEditor("setTreeElement",d),c=t.label,t.children.forEach((function(e){e.type===D?e.children.forEach((function(e){e.label&&o.push({d:e.label,r:e.label,type:e.dsType,query:e.sqlQuery})})):e.type===P&&e.children.forEach((function(e){if(e.label){var t=[];n.push({d:e.label,r:e.label,seq:e.seq}),e.children.forEach((function(e){t.push({d:e.label,r:e.label})})),r.push({table:e.label,columns:t})}}))})),s.tdPropertyEditor("setCurrentSchema",t.schema),s.tdPropertyEditor("setCustomDataSources",o),s.tdPropertyEditor("setBlueprintTablesAndColumns",n,r)},error:function(e){r(e),u.remove()}}),u.remove()})(),d.on("treeviewselectionchange",(function(){var t,n=e(this).treeView("getSelection"),r=d.treeView("getNodes",n);B(),r.length>0&&(t=r[0],s.tdPropertyEditor("setSelectedNode",t,d.treeView("getSelection").first()),[g,m,f,A,y,b,h].includes(t.type)?s.tdPropertyEditor("setMode","column-mode",t):t.type===E?s.tdPropertyEditor("setMode","table-mode",t):t.type===T?s.tdPropertyEditor("setMode","data-source-mode",t):"blueprint"===t.type?s.tdPropertyEditor("setMode",p,t):s.tdPropertyEditor("setMode","no-mode",t))})),e(i).on("menubeforeopen",(function(){0===d.treeView("getSelection").length&&d.treeView("setSelection",e("[aria-level='1']",d).first().parent())})),e("#SaveBlueprintChanges").on(O,(function(){q(4e3,!1,a.root())})),e("#SaveAndPreviewBlueprintChanges").on(O,(function(){q(4012,!0,a.root())})),e("#SaveAndGenerateBlueprintChanges").on(O,(function(){q(4005,!0,a.root())})),e("#P4100_BP_SELECTOR").on("change",(function(){apex.item("P4100_BLUEPRINT_ID").setValue(this.value),Q("4100")}))}(apex.jQuery,apex.util,apex.server,apex.debug,apex.lang);