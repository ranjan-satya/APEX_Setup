/*!
 * Copyright (c) 2021, 2024. Oracle and/or its affiliates.
 */
window.fileEditor=(()=>{"use strict";const{jQuery:e,item:i,lang:n,message:t,page:o,server:a,util:s,clipboard:l}=apex,r="javascript",c="less",u="css",g=".css",f=".min.js",d=".min.css",m=/\.js$/,E=/\.less$/,_=/\.css$/;let h,I,P,p,A,C,D,N,S,T,y;function O(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,((e,i)=>String.fromCharCode("0x"+i))))}function R(e,...i){return n.formatMessage("FILE_EDITOR."+e,...i)}function V(e){if(e??="","string"!=typeof e)throw new Error("minifyCSS requires a String as parameter");return e=(e=(e=(e=(e=e.replace(/\/\*[^*!]*\*+([^/*][^*]*\*+)*\//g,"")).replace(/([^\\]\n)[ \t]+/g,"$1")).replace(/[ \t]+$/gm,"")).replace(/([;{}])[\r\n]+/g,"$1")).trim()}function L(){s.delayLinger.start("page-spinner",(function(){y=s.showSpinner(e("body"),{fixed:!0})}))}function M(){s.delayLinger.finish("page-spinner",(function(){y&&(y.remove(),y=null)}))}function w(e,i){a.process("IS_NAME_TAKEN",{pageItems:["P118_ID","P118_SCOPE","P118_APP_ID","P118_PLUGIN_ID","P118_THEME_ID","P118_DIRECTORY"],f01:"string"==typeof e?[e]:e}).then((e=>{M(),e.isNameTaken?t.showDialog(R("NAME_TAKEN"),{confirm:!0,callback:function(e){e&&(L(),i())},okLabel:R("OVERRIDE"),modern:!0,style:"danger"}):i()}))}function v(){let i=N.getValue(),n=e("#editor_widget"),s=P.getValue().trim(),l=I.getValue().trim(),h=l.length?l+"/":"",A=h+s,C=n.codeEditor("getValue"),D=(S="apex-no-artifacts",!C.split("\n").some((e=>{const i=e.match(/ *\/\* *(.*?) *\*\/ */);return i&&i[1]===S})));var S;function y(e){function i(){a.process("SAVE",{pageItems:["P118_ID","P118_SCOPE","P118_APP_ID","P118_PLUGIN_ID","P118_THEME_ID","P118_NAME_ORIGINAL","P118_LAST_MOD"],x01:e.file1name,f01:a.chunk(O(e.file1||"")),x02:e.file2name,f02:a.chunk(O(e.file2||"")),x03:e.file3name,f03:a.chunk(O(e.file3||""))}).then((i=>{i.success?A!==p.getValue()?o.submit("UPDATE_DUMMY"):(T.setValue(i.newLastMod),t.showPageSuccess(R(e.msgKey))):i.message&&t.alert(i.message)})).always(M)}A!==p.getValue()?w(s,i):i()}t.hidePageSuccess(),L(),i===c&&D?function(e,i){less.render(e).then((e=>{i({success:!0,file:e.css})})).catch((e=>{const n=[];n.push(R("ERROR_COMPILATION")),e.message&&n.push(e.message),void 0!==e.line&&void 0!==e.column&&n.push(R("LINE_COL",e.line,e.column+1)),i({ok:!1,message:n.join("\n"),line:e.line,col:e.column+1})}))}(C,(function(e){e.success?y({file1:C,file1name:A,file2:e.file,file2name:h+s.replace(E,g),file3:V(e.file),file3name:h+s.replace(E,d),msgKey:"SAVED_MINIFIED_COMPILED"}):(M(),e.line&&e.col&&n.codeEditor("gotoPosition",e.line,e.col,!1),t.alert(e.message))})):i===u&&!s.endsWith(d)&&D?y({file1:C,file1name:A,file2:V(C),file2name:h+s.replace(_,d),msgKey:"SAVED_MINIFIED"}):i===r&&!s.endsWith(f)&&D?function(e,i){Terser.minify(e).then((e=>{i({success:!0,file:e.code})})).catch((e=>{i({success:!1,message:[R("ERROR_MINIFICATION"),e.name+" - "+e.message,R("LINE_COL",e.line,e.col)].join("\n"),line:e.line,col:e.col})}))}(C,(function(e){e.success?y({file1:C,file1name:A,file2:e.file,file2name:h+s.replace(m,f),msgKey:"SAVED_MINIFIED"}):(M(),e.line&&e.col&&n.codeEditor("gotoPosition",e.line,e.col,!1),t.alert(e.message))})):y({file1:C,file1name:A,msgKey:"SAVED"})}return{minifyCSS:V,configureEditor:function(i){i.onInitialized=function(i){i.addAction({id:"save",label:"Save",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyS],run:function(){e("body").trigger("SAVE")}})},i.heightFn=function(){const i=e(window).height()-(e(".a-Header").outerHeight()||0)-(e(".a-Alert").outerHeight()||0)-(e(".a-ControlBar").outerHeight()||0)-(e(".a-ButtonRegion").outerHeight()||0)-(e(".a-Footer").outerHeight()||0)-(e("#editor").outerHeight()-e("#editor_widget").outerHeight());return Math.max(i,e("#details").outerHeight())};try{i.value=(n=i.value||"",decodeURIComponent(atob(n).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join("")))}catch(e){t.alert(R("COULD_NOT_OPEN_FILE")),i.value=""}var n;return i},initPage:function(){h=i("P118_ID"),I=i("P118_DIRECTORY"),P=i("P118_NAME"),p=i("P118_NAME_ORIGINAL"),A=i("P118_CHARSET"),C=i("P118_CONTENT"),D=i("P118_UNZIP"),N=i("P118_LANGUAGE"),S=i("P118_IS_EDITABLE"),T=i("P118_LAST_MOD"),D.hide(),"Y"===S.getValue()&&e(".a-Form-fieldContainer").addClass("a-Form-fieldContainer--stacked"),h.getValue()?A.show():A.hide(),h.getValue()&&e(".a-Side").remove(),l.addElement("#P118_REFERENCE_DISPLAY",e("#copy_ref_btn")),e("#P118_CONTENT").on("change",(function(){var e=C.getValue();0===e.length?(P.setValue(""),P.show(),D.hide(),A.hide()):1===e.length?(P.setValue(e[0]),P.hide(),e[0].endsWith(".zip")?D.show():D.hide(),A.show()):(P.hide(),P.setValue(""),D.hide(),A.show())})),e("body").on("SAVE",(function(){"Y"===S.getValue()?v():o.submit("UPDATE")})),e("#CREATE,#CREATE_ANOTHER").on("click",(function(){const i=e(this).attr("id");L(),w(P.value?P.value:C.value,(()=>{o.submit({request:i})}))}))}}})();