/*!
 * Copyright (c) 2023, 2024, Oracle and/or its affiliates.
 */
!function(e,t,n,i,r,o,a){"use strict";t(document).on("modelReady",(function(){const l="diagram",O="selectionChanged",E="diagramMenuSelect",u="NATIVE_WORKFLOW_START",s="NATIVE_WORKFLOW_END",P="NATIVE_WORKFLOW_SWITCH",T="NATIVE_INVOKE_WF",d=[e.COMP_TYPE.WORKFLOW_TRANS,e.COMP_TYPE.WORKFLOW_BRANCH],c=[u,s,"NATIVE_WORKFLOW_WAIT"],R=[e.COMP_TYPE.WORKFLOW_VERSION,e.COMP_TYPE.WORKFLOW_ACTIVITY,...d],g="apexId",_="diagram-zoom-in",I="diagram-zoom-out",p="diagram-show-navigator",N="diagram-link-normal",A="diagram-link-orthogonal",f="diagram-cell-to-front",L="diagram-cell-to-back",m="diagram-prev-workflow",y=[N,A],C=[L,f],W="top",M="bottom",D="left",h={glyph:"",color:"var(--a-palette-danger)"},v={renderStencil:!1,drawGrid:!0,style:{toastForegroundContainerCls:"a-WorkflowToast"},locale:{[DiagramBuilder.Locale.STR_ZOOM_LEVEL]:pe("ZOOM_LEVEL")},keyboardNavigation:!0,keyboardNavigationMap:r.getDiagramKeyboardShortcuts().reduce(((e,t)=>{if(Object.hasOwn(e,t.key)){let n=e[t.key];n=Array.isArray(n)?[...n,t.event]:[n,t.event],e[t.key]=n}else e[t.key]=t.event;return e}),{}),onElementRemoveKeepInboundLinks:!0,onElementRemoveKeepOutboundLinks:!0,dropConnectOnLinks:!0,requireLinkSourceElement:!0,linkDesignations:[{typeId:"ERROR",glyph:""},{typeId:"TIMEOUT",glyph:""}],allowConnection:(t,n,i)=>{let r,o,a;return!!Re||(o=me(he(i.model)),a=o.typeId===e.COMP_TYPE.WORKFLOW_TRANS,r=me(he(t)),!(a&&r.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue()===P))},allowDropConnectOnLink:(e,t,n)=>{if(n){let n=t.model.getBBox();return te.attachElementToLink(t.model,e.model,{point:{x:n.x+n.width/2,y:n.y+n.height/2}}),ue.execute(),ge=!1,ue=void 0,!1}return!0},allowDropConnectOnPlaceholder:(e,t,n,i)=>{if(i){let n=e.model;Qe((function(){Ke(n,t.model.id,!1)}))}return!0},allowDropConnectOnElement:(e,t,n)=>{if(n){let n=e.model,i=t.model;return ge=!0,Ve(n,i),ue.execute(),ge=!1,ue=void 0,!1}return!0}},B="allowSourceChange",V="allowTargetChange",K="allowLinkOut",Y="allowLinkIn",S="allowRemove",F="hasMenu",G="redo",b="undo",U="INACTIVE",k="DEVELOPMENT",x="NORMAL",w={verticalAlign:"center",horizontalAlign:"center"},H="orthogonal",z="normal",j=z,J="old",q="new",Z="pos",X={distance:.5,offset:0},$={source:{args:{dx:"50%",dy:"50%",rotate:!0},name:"topLeft"},target:{args:{dx:"50%",dy:"50%",rotate:!0},name:"topLeft"},vertices:[],z:1,label:X,router:void 0},Q=[{type:"separator"},{type:"subMenu",labelKey:pe("DEF_ROUTER_SETTING"),hide:function(){return!re||!!re&&!!oe},menu:{items:[{type:"radioGroup",set:function(t){let n=rt();if(n){Ne(It({[re]:{component:n,defaultRouter:{[J]:n.getProperty(e.PROP.DIAGRAM).getValue(),[q]:t}}})),te.setDefaultRouter(t)}},get:function(){let t=rt();if(t)return t.getProperty(e.PROP.DIAGRAM).getValue()||j},choices:[{labelKey:pe("NORMAL"),value:DiagramBuilder.Router.NORMAL},{labelKey:pe("ORTHOGONAL"),value:DiagramBuilder.Router.ORTHOGONAL}]}]}},{type:"separator"},{label:i.getMessage("PD.DEL"),type:"action",action:function(){let e=je();e&&He(e)},hide:function(){let e=je();return!e||!r.isInactive(e,k)||![DiagramBuilder.Event.ELEMENT_MENUBUTTON_POINTERDOWN,DiagramBuilder.Event.ELEMENT_MENUBUTTON_KEYBOARDTRIGGER,DiagramBuilder.Event.LINK_MENUBUTTON_POINTERDOWN,DiagramBuilder.Event.LINK_MENUBUTTON_KEYBOARDTRIGGER].includes(oe)}}],ee=o.hasOwnProperty;let te,ne,ie,re,oe,ae,le,Oe,Ee,ue,se=!1,Pe=!1,Te=!1,de=!1,ce=!1,Re=!1,ge=!1,_e=!1,Ie=[];function pe(e){return i.getMessage("WF."+e)}function Ne(e){!ge||_e?(_e&&(_e=!1,ge=!0),apex.commandHistory.execute(e)):e.execute()}function Ae(t){let n=t.getProperty(e.PROP.STATE).getValue()===k,i=t.getChilds(e.COMP_TYPE.WORKFLOW_ACTIVITY).map((t=>function(t,n){const i=t.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue();return{id:t.id,[g]:t.id,[K]:n&&i!==s,[Y]:n&&i!==u,[F]:n||i===T,[S]:n,typeId:i,text:Pt(t),statusIcon:t.hasErrors()?h:"",...Je(t.getProperty(e.PROP.DIAGRAM).getValue())}}(t,n)));return[...i,...[...t.getChildrenUntil(e.COMP_TYPE.WORKFLOW_TRANS),...t.getChildrenUntil(e.COMP_TYPE.WORKFLOW_BRANCH)].map((e=>fe(e,n)))]}function fe(t,n){let i,r,o,a={},l=[],O=t.typeId===e.COMP_TYPE.WORKFLOW_BRANCH,E=O?null:t.getProperty(e.PROP.TRANSITION_TYPE).getValue(),u=O?t.parentId:t.getProperty(e.PROP.FROM_WORKFLOW_ACTIVITY).getValue(),s=t.getProperty(e.PROP.TO_WORKFLOW_ACTIVITY).getValue(),P=Le(t.getProperty(e.PROP.DIAGRAM).getValue());return P.source.args&&(o={args:P.source.args,name:P.source.name}),s?a.id=s:P.target.pos&&(a=P.target.pos),P.target.args&&(r={args:P.target.args,name:P.target.name}),E!==x&&l.push({text:t.getProperty(e.PROP.NAME).getValue(),position:P.label}),P.router&&(i=P.router),{id:t.id,[g]:t.id,[B]:!O&&!!n,[V]:n,[F]:n,[S]:n,source:{id:u,anchor:o},target:{...a,anchor:r},vertices:P.vertices,z:P.z,labels:l,designation:E,router:i}}function Le(e){return Je(e,$)}function me(t){if(t)return e.getComponentsAdvanced([{typeId:e.COMP_TYPE.WORKFLOW_ACTIVITY,filter:{id:t}},{typeId:e.COMP_TYPE.WORKFLOW_TRANS,filter:{id:t}},{typeId:e.COMP_TYPE.WORKFLOW_BRANCH,filter:{id:t}}])[0]}function ye(e){let t=We(e);return t||=Ce(e),t}function Ce(e){let t=te.getLinkById(e);return t||=te.getLinkBy(g,e),t}function We(e){let t=te.getElementById(e);return t||=te.getElementBy(g,e),t}function Me(e,t={}){let n="string"==typeof e?[ye(e)]:Array.isArray(e)?e.map(ye):[e];n=n.filter((e=>e)),n.length?(te.requireView(),te.select(n,t)):(Pe=!1,te.deselect())}function De(e,t){return("string"==typeof e?ye(e):e).prop(g,t)}function he(e){return"string"==typeof e&&(e=ye(e)),e.prop(g)}function ve(e,t=M,n){let i,r;const o=n?50:100,{width:a,height:l}=e.size(),{x:O,y:E}=e.position();return[W,M].includes(t)?(i=O+a/2,r=t===M?E+2*l+o:E-l-o):(r=E+l/2,i=t===D?O-o-a/2:O+o+1.5*a),{x:i,y:r}}function Be(e,t,n){let i=te.addElement(e,t);return n&&(te.requireView(),De(i,n)),te.select(i),i}function Ve(t,n,i){let r=me(he(t));if(!r)return;let o="string"==typeof n?We(n):n,a=te.addLink(t,o||ve(t),{[B]:be(r)!==e.COMP_TYPE.WORKFLOW_BRANCH});return i&&(te.requireView(),De(a,i)),a}function Ke(e,t={},n){de=n;let i="string"==typeof t?We(t):t.id;i?te.setLinkTarget(e,i):te.setLinkTarget(e,t)}function Ye(e,t={},n){de=n;let i="string"==typeof t?We(t):t.id;te.setLinkSource(e,i||"")}function Se(e){return e.attributes.target}function Fe(e){return e.attributes.source}function Ge(e){let t="string"==typeof e?ye(e):e;t.attributes.typeId?te.removeElement(t,{force:!0}):te.removeLink(t,{force:!0})}function be(t){return t.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue()===P?e.COMP_TYPE.WORKFLOW_BRANCH:e.COMP_TYPE.WORKFLOW_TRANS}function Ue(t){let n=ye(t.id);n&&(t.typeId===e.COMP_TYPE.WORKFLOW_ACTIVITY?t.hasErrors()?(n.statusIcon(h.glyph),n.statusIconColor(h.color)):n.statusIcon(null):d.includes(t.typeId)&&n.error(t.hasErrors()))}function ke(e=!0){te.clear(!0,e),Mt(),te.setReadOnly(!0),re=void 0}function xe(){let e=je();if(e){we(be(e),e)}}function we(t,n){let i=[];t===e.COMP_TYPE.WORKFLOW_TRANS?i.push({id:e.PROP.FROM_WORKFLOW_ACTIVITY,value:n.id}):t===e.COMP_TYPE.WORKFLOW_BRANCH&&i.push({id:e.PROP.SWITCH_TYPE,value:ze(n)});let r=e.transaction.message({action:e.MESSAGE_ACTION.CREATE,component:t}),o=e.transaction.start("",r),a=new e.Component({previousComponent:n,parentId:n.id,typeId:t,values:i});Ne(o),R.includes(a.typeId)?Me(a.id):Wt([a])}function He(t){let n=e.transaction.message({action:e.MESSAGE_ACTION.DELETE,component:t,count:1}),i=e.transaction.start("",n);t.remove(),Ne(i)}function ze(t){return t.getProperty(e.getPluginProperty(e.COMP_TYPE.PAGE_PROCESS,P,1).id).getValue()}function je(){let e=te.getSelection();if(1!==e.length)return void n.info("No or multiple cells are selected");let t=me(he(e[0]));if(t)return t;n.info("Component cannot be found")}function Je(e,t={}){try{return JSON.parse(e)}catch{return n.info("The provided data is invalid, fallback to default."),t}}function qe(t){return t.typeId===e.COMP_TYPE.WORKFLOW_BRANCH||t.typeId===e.COMP_TYPE.WORKFLOW_TRANS&&t.getProperty(e.PROP.TRANSITION_TYPE).getValue()!==x||t.typeId===e.COMP_TYPE.WORKFLOW_ACTIVITY&&!c.includes(t.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue())}function Ze(){let t=this.id,n=te.getSelection();if(1!==n.length)return;let i=n[0];ue=e.transaction.start(l);let r=Ve(i,ve(i,ae));Qe((function(){let e=Be(t,{...Se(r),...w});ae=void 0,Ke(r,e.id)}))}function Xe(){let t=te.getSelection();if(1!==t.length)return;let n=t[0],i=Se(n),r=this.id;ue=e.transaction.start(l);let o=Be(r,{...i,...w});Qe((function(){Ke(n,o.id,!1)}))}function $e(){let t=te.getSelection();if(1!==t.length)return;let n=t[0],i=this.id;ue=e.transaction.start(l),_e=!0,Be(i,{addToLink:{link:n},...te.clientToLocalPoint(event),...w}),ge=!1,ue.execute(),ue=void 0}function Qe(e){ge=!0,e(),ue&&(ue.execute(),ue=void 0),ge=!1}function et(e,t,n,i){te.select(e),oe=t,ae=i,ie.menu("toggle",n.x,n.y,{context:t}),oe=void 0}function tt(e){return{x:e.pageX,y:e.pageY}}function nt(t){const{x:n,y:i}=te.getVisibleAreaCenter();let r=t.filter((t=>t.typeId===e.COMP_TYPE.WORKFLOW_ACTIVITY));3===r.length&&(r[0].getProperty(e.PROP.DIAGRAM).setValue(JSON.stringify({position:{x:n-240-60,y:i-30}})),r[1].getProperty(e.PROP.DIAGRAM).setValue(JSON.stringify({position:{x:n-110,y:i-30}})),r[2].getProperty(e.PROP.DIAGRAM).setValue(JSON.stringify({position:{x:n+240,y:i-30}})))}function it(t){return"string"==typeof t?e.getComponents(e.COMP_TYPE.WORKFLOW_VERSION,{id:t})[0]:function(e,t){let n=e;for(;n&&n.typeId!==t;)n=n.getParent();return n}(t,e.COMP_TYPE.WORKFLOW_VERSION)}function rt(){if(re){let t=e.getComponents(e.COMP_TYPE.WORKFLOW_VERSION,{id:re});if(t.length)return t[0]}}function ot(t){te.load({cells:Ae(t)}),re=t.id,te.setDefaultRouter(t.getProperty(e.PROP.DIAGRAM).getValue()||j),te.setReadOnly(t.getProperty(e.PROP.STATE).getValue()===U)}function at(e){Te||te.isReadOnly()||de?de=!1:e()}function lt(e){return JSON.stringify({position:e.position(),z:e.attributes.z})}function Ot(e){return JSON.stringify(ut(e))}function Et(e){return e.x&&e.y?{[Z]:{x:e.x,y:e.y}}:{}}function ut(e){let t=Et(Se(e));t={...t,...Se(e).anchor};let n=Et(Fe(e));n={...n,...Fe(e).anchor};let i=e.attributes.vertices||[],r=e.attributes.router,o=e.attributes.labels?.length>1?e.attributes.labels[1].position:X;return{source:n,target:t,vertices:i,router:r,z:e.attributes.z,label:o}}function st(t){let n={};if((Array.isArray(t)?t:[t]).forEach((t=>{let i=me(he(t));if(!i||i.isReadOnly())return;let r=i.getProperty(e.PROP.DIAGRAM).getValue(),o=lt(t);r!==o&&(n[i.id]={component:i,position:{[J]:r,[q]:o}})})),Object.keys(n).length){Ne(It(n))}}function Pt(t){return t.getProperty(e.PROP.ITEM_LABEL)?.getValue()||t.getProperty(e.PROP.NAME)?.getValue()}function Tt(t){let n={};(Array.isArray(t)?t:[t]).forEach((t=>{let i,r,o="",a="",l=me(he(t));if(!l||l.isReadOnly())return;let{id:O}=Se(t);O&&(o=he(O));let{id:E}=Fe(t);E&&(a=he(E));let u=l.typeId===e.COMP_TYPE.WORKFLOW_TRANS;i=l.getProperty(e.PROP.TO_WORKFLOW_ACTIVITY).getValue(),r=u?l.getProperty(e.PROP.FROM_WORKFLOW_ACTIVITY).getValue():l.parentId;let s=l.getProperty(e.PROP.DIAGRAM).getValue(),P=Ot(t);(function(e,t){const n=dt(JSON.parse(e)),i=dt(JSON.parse(t));return DiagramBuilder.Util.isEqual(n,i)})(P,s)&&i===o&&(!u||u&&r===a)||(n[l.id]={component:l,data:{[J]:s,[q]:P},target:{[J]:i,[q]:o},source:{[J]:r,[q]:a}})})),Object.keys(n).length&&Ne(It(n))}function dt(e){return Object.fromEntries(Object.entries(e).filter((([,e])=>null!=e)))}function ct(e){Te=!0,e.call(),Te=!1}function Rt(e,t){return e.args&&e.name?{name:e.name,args:e.args}:$[t]}function gt(n){let i=n===b?J:q;for(let n in this.changes){if(!ee(this.changes,n))continue;let r=this.changes[n],o=r.component;if(o.typeId===e.COMP_TYPE.WORKFLOW_ACTIVITY){let e=We(o.id),t=Je(r.position[i]),{z:n,position:a}=t;te.setCellZIndex(e,n??0),a&&e.position(a.x,a.y)}else if(o.typeId===e.COMP_TYPE.WORKFLOW_VERSION)o.id===re&&te.setDefaultRouter(r.defaultRouter[i]||j);else{let n,a=Ce(o.id),l=Je(r.data[i],$);l.vertices&&te.setLinkVertices(a,l.vertices),l.label&&qe(o)&&te.setLinkLabel(a,o.getProperty(e.PROP.NAME).getValue(),{position:l.label,rewrite:!0});const O=te.getLinkRouter(a)?.name,E=l.router?.name;if(O!==E){te.setLinkRouter(a,E);const e=te.getSelection();if(1===e.length){me(he(e[0]))===o&&d.includes(o.typeId)&&y.forEach((e=>{t(`[data-action=${e}]`)[e.includes(E)?"addClass":"removeClass"]("is-active")}))}}te.setCellZIndex(a,l.z??0),ee(l.source,Z)?te.setLinkSource(a,l.source.pos):(Ye(a,r.source[i]),n=Rt(l.source,"source"),te.setLinkSourceAnchor(a,n)),ee(l.target,Z)?te.setLinkTarget(a,l.target.pos):(Ke(a,r.target[i]),n=Rt(l.target,"target"),te.setLinkTargetAnchor(a,n))}}}const _t=t.extend(apex.commandHistory.baseCommand(),{execute:function(){this.transaction=ue||e.transaction.start(l),this.updateDataLayer()},updateDataLayer:function(){let t=this.changes;for(let n in t){if(!ee(t,n))continue;let i=t[n],r=i.component;if(r.typeId===e.COMP_TYPE.WORKFLOW_VERSION)r.getProperty(e.PROP.DIAGRAM).setValue(i.defaultRouter.new);else{r.getProperty(e.PROP.DIAGRAM).setValue(r.typeId===e.COMP_TYPE.WORKFLOW_ACTIVITY?i.position.new:i.data.new);let t=r.getProperty(e.PROP.TO_WORKFLOW_ACTIVITY);t&&i.target.new!==i.target.old&&(ce=!0,t.setValue(i.target.new));let n=r.getProperty(e.PROP.FROM_WORKFLOW_ACTIVITY);n&&i.source.new!==i.source.old&&(ce=!0,n.setValue(i.source.new))}}ue||this.transaction.execute()},undo:function(){ct((()=>{this.version===re&&gt.call(this,b),this.transaction.undo()}))},redo:function(){ct((()=>{this.version===re&&gt.call(this,G),this.transaction.redo()}))},label:function(){return this._label}});function It(t){let n,r=Object.create(_t);if(r.version=re,r.changes=t,1===Object.keys(t).length){let i=t[Object.keys(t)[0]].component;i&&(n=i.typeId===e.COMP_TYPE.WORKFLOW_VERSION?i.getProperty(e.PROP.WORKFLOW_VERSION).getValue():i.getProperty(e.PROP.NAME).getValue())}return r._label=`${i.getMessage("PD.WF.UPDATE")} ${n||i.getMessage("MODEL.MULTIPLE_COMPONENTS")}`,r}const pt=t.extend(apex.commandHistory.baseCommand(),{execute:function(){this.transaction=ue||e.transaction.start(l),this.updateDataLayer()},updateDataLayer:function(){let t,n,i;if(ce=!0,d.includes(this.change.typeId)){let r=Ce(this.change.elementId),o=he(Fe(r).id),a=Se(r);a&&a.id&&(i=We(a.id));let l=[{id:e.PROP.DIAGRAM,value:JSON.stringify(this.change.diagramData)}];i&&l.push({id:e.PROP.TO_WORKFLOW_ACTIVITY,value:he(i)}),this.change.typeId===e.COMP_TYPE.WORKFLOW_TRANS?t=new e.Component({previousComponent:"last",typeId:e.COMP_TYPE.WORKFLOW_TRANS,parentId:o,values:[...l,{id:e.PROP.FROM_WORKFLOW_ACTIVITY,value:o}]}):(n=me(o),t=new e.Component({previousComponent:"last",typeId:e.COMP_TYPE.WORKFLOW_BRANCH,parentId:o,values:[...l,{id:e.PROP.SWITCH_TYPE,value:ze(n)}]})),De(r.id,t.id)}else t=new e.Component({previousComponent:"last",typeId:e.COMP_TYPE.WORKFLOW_ACTIVITY,parentId:re,values:[{id:e.PROP.PAGE_PROCESS_TYPE,value:this.change.typeId},{id:e.PROP.DIAGRAM,value:JSON.stringify(this.change.diagramData)}]}),De(this.change.elementId,t.id);ue||this.transaction.execute(),Me(t.id),Wt([t])},undo:function(){Mt(),this.moveInHistory(b)},redo:function(){Mt(),this.moveInHistory(G)},moveInHistory:function(t){let n=this.transaction.components;ct((()=>{if(this.transaction[t].call(this.transaction),this.version===re)for(let i in n){if(!ee(n,i)||ee(n,i)&&!R.includes(i))continue;let r=n[i];for(let n in r)if(ee(r,n))if(t===b)if(r[n].oldComponent){let t=r[n].oldComponent,i=t.getProperty(e.PROP.TO_WORKFLOW_ACTIVITY).getValue();i||=Le(t.getProperty(e.PROP.DIAGRAM).getValue())?.target?.pos,Ke(Ce(n),i,null)}else Ge(n);else{let t=r[n].newComponent;if(r[n].oldComponent){let i=t.getProperty(e.PROP.TO_WORKFLOW_ACTIVITY).getValue();i||=Le(t.getProperty(e.PROP.DIAGRAM).getValue())?.target?.pos,Ke(Ce(n),i,null)}else Ct(t)}}}))},label:function(){return this._label}});function Nt(e,t,n,r){let o=Object.create(pt);return o.version=re,o.typeId=e,o.diagramData=t,o.change={typeId:e,diagramData:t,elementId:n,sourceId:r},o.element=n,o._label=i.getMessage("PD.WF.CREATE"),o}function At(e){let t=Object.create(ft);return t.version=re,t.component=me(e),t.typeId=t.component.typeId,t.id=e,t.change={typeId:t.typeId,id:e},t._label=i.getMessage("PD.WF.REMOVE"),t}const ft=t.extend(apex.commandHistory.baseCommand(),{execute:function(){this.transaction=ue||e.transaction.start(l),this.updateDataLayer()},updateDataLayer:function(){ce=!0,this.component.remove(),ue||this.transaction.execute()},undo:function(){Mt(),this.transaction.undo()},redo:function(){Mt(),this.transaction.redo()},moveInHistory:function(e){let t=this.transaction.components;ct((()=>{if(this.version===re)for(let n in t){if(!ee(t,n))continue;let i=t[n];for(let t in i){if(!ee(i,t))continue;if("delete"===i[t].operation)if(e===G)Ge(t);else{Ct(i[t].oldComponent)}}}this.transaction[e].call(this.transaction)}))},label:function(){return this._label}});function Lt(e){let t=me(he(Fe(e).id));if(!t)return;let n=ut(e);Ne(Nt(be(t),n,e.id,t.id))}function mt(e,t){at((()=>{!Re&&e&&t&&ee(t,"id")&&!ee(t,"anchor")&&Tt(e)}))}function yt(t,n,i){let r,o=t.getProperty(e.PROP.TO_WORKFLOW_ACTIVITY).getValue(),a=We(n);ee(i,"target")&&!o&&(o=i.target.pos),!o&&ae&&(o=ve(a,ae,!0));let l=Ve(a,o,t.id);return qe(t)&&te.setLinkLabel(l,t.getProperty(e.PROP.NAME).getValue()),i?.source&&Object.keys(i.source).length&&(de=!0,r=Rt(i.source,"source"),te.setLinkSourceAnchor(l,r)),i?.target&&Object.keys(i.target).length&&(de=!0,r=Rt(i.target,"target"),te.setLinkTargetAnchor(l,r)),i?.vertices&&i.vertices.length&&(de=!0,te.setLinkVertices(l,i.vertices)),l}function Ct(t){let n,i,r;switch(t.typeId){case e.COMP_TYPE.WORKFLOW_ACTIVITY:i=t.getProperty(e.PROP.DIAGRAM).getValue(),i&&(i=Je(i)),Be(t.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue(),{text:t.getProperty(e.PROP.NAME).getValue(),...i.position},t.id);break;case e.COMP_TYPE.WORKFLOW_TRANS:r=t.getProperty(e.PROP.FROM_WORKFLOW_ACTIVITY).getValue();case e.COMP_TYPE.WORKFLOW_BRANCH:r||=t.parentId,n=Je(t.getProperty(e.PROP.DIAGRAM).getValue()),yt(t,r,n)}}function Wt(e){t(document).trigger(O,[l,e])}function Mt(t){if([...y,...C].forEach((e=>a.disable(e))),!t?.length||t?.length&&t.some((t=>it(t).getProperty(e.PROP.STATE).getValue()===U)))return;C.forEach((e=>a.enable(e)));let n=t.every((e=>d.includes(e.typeId)&&it(e)?.id===re))?a.enable:a.disable;y.forEach((e=>n(e)))}t(document).on(O,(function(t,n,i,r=[]){let o,O,u,s=[];if(n!==l)if(1!==r.length||r[0]._parent){if(s.push(...i.filter((e=>e&&R.includes(e.typeId))).reduce(((e,t)=>(e.push(t.id),e)),[])),s.length)u=it(i.find((e=>e)));else{if("number"==typeof r){if(o=i.find((t=>t.typeId===e.COMP_TYPE.WORKFLOW)),!o){let t=i[0];for(;t&&t.typeId!==e.COMP_TYPE.WORKFLOW;){if([e.COMP_TYPE.WORKFLOW_ACTIVITY,e.COMP_TYPE.WORKFLOW_VERSION].includes(t.typeId)){u=t.typeId===e.COMP_TYPE.WORKFLOW_VERSION?t:t.getParent();break}t=t.getParent()}!u&&t&&(o=t)}}else if(o=i.find((t=>t.typeId===e.COMP_TYPE.WORKFLOW)),!o){let t=r[0];for(;t&&t.data?.typeId!==e.COMP_TYPE.WORKFLOW;){if(t.data&&[e.COMP_TYPE.WORKFLOW_ACTIVITY,e.COMP_TYPE.WORKFLOW_VERSION].includes(t.data.typeId)){u=t.data.typeId===e.COMP_TYPE.WORKFLOW_VERSION?e.getComponents(e.COMP_TYPE.WORKFLOW_VERSION,{id:t.data.componentId})[0]:it(me(t.data.componentId));break}t=t._parent}!u&&t&&(o=e.getComponents(e.COMP_TYPE.WORKFLOW,{id:t.data.componentId})[0])}if(re&&(O=e.getComponents(e.COMP_TYPE.WORKFLOW_VERSION,{id:re})[0].getParent().id),!o||re&&o.id===O||(u=function(t){let n=t.getChilds(e.COMP_TYPE.WORKFLOW_VERSION),i=n.find((t=>"ACTIVE"===t.getProperty(e.PROP.STATE).getValue())),r=n.find((t=>"DEVELOPMENT"===t.getProperty(e.PROP.STATE).getValue())),o=n.find((t=>"INACTIVE"===t.getProperty(e.PROP.STATE).getValue()));return i||r||o}(o)),!u&&O!==o?.id)return void ke()}if(!u||re===u.id&&!s.length)return Mt([]),void te.deselect();ne.is(":visible")||(le=s),u.id!==re&&(ne.is(":visible")&&(ot(u),n!==E&&(Ie=[],a.hide(m))),re=u.id),Mt([]),setTimeout((function(){Pe=!0,Me(s,{scrollTo:!0})}),1)}else ke();else Mt(i.filter((t=>[...d,e.COMP_TYPE.WORKFLOW_ACTIVITY].includes(t.typeId))))})),t("#editor_tabs, #peTabs").on("tabsactivate",(function(e,t){if("grid_diagram"===t.newPanel[0].id){let e=rt();e&&(ot(e),le&&setTimeout((function(){Pe=!0,Me(le,{scrollTo:!0}),le=""}),1))}})),e.observer(l,{component:{typeIds:R},events:[e.EVENT.CREATE]},(function(t){let n,i,r,o,a,O=t.component,E=it(O),u=ye(O.id);if(O.typeId===e.COMP_TYPE.WORKFLOW_VERSION){ke(!1),te.setReadOnly(!1);let n=O.getAllChildren();t.action?ct((function(){let t=e.transaction.start("",l);5===n.length&&nt(n),t.execute()})):(5===n.length&&nt(n),re=E.id)}if(Te||!E||E&&E.id!==re||u){if(ce&&(ce=!1,qe(O))){let t=Pt(O);O.typeId===e.COMP_TYPE.WORKFLOW_ACTIVITY?te.setElementText(u,t):te.setLinkLabel(u,t)}}else switch(de=!0,O.typeId){case e.COMP_TYPE.WORKFLOW_ACTIVITY:o=O.getProperty(e.PROP.DIAGRAM).getValue(),i=me(O.id).getProperty(e.PROP.DIAGRAM),n=i.getValue(),o!==n&&(o=n),o=Je(o),u=Be(O.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue(),{text:O.getProperty(e.PROP.NAME).getValue(),...o.position},O.id),t.action||i.setValue(lt(u)),Ue(u);break;case e.COMP_TYPE.WORKFLOW_TRANS:a=O.getProperty(e.PROP.FROM_WORKFLOW_ACTIVITY).getValue();case e.COMP_TYPE.WORKFLOW_BRANCH:a||=O.parentId,r=Je(O.getProperty(e.PROP.DIAGRAM).getValue()),u=yt(O,a,r),t.action||me(O.id)?.getProperty(e.PROP.DIAGRAM).setValue(Ot(u))}})),e.observer(l,{component:{typeIds:R},events:[e.EVENT.CHANGE],properties:[e.PROP.FROM_WORKFLOW_ACTIVITY,e.PROP.TO_WORKFLOW_ACTIVITY,e.PROP.TRANSITION_TYPE,e.PROP.PAGE_PROCESS_TYPE,e.PROP.NAME,e.PROP.ITEM_LABEL,e.PROP.STATE]},(function(t){let n,i,r,o,a,l=t.component;function O(e){let n=t.properties[e];return n&&n.includes("change")}if(!ne.is(":visible")||ce||Te)ce=!1;else if(l.typeId===e.COMP_TYPE.WORKFLOW_VERSION&&l.id===re&&O(e.PROP.STATE)){Mt(l),a=l.getProperty(e.PROP.STATE).getValue(),te.setReadOnly(a===U);let t=a===k;l.getAllChildren().forEach((r=>{if(d.includes(r.typeId))i=ye(r.id),i&&(i.prop(B,t),i.prop(V,t),i.prop(F,t),i.prop(S,t));else if(r.typeId===e.COMP_TYPE.WORKFLOW_ACTIVITY&&(n=ye(r.id),n)){let i=r.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue();i!==s&&n.prop(K,t),i!==u&&n.prop(Y,t),n.prop(S,t),n.prop(F,t||i===T)}}))}else if(Ee&&Oe===l.id&&(clearTimeout(Ee),Oe=void 0),l=me(l.id),l?.typeId)switch(l.typeId){case e.COMP_TYPE.WORKFLOW_ACTIVITY:n=We(l.id),O(e.PROP.PAGE_PROCESS_TYPE)&&(ct((()=>{te.changeElementType(n,l.getProperty(e.PROP.PAGE_PROCESS_TYPE).getValue())})),n=ye(l.id)),(O(e.PROP.ITEM_LABEL)||O(e.PROP.NAME)||qe(l)&&(t.action||O(e.PROP.PAGE_PROCESS_TYPE)))&&te.setElementText(n,Pt(l));break;case e.COMP_TYPE.WORKFLOW_TRANS:r=l.getProperty(e.PROP.FROM_WORKFLOW_ACTIVITY).getValue();case e.COMP_TYPE.WORKFLOW_BRANCH:if(r||=l.parentId,o=l.getProperty(e.PROP.TO_WORKFLOW_ACTIVITY).getValue(),o||=Le(l.getProperty(e.PROP.DIAGRAM).getValue())?.target?.pos,i=Ce(l.id),!i)return;if(O(e.PROP.TO_WORKFLOW_ACTIVITY))if(o){let e=te.getLinkTarget(i);e&&ee(e,"id")?e.id!==ye(o)?.id&&Ke(i,o,!0):i.attributes?.target?.x===o.x&&i.attributes?.target?.y===o.y||Ke(i,o,!0)}else Ke(i,o,!0);if(O(e.PROP.FROM_WORKFLOW_ACTIVITY))if(r){let e=te.getLinkSource(i);e&&ee(e,"id")?e.id!==r&&Ye(i,r,!0):Ye(i,r,!0)}else Ye(i,r,!0);O(e.PROP.NAME)&&qe(l)&&te.setLinkLabel(i,l.getProperty(e.PROP.NAME).getValue()),O(e.PROP.TRANSITION_TYPE)&&(te.setLinkDesignation(i,l.getProperty(e.PROP.TRANSITION_TYPE).getValue()),qe(l)?te.setLinkLabel(i,l.getProperty(e.PROP.NAME).getValue()):te.removeLinkLabel(i))}})),e.observer(l,{component:{typeIds:R},events:[e.EVENT.DELETE]},(function(t){let n,i=t.component,r=it(i);Te||!re||r&&r.id!==re||ce?ce=!1:i.typeId!==e.COMP_TYPE.WORKFLOW_VERSION?(n=ye(i.id),n&&ct((()=>{te.getLinks().filter((e=>Se(e)?.id===n.id)).forEach((i=>{Ke(i,n.position());let r=me(he(i));r&&(t.action?(Oe=r.id,Ee=setTimeout((function(){Qe((function(){Tt(i)}))}),1)):r.getProperty(e.PROP.DIAGRAM).setValue(Ot(i)))})),Ge(n)}))):ke()})),e.observer(l,{component:{typeIds:R},events:[e.EVENT.ERRORS,e.EVENT.NO_ERRORS,e.EVENT.WARNINGS,e.EVENT.NO_WARNINGS,e.EVENT.VALIDATE_COMPONENT]},(function(e){Ue(e.component)}));const Dt=r.getWorkflowActivitiesConfig(),ht=Object.keys(Dt).reduce(((e,t)=>(e.push({typeId:t,...Dt[t]}),e)),[]);ne=t("#app"),te=new DiagramBuilder({el:ne[0],...v,elements:ht,showNavigator:se}),ne[0].diagramBuilder=te,ne[0].diagramBuilder.getCurrentVersion=rt,a.add([{name:_,action:function(){te.zoom(.1)}},{name:I,action:function(){te.zoom(-.1)}},{name:p,label:pe("ACTION_SHOW_NAVIGATOR"),get:function(){return se},set:function(e){e?te.showNavigator():te.hideNavigator(),se=!se}},{name:N,icon:"icon-line-segment-straight",get:function(){let e=je();return!!e&&!!d.includes(e.typeId)&&fe(e)?.router?.name===z},set:function(e){let t=e?z:void 0;te.getSelection().forEach((e=>te.setLinkRouter(e,t))),Tt(te.getSelection()),t&&a.update(A)}},{name:A,icon:"icon-line-segment-orthogonal",get:function(){let e=je();return!!e&&!!d.includes(e.typeId)&&fe(e)?.router?.name===H},set:function(e){let t=e?H:void 0;te.getSelection().forEach((e=>te.setLinkRouter(e,t))),Tt(te.getSelection()),t&&a.update(N)}},{name:f,icon:"icon-move-to-front",action:function(){let e,t,n=te.getSelection();n.length&&(t=me(he(n[0])),t&&(e=d.includes(t.typeId)),n.forEach((e=>{e.toFront()})),e?Tt(n):st(n))}},{name:L,icon:"icon-move-to-back",action:function(){let e,t,n=te.getSelection();n.length&&(t=me(he(n[0])),t&&(e=d.includes(t.typeId)),n.forEach((e=>{e.toBack()})),e?Tt(n):st(n))}},{name:m,action:function(){let n=Ie.pop();n&&t(document).trigger(O,[E,e.getComponents(e.COMP_TYPE.WORKFLOW_VERSION,{id:n})]),Ie.length<1&&a.hide(m)}}]),Mt(),a.hide(m),ie=t("#diagramMenu"),ie.menu({menubar:!1,items:[...function(){let e,t=r.getWorkflowActivities(),n=[];for(let i in t)ee(t,i)&&(e=t[i],i!==u&&n.push({id:i,label:e.title,type:"action",icon:r.getComponentIconClass("activity",i),action:function(e,t,n){switch(n.context){case DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_POINTERUP:case DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_KEYBOARDTRIGGER:Ze.call(this);break;case DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_POINTERDOWN:case DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_KEYBOARDTRIGGER:Xe.call(this);break;case DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_POINTERDOWN:case DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_KEYBOARDTRIGGER:$e.call(this)}},hide:function(){return i===s&&oe===DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_POINTERDOWN||![DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_POINTERUP,DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_KEYBOARDTRIGGER,DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_POINTERDOWN,DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_KEYBOARDTRIGGER,DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_POINTERDOWN,DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_KEYBOARDTRIGGER].includes(oe)}}));return n.push({type:"separator"},{label:i.getMessage("PD.WF.CREATE_CONNECTION"),type:"action",action:xe,hide:function(){let e=je();return!e||!r.isInactive(e,k)||![DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_POINTERUP,DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_KEYBOARDTRIGGER].includes(oe)}}),n}(),{label:i.getMessage("PD.TREE.DUPLICATE"),type:"action",action:function(){let t=je();if(t){let n=e.transaction.message({action:e.MESSAGE_ACTION.DUPLICATE,component:t,count:1}),i=e.transaction.start("",n);t.duplicate(),Ne(i)}},hide:function(){let e=je();return!e||!r.isInactive(e,k)||![DiagramBuilder.Event.ELEMENT_MENUBUTTON_POINTERDOWN,DiagramBuilder.Event.ELEMENT_MENUBUTTON_KEYBOARDTRIGGER].includes(oe)}},{label:i.getMessage("PD.WF.CREATE_CONNECTION"),type:"action",action:xe,hide:function(){let t=je();return!t||!r.isInactive(t,k)||t.getProperty(e.PROP.PAGE_PROCESS_TYPE)?.getValue()===s||![DiagramBuilder.Event.ELEMENT_MENUBUTTON_POINTERDOWN,DiagramBuilder.Event.ELEMENT_MENUBUTTON_KEYBOARDTRIGGER].includes(oe)}},{label:pe("CREATE_ACTIVITY_VARIABLE"),type:"action",action:function(){let t=je();t&&we(e.COMP_TYPE.WORKFLOW_ACT_VAR,t)},hide:function(){let e=je();return!e||!r.isInactive(e,k)||![DiagramBuilder.Event.ELEMENT_MENUBUTTON_POINTERDOWN,DiagramBuilder.Event.ELEMENT_MENUBUTTON_KEYBOARDTRIGGER].includes(oe)}},{type:"separator"},{label:pe("OPEN_WORKFLOW"),type:"action",action:function(){let n=je();if(!n)return;let i=e.getPluginProperty(e.COMP_TYPE.WORKFLOW_ACTIVITY,T,1).id;if(i){let r=n.getProperty(i).getValue();r&&(Ie.push(re),a.show(m),t(document).trigger(O,[E,e.getComponents(e.COMP_TYPE.WORKFLOW,{id:r})]))}},hide:function(){let t=je();return!t||t.getProperty(e.PROP.PAGE_PROCESS_TYPE)?.getValue()!==T||![DiagramBuilder.Event.ELEMENT_MENUBUTTON_POINTERDOWN,DiagramBuilder.Event.ELEMENT_MENUBUTTON_KEYBOARDTRIGGER].includes(oe)}},...Q],afterClose:()=>{te.focus()}}),te.on({[DiagramBuilder.Event.SELECTION_CHANGE]:e=>{if(!e?.length)return;let t=e.map((e=>me(he(e))));t=t.filter((e=>e)),Mt(t),Pe?Pe=!1:t.length&&Wt(t)},[DiagramBuilder.Event.BLANK_POINTERUP]:()=>{Mt(),re&&Wt([rt()])},[DiagramBuilder.Event.ELEMENT_ADD]:e=>{at((()=>{let{typeId:t,position:n,z:i}=e.attributes;Ne(Nt(t,{position:n,z:i},e.id))}))},[DiagramBuilder.Event.ELEMENT_REMOVE]:e=>{at((()=>{Ne(At(he(e)))}))},[DiagramBuilder.Event.ELEMENT_POINTERUP]:()=>{at((()=>{st(te.getSelection())}))},[DiagramBuilder.Event.ELEMENT_BEFORE_DROP]:(t,n,i,r)=>{r&&(ue=e.transaction.start(l),_e=!0)},[DiagramBuilder.Event.ELEMENT_POSITION_CHANGE]:function(e,t,n){(n||ue)&&st(e)},[DiagramBuilder.Event.LINK_ADD]:t=>{at((()=>{if(t&&ee(t,"attributes")){if(t.attributes.source?.id){let n=me(he(ye(t.attributes.source.id)));n&&t.prop(B,be(n)===e.COMP_TYPE.WORKFLOW_TRANS)}ue||t.attributes.target?.id?Lt(t):Re=!0}}))},[DiagramBuilder.Event.LINK_REMOVE]:e=>{at((()=>{if(Re)return void(Re=!1);Ne(At(he(e)))}))},[DiagramBuilder.Event.LINK_POINTERUP]:e=>{at((()=>{Re?(Re=!1,Lt(e.model)):e&&e.model&&Tt(e.model)}))},[DiagramBuilder.Event.LINK_VERTEXHANDLE_POINTERUP]:(e,t,n,i,r)=>{(i.x!==r.x||i.y!==r.y)&&Tt(e.model)},[DiagramBuilder.Event.LINK_VERTEX_REMOVE]:e=>{Tt(e)},[DiagramBuilder.Event.LINK_SEGMENTHANDLE_POINTERUP]:(e,t,n,i,r)=>{Object.keys(r).length&&Tt(e.model)},[DiagramBuilder.Event.LINK_SOURCE_ANCHOR_POINTERUP]:e=>{Tt(e.model)},[DiagramBuilder.Event.LINK_TARGET_ANCHOR_POINTERUP]:e=>{Tt(e.model)},[DiagramBuilder.Event.LINK_TARGET_CHANGE]:mt,[DiagramBuilder.Event.LINK_SOURCE_CHANGE]:mt,[DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_POINTERUP]:(e,t,n,i,r)=>{et(e.model,DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_POINTERUP,tt(r),n)},[DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_KEYBOARDTRIGGER]:(e,t,n)=>{const i=t.el.getBoundingClientRect();et(e.model,DiagramBuilder.Event.ELEMENT_CONNECTBUTTON_KEYBOARDTRIGGER,{x:i.x+i.width/2,y:i.y+i.height/2},n)},[DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_POINTERDOWN]:(e,t,n,i,r)=>{et(e.model,DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_POINTERDOWN,tt(r))},[DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_KEYBOARDTRIGGER]:(e,t)=>{const n=t.el.getBoundingClientRect();et(e.model,DiagramBuilder.Event.LINK_TARGET_PLACEHOLDER_KEYBOARDTRIGGER,{x:n.x+n.width/2,y:n.y+n.height/2})},[DiagramBuilder.Event.ELEMENT_MENUBUTTON_POINTERDOWN]:(e,t,n)=>{et(e.model,DiagramBuilder.Event.ELEMENT_MENUBUTTON_POINTERDOWN,tt(n))},[DiagramBuilder.Event.ELEMENT_MENUBUTTON_KEYBOARDTRIGGER]:(e,t)=>{const n=t.el.getBoundingClientRect();et(e.model,DiagramBuilder.Event.ELEMENT_MENUBUTTON_KEYBOARDTRIGGER,{x:n.x+n.width/2,y:n.y+n.height/2})},[DiagramBuilder.Event.LINK_MENUBUTTON_POINTERDOWN]:(e,t,n)=>{et(e.model,DiagramBuilder.Event.LINK_MENUBUTTON_POINTERDOWN,tt(n))},[DiagramBuilder.Event.LINK_MENUBUTTON_KEYBOARDTRIGGER]:(e,t)=>{const n=t.el.getBoundingClientRect();et(e.model,DiagramBuilder.Event.LINK_MENUBUTTON_KEYBOARDTRIGGER,{x:n.x+n.width/2,y:n.y+n.height/2})},[DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_POINTERDOWN]:(e,t,n,i)=>{et(e.model,DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_POINTERDOWN,tt(i),n)},[DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_KEYBOARDTRIGGER]:(e,t)=>{const n=t.el.getBoundingClientRect();et(e.model,DiagramBuilder.Event.LINK_ADDELEMENTBUTTON_KEYBOARDTRIGGER,{x:n.x+n.width/2,y:n.y+n.height/2})},[DiagramBuilder.Event.BEFORE_KEYBOARD_ACTION]:(t,n,i)=>{t!==DiagramBuilder.KeyboardAction.CELL_REMOVE||te.isReadOnly()||rt()?.getProperty(e.PROP.STATE)?.getValue()!==k||(i.process=!1,te.getSelection().forEach((e=>He(me(he(e))))))}}),t(document).trigger("diagramReady")}))}(window.pe,apex.jQuery,apex.debug,apex.lang,window.pageDesigner,apex.util,apex.actions);