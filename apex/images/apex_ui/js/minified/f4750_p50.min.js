/*!
 Copyright (c) 2023, Oracle and/or its affiliates. All rights reserved.
 */
!function(e,n,a,t,i,r,o,s,l,p,c,u,d){"use strict";const f="INIT_INSTALL_APP",m="INSTALL_APP",A="UPDATE_APP",g="CHECK_INSTALLED_APPS",L="CHECK_PENDING_INSTALL",_="P50_APP_INSTALL_INT_NAME",P="P50_APP_INSTALL_AUTHOR",E="P50_REMOVE_FLOW_ID",h="app_card",N="APP_CONTENT",w="is-installing",I=p.APEX_FILES+"apex_ui/img/icons/pkg-apps/app-placeholder.svg",T=p.APEX_BASE_VERSION,R=t.getMessage("GALLERY.INSTALL_APP"),C=t.getMessage("GALLERY.INSTALLING_APP"),S=t.getMessage("GALLERY.REMOVE_APP"),x=t.getMessage("GALLERY.UPDATE_APP"),b=t.getMessage("GALLERY.UPDATING_APP"),O=t.getMessage("GALLERY.FILE_DOWNLOAD_ERROR"),M=t.getMessage("GALLERY.MISSING_VALUES_ERROR"),v="PENDING",D="ERROR",G="UPDATE",y="Y"===n("P50_GALLERY_BACKGROUND_INSTALL").getValue(),Y=4e3;let V,U,F,$=!0,z="undefined"!=typeof gInstalledApps?gInstalledApps:[],k="undefined"!=typeof gPendingApps?gPendingApps:[],q=[];async function H(e=""){let n;return await async function(){let a;return W(),e&&(a=await fetch(e,{method:"GET",mode:"cors",credentials:"omit",cache:"no-store",redirect:"follow",referrerPolicy:"no-referrer"}).then((e=>{if(e.ok)return e.blob();n=e})).catch((()=>{n={url:e,status:"failed",statusText:"Connection refused"}}))),n&&function(e){throw c.error(`Failed network request for ${e.url}`,e),X(O),new Error(`Failed network request: ${e.status} ${e.statusText}`)}(n),B(),a}()}function W(){$&&(V=e.showSpinner(d("body")))}function B(){$&&V&&V.length>0&&V.remove()}function K(n,a,t,i){B(),s.showDialog(e.applyTemplate(n),{confirm:!0,callback:function(e){i(!!e)},okLabel:a,dialogClass:"ui-dialog--notification",unsafe:!1,modern:!0,style:t||"information"})}function X(e){B(),s.clearErrors(),s.showErrors([{type:"error",location:"page",message:e,unsafe:!1}])}function j(e){const n=e.closest(`li.${h}`);return{appId:n.data("app-id"),name:n.data("name"),description:n.data("desc"),author:n.data("author"),internalName:n.data("internal-name"),version:n.data("version"),icon:n.data("icon"),zipUrl:n.data("zip-url")}}function J(e){const n=j(e);K(t.formatMessage("GALLERY.REMOVE_APP_CONFIRM",n.name,n.appId),S,"danger",(function(e){e&&o.submit({request:"REMOVE_APP",set:{[E]:n.appId},showWait:!0})}))}async function Q(e,a=!0,i=!1){const o=j(e);let s=[];if(!o.zipUrl)return void X(O);if(!o.author||!o.internalName)return c.error("Missing required values: author, internalName"),void X(M);var p;(p=o.internalName)&&q.push(p),a&&(!function(e,n=!1){const a=e.closest(`li.${h}`),t=j(e),i=d(`#${N}`).find(`.${h}`).find("button"),r=a.find(".menu_button"),o=n?b:C;e&&e.length>0&&(e.find("span").text(o),e.attr("disabled","disabled"),e.attr("role","alert")),r.attr("disabled","disabled"),a.addClass(w),F=t.internalName,y||i&&i.length>0&&i.attr("disabled","disabled")}(e,i),y&&($=!1),n(_).setValue(o.internalName),n(P).setValue(o.author),i?(n(E).setValue(o.appId),s=[_,P,E]):s=[_,P]);const u=await H(o.zipUrl);u&&await async function(e,n,a,i,o,s,p,u,f,m,A){const g=t.formatMessage("GALLERY.INSTALL_APP_ERROR",n),L="packaged_app_"+(new Date).getTime()+".zip",_=new File([u],L,{type:u.type,lastModified:(new Date).getTime()});let P;W(),P=await async function(t){let r,c=new FormData,u=m;c.append("F01",t,t.name);try{r=await l.process(u,{x01:o,x02:i,x03:e,x04:n,x05:a,x06:p,x07:s,formData:c,pageItems:A})}catch(e){r={success:!1,error:"Connection refused"}}return r}(_),P.success?(B(),f?d("body").trigger("app-install-initialized",{appName:n,appDesc:a,appAuthor:i,appIntName:o}):P.url&&r.redirect(P.url)):(c.error("upload error",P.error),X(g))}(o.appId,o.name,o.description,o.author,o.internalName,o.version,o.icon,u,a,i?A:a?m:f,s),function(e){e&&(q=q.filter((n=>n!==e)))}(o.internalName),a&&($=!0,ee(),Z())}function Z(){U||(U=setInterval((async function(){let n=[],i="";k=await async function(){return await l.process(L,{},{})}(),k.length>0&&(k.some((e=>e.status===v))?c.trace("Still pending installation of apps...",k):(z=await async function(){return await l.process(g,{},{})}(),function(){const e=a("SAMPLE_APPS"),n=a("STARTER_APPS"),t=a("UTILITY_APPS"),i=a("CUSTOM_APPS_CONTENT");e&&e.refresh(),n&&n.refresh(),t&&t.refresh(),i&&i.refresh()}(),ee()),k.some((e=>e.status===D))&&(c.error("Error happened during app installation",k),n=k.filter((e=>e.status===D)),n.forEach((n=>{i=t.formatMessage("GALLERY.INSTALL_APP_ERROR",n.name),n.message&&(i+=" "+n.message),function(e,n=!1){const a=n?e.find(".update_app_button"):e.find(".install_app_button"),t=d(`#${N}`).find(`.${h}`).find("button"),i=e.find(".menu_button"),r=n?x:R;a&&a.length>0&&(a.find("span").text(r),a.attr("disabled",!1),a.removeAttr("role")),i.attr("disabled",!1),e.removeClass(w),F=null,y||t&&t.length>0&&t.attr("disabled",!1)}(d(`li.app_card[data-internal-name="${e.escapeCSS(n.internalName)}"]`),n.action===G)})),i&&X(i)))}),Y))}function ee(){U&&(clearInterval(U),U=null)}d((()=>{u.add({name:"APP_DETAILS",label:t.getMessage("GALLERY.APP_DETAILS"),icon:"a-Icon icon-gallery-app-details",action:function(e,n){c.trace("APP_DETAILS action",this,e,n),Q(d(n),!1)}}),u.add({name:"REMOVE_APP",label:t.getMessage("GALLERY.REMOVE_APP"),icon:"a-Icon icon-gallery-remove",action:function(e,n){c.trace("REMOVE_APP action",this,e,n),J(d(n))}}),k.length>0&&Z()})),window.installApp=Q,window.removeInstalledApp=J,window.updateInstalledApp=function(e){const n=j(e);K(t.formatMessage("GALLERY.UPDATE_APP_CONFIRM",n.name,n.appId),x,"warning",(function(n){n&&Q(e,!0,!0)}))},window.switchAppGroupTab=function(){let t=e.escapeCSS(n("P50_APP_GROUP").getValue()),i=d("#"+t),r=d("#"+t+"_CONTENT");d(".apps_region, .apps_region_container").hide(),i.show(),i.hasClass("apps_region")&&(d("#"+t+"_ClientSideTemplator").css("width","100%"),a(t).call("resize")),i.hasClass("apps_region_container")&&r.length>0&&(r.show(),d("#"+t+"_CONTENT_ClientSideTemplator").css("width","100%"),a(t+"_CONTENT").call("resize"))},window.clientSideTemplatorJSInitCode=function(e){const n="en",a=i.getLanguage().toLowerCase()||n;function t(e,n,a){return e.internalName===n.toLowerCase()&&e.author===a.toLowerCase()}return e.showErrors=!1,e.prepareRowData=function(e){let i,r={},o=e.i18n&&e.i18n[a],s=o&&e.i18n[a].name,l=o&&e.i18n[a].description,p=z||[],c=k||[];return r.name=e.name?e.name:s?e.i18n[a].name:e.i18n[n].name,r.description=e.description?e.description:l?e.i18n[a].description:e.i18n[n].description,r.lang=s?a:e.i18n&&e.i18n[n]&&e.i18n[n].name?n:"",r.internalName=e.internalName?e.internalName.toLowerCase():"",r.author=e.author?e.author:"",r.version=e.version?e.version:"",r.apexVersion=e.apexVersion?e.apexVersion:T,r.icon=e.icon?e.icon:I,r.url=e.url?e.url:"",r.zip=e.zip?e.zip:"",i=p.find((e=>t(e,r.internalName,r.author)))||{},r.appId=i?.id||"",r.appLink=i?.appLink||"",r.editLink=i?.editLink||"",r.installedVersion=i?.version||"",r.isInstalled=p.some((e=>t(e,r.internalName,r.author)))?"Y":"N",r.updateAvailable=p.some((e=>t(e,r.internalName,r.author)&&e.version!==r.version))?"Y":"N",r.installPending=c.some((e=>t(e,r.internalName,r.author)&&e.status===v))?"Y":"N",r.isOracle=r.author.toLowerCase()==="Oracle".toLowerCase()&&r.zip.startsWith("https://raw.githubusercontent.com/oracle/apex/")?"Y":"N",r.isCompatible=parseFloat(r.apexVersion)<=parseFloat(T)?"Y":"N",r},e.filterData=function(e){return e=(e=(e=e.filter((function(e){return"Y"===e.isCompatible}))).sort(((e,n)=>parseFloat(n.apexVersion)-parseFloat(e.apexVersion)))).filter(((e,n,a)=>a.findIndex((n=>n.internalName===e.internalName&&n.author===e.author))===n))},e.sortData=function(e,n){let a=e.name.toLowerCase(),t=n.name.toLowerCase();return a<t?-1:a>t?1:0},e.searchItemFilter=function(e,n,a){const t=n.NAME?n.NAME.index:0,i=n.DESCRIPTION?n.DESCRIPTION.index:0,r=n.AUTHOR?n.AUTHOR.index:0;return e=e.filter((function(e){return e[t].toLowerCase().includes(a.toLowerCase())||e[i].toLowerCase().includes(a.toLowerCase())||e[r].toLowerCase().includes(a.toLowerCase())}))},e},window.initCardMenuButtons=function(n){n&&n.length>0&&d("button[data-menu^='cst_menu_']",n).each((function(){const n=e.escapeCSS(this.getAttribute("data-menu"));d(`div.a-Menu[id=${n}]`).remove(),d(`#${n}`).menu()}))},window.focusLastInstalledApp=function(){if(F){const n=d(`li.app_card[data-internal-name="${e.escapeCSS(F)}"]`);n&&n.length>0&&n.find("button.launch-aut").focus(),F=null}},window.hasRequestedApps=function(){return q.length>0}}(apex.util,apex.item,apex.region,apex.lang,apex.locale,apex.navigation,apex.page,apex.message,apex.server,apex.env,apex.debug,apex.actions,apex.jQuery);