/*!
 Copyright (c) 2015, 2024, Oracle and/or its affiliates.
 */
apex.model={},function(e,t,i,n,s,r,l){"use strict";const a="table",o="tree",d="record",h="Malformed response",c="refresh",u="addData",f="revert",g="refreshRecords",_="delete",p="clearChanges",y="set",I="destroy",m="one",v="none";let R={},x=[],w=100,M=10;const b=new Set(["genIdPrefix","pageItemsToSubmit","fetchData","saveData","regionData","requestOptions","parentRecordId","editable","pageSize","callServer","visibilityFilter","visibilityFilterContext","trackChanges","onlyMarkForDelete","delayClearData"]),k=n.hasOwnProperty,F=l.extend,D=Array.isArray,C=l.isPlainObject,K=e=>"function"==typeof e,S=l.Deferred,A=n.equalValue,T=r.toNumber;function O(e){return e.replace(/#/g,"").split(/\s*,\s*/)}function q(e){return"object"==typeof e&&k(e,"v")}function B(e){if("string"==typeof e)return[e,null];if(D(e)&&2===e.length&&"string"==typeof e[0]&&(null===e[1]||"string"==typeof e[1]))return e;throw new Error("Invalid model id")}const V=new Map;function P(e){let t=V.get(e);return t||(t=1e3),V.set(e,t+1),t}function E(e){if(D(e)){let t=[];for(let i=0;i<e.length;i++)t.push(E(e[i]));return t}return C(e)?F(!0,{},e):e}function N(e,t,n){let s=e._listeners;for(let e=0;e<s.length;e++)try{s[e].onChange(t,n)}catch(e){i.error("Error in model listener.",e)}}function j(e,t,i,n,s,r){e?t.call(e,i,n,s,r):t(i,n,s,r)}function z(e){e.allowedOperations&&(e.canEdit=!!e.allowedOperations.update,e.canDelete=!!e.allowedOperations.delete)}function U(e){return"string"==typeof e?e:D(e)?1===e.length?""+e[0]:JSON.stringify(e):e.toString()}function W(e,t){let i=[],s=[];function r(e){let t,n=e._listeners;for(let e=0;e<n.length;e++)t=n[e].progressView,t&&t[0]&&t[0].offsetWidth&&t[0].offsetHeight&&(i.push(t),s.push(n[e].progressOptions||null))}if(r(e),t)for(let e=0;e<t.length;e++)r(t[e]);return 0===i.length?null:e._options.makeLoadingIndicator?e._options.makeLoadingIndicator(i,s):function(){let e,t=l();for(let r=0;r<i.length;r++)e=n.showSpinner(i[r],s[r]),t=t.add(e);return function(){t.remove()}}}function $(e,t){return F({},e.requestOptions,{loadingIndicator:W(t)})}function H(e,t,i,n){let s,r=e;return n&&(r+=" Server status: "+n),s=new Error(r),t&&t.status>=0&&(s.status=t.status),s}function L(e,t){delete e.error,delete e.warning,delete e.message;for(let i in e.fields)if(k(e.fields,i)){let n=e.fields[i];t||(delete n.changed,delete n.stale),delete n.error,delete n.warning,delete n.message}}function G(e,t,i){let n=-1,s=-1;return t-1>=0&&(n=parseFloat(e[t-1][i])),t<e.length&&(s=parseFloat(e[t][i])),[n,s]}function J(e,t,i,n,s,r){let l;return-1===t&&(t=0),r&&r>t&&(-1===i||r<i)?r:(-1===i&&(i=t+e*n),l=i-t,t+l/(n+1)*s)}const Y=e=>new Error(`Model has invalid shape for the ${e} method`),X=e=>new Error(`Wrong data type for ${e} aggregate`),Q=()=>new Error("Model must have identityField defined"),Z=(e,t)=>new Error(`Field '${e}' depends on unknown field/item '${t}'`),ee=(e,t)=>new Error(e+" field not found: "+t);function te(e,t,i){var n,s,r,l;for(n in t)k(t,n)&&((s=t[n]).volatile||s.virtual||"string"==typeof(l=e[r=i?s.index:n])&&(e[r]=l.replace(/\r\n/g,"\n")))}function ie(e,t,i,n,r){let l=e._options,a=t.record,o=e._getIdentity(a),d=[];!function t(i,n,s){for(let r=0;r<i.length;r++){let a,o=i[r],d=l.fields[o];d&&!n[o]&&(d.dependsOn&&t(d.dependsOn,n,s),n[o]||!d.calcValue&&!d.dependsOn||(s.push(o),n[o]=1,a=e._dependentFields[o],a&&t(a,n,s)))}}(i,r||{},d);for(let i=0;i<d.length;i++){let r,h,c,u,f,g,_,p,I=d[i],m=l.fields[I];if(m.calcValue){g=[];for(let t=0;t<m.dependsOn.length;t++)c=m.dependsOn[t],":"===c.substr(0,1)?_=s(c.substr(1)).getValue():(u=l.fields[c],_=e.getValue(a,c),"NUMBER"===m.dataType&&(_=T(_,u?u.formatMask:null))),g.push(_);if(p=m.calcValue(g,e,a),r=e.getFieldKey(I),t.fields&&t.fields[I]&&t.fields[I].ck)throw new Error("Set calculated value not allowed for field");h=a[r],A(h,p)||(a[r]=p,t.fields||(t.fields={}),f=t.fields[I],f||(f={},t.fields[I]=f),l.trackChanges&&(f.changed=!0),n&&N(e,y,{oldValue:h,oldIdentity:null,recordId:o,record:a,field:I}),e._checkAggregates(I))}else m.cellTemplate?(r=e.getFieldKey(I),h=a[r],n&&N(e,y,{oldValue:h,oldIdentity:null,recordId:o,record:a,field:I})):(f=t.fields[I],f||(f={},t.fields[I]=f),f.stale=!0,n&&e.metadataChanged(o,I,"stale"))}}function ne(e,t){let i={},n=t.record,s=[];for(let t=0;t<e._calculatedFields.length;t++){let r=e._calculatedFields[t];null==n[e.getFieldKey(r)]?s.push(r):i[r]=1}s.length>0&&ie(e,t,s,!1,i)}const se={SUM:{name:"SUM",init:function(e){if(e.dataType&&"NUMBER"!==e.dataType)throw X("SUM");e.total=0,e.grandTotal=0},add:function(e,t){t=T(t,e.formatMask),isNaN(t)||(e.total+=t,e.grandTotal+=t)},get:function(e,t){const i=t?e.total:e.grandTotal;return t&&(e.total=0),i}},AVG:{name:"AVG",init:function(e){if(e.dataType&&"NUMBER"!==e.dataType)throw X("AVG");e.total=0,e.grandTotal=0,e.count=0,e.totalCount=0},add:function(e,t){t=T(t,e.formatMask),isNaN(t)||(e.total+=t,e.grandTotal+=t,e.count+=1,e.totalCount+=1)},get:function(e,t){const i=t?e.total/e.count:e.grandTotal/e.totalCount;return t&&(e.total=0,e.count=0),i}},MAX:{name:"MAX",init:function(e){e.max=null,e.overallMax=null},add:function(e,t){"NUMBER"===e.dataType?t=T(t,e.formatMask):t.d&&(t=t.d),null===t||""===t.toString().trim()||isNaN(t)||((null===e.max||t>e.max)&&(e.max=t),(null===e.overallMax||t>e.overallMax)&&(e.overallMax=t))},get:function(e,t){const i=t?e.max:e.overallMax;return t&&(e.max=null),i}},MIN:{name:"MIN",init:function(e){e.min=null,e.overallMin=null},add:function(e,t){"NUMBER"===e.dataType?t=T(t,e.formatMask):t.d&&(t=t.d),null===t||""===t.toString().trim()||isNaN(t)||((null===e.min||t<e.min)&&(e.min=t),(null===e.overallMin||t<e.overallMin)&&(e.overallMin=t))},get:function(e,t){const i=t?e.min:e.overallMin;return t&&(e.min=null),i}},MEDIAN:{name:"MEDIAN",init:function(e){e.values=[],e.allValues=[]},add:function(e,t){t=T(t,e.formatMask),isNaN(t)||(e.values.push(t),e.allValues.push(t))},get:function(e,t){const i=t?e.values:e.allValues,n=i.length;let s;return i.sort((function(e,t){return e-t})),s=n%2==0?(i[n/2]+i[n/2-1])/2:i[(n-1)/2],t&&(e.values=[]),s}},COUNT:{name:"COUNT",init:function(e){e.count=0,e.totalCount=0},add:function(e,t){t.v&&(t=t.v),null!==t&&""!==t.toString().trim()&&(e.count+=1,e.totalCount+=1)},get:function(e,t){const i=t?e.count:e.totalCount;return t&&(e.count=0),i}},COUNT_DISTINCT:{name:"COUNT_DISTINCT",init:function(e){e.count=0,e.totalCount=0,e.distinctValues={}},add:function(e,t){t.v&&(t=t.v),null!==t&&""!==t.toString().trim()&&(e.distinctValues[t]||(e.count+=1,e.totalCount+=1),e.distinctValues[t]=1)},get:function(e,t){const i=t?e.count:e.totalCount;return t&&(e.count=0),i}}},re={modelId:function(){return null===this.instance?this.name:[this.name,this.instance]},_addToFetchRequest:function(e,t){let n,s,r=this,l=this._options;if(l.shape===a){let e,i=null,s=(c=t,u=l.pageSize,Math.floor(c/u)*u);if(!this._clearDataPending&&(t=function(e){let t,i=r._data;for(t=e;t<i.length&&void 0!==i[t];t++);return t}(s),this._haveAllData&&t>=this._data.length||this._masterRecordIsInserted||this._masterRecordIsDeleted))return!1;if(l.paginationType===v&&0!==t)return!1;e=this._getServerOffset(t),l.paginationType!==v&&(i=s+l.pageSize-e,i<l.pageSize&&void 0===this._data[s+l.pageSize]&&(i+=l.pageSize)),n={version:l.version,firstRow:e+1,maxRows:i}}else{if(l.shape===d&&this._haveAllData)return!1;n={version:l.version}}var c,u;if(this._requestsInProgress.fetch)return null;if(s=F({},l.regionData,{id:l.regionId,ajaxIdentifier:l.ajaxIdentifier,fetchData:F({},l.fetchData,n)}),e.regions||(e.regions=[]),e.regions.push(s),l.pageItemsToSubmit){let t,i=e.pageItems;i?D(i)||(i=O(i),e.pageItems=i):(i=[],e.pageItems=i),t=l.pageItemsToSubmit,D(t)||(t=O(t));for(let e=0;e<t.length;e++)i.includes(t[e])||i.push(t[e])}return this._addParentItems(s),this._requestsInProgress.fetch=!0,function(e){e.done((function(e){let n=!1;if(delete r._requestsInProgress.fetch,!r._destroyed){if(e.regions)for(let i=0;i<e.regions.length;i++){let s=e.regions[i];if(s.id===l.regionId){let e=null,i=null,h=null,c=null,u=null;s=s.fetchedData,l.shape===a?(e=s.values,i=s.totalRows,h=s.firstRow-1,c=s.moreData,u=s.dataOverflow):l.shape===o?e=s.root:l.shape===d&&(e=s.value),(e||l.shape===d)&&(r._checkClearPending(),r._addData(t,h,e,i,c,u),n=!0)}}if(!n){let t=H(h);i.error("Failed to fetch data.",t),e.error=t}}})).fail((function(){delete r._requestsInProgress.fetch}))}},fetch:function(e,t,i){let n,s,r,l,a=this._options,o=S(),d={};return"number"!=typeof e&&(i=t,t=e,e=0),s=this._addToFetchRequest(d,e),s?(l=F({},a.requestOptions),i?delete l.loadingIndicator:l.loadingIndicator=W(this),n=this._callServer(d,l),s(n),n.done((e=>{e.error?o.reject(e.error):e.errors?o.reject(e.errors):o.resolve()})).fail(((e,t,i)=>{o.reject(H("Error fetching data.",e,0,i))})),r=o.promise(),r.always((e=>{this._destroyed||(t&&t(e),this._drainWaiters(e))})),r):s},fetchAll:function(e,t=!0){const i=this,s=this._options,r=s.pageSize,o="m"+this.modelId();let d,h,c,u=0;if(s.shape!==a)throw Y("fetchAll");if(r<1e3&&(s.pageSize=1e3),d=s.pageSize,!t){const e=l('<span class="u-Processing u-Processing--inline"><span class="u-Processing-spinner"></span></span>');h=W(this),h&&n.delayLinger.start(o,(function(){c=h(e)}))}for(;this._data[u];)u+=1;!function t(){const l=i.fetch(u,(function(n){n?e({error:n}):(e({offset:u,total:i.getTotalRecords(),done:!1}),u+=d,t())}),!0);null===l?setTimeout((function(){t()}),500):!1===l&&(s.pageSize=r,h&&n.delayLinger.finish(o,(function(){K(c)?c():c.remove()})),e({offset:u,total:i.getTotalRecords(),done:!0}))}()},fetchRecords:function(e,t){let n,s,r,l,a,o=this._options,c=[],u=S();if(o.shape===d)throw Y("fetchRecords");if(void 0===this._identityKeys)throw Q();for(let t=0;t<e.length;t++){let i=this._getIdentity(e[t]),n=this.getRecordMetadata(i);n&&!n.inserted&&c.push({recordId:i,pk:this._getPrimaryKey(e[t])})}return 0===c.length?null:(a=F({},o.regionData,{id:o.regionId,ajaxIdentifier:o.ajaxIdentifier,fetchData:F({},o.fetchData,{version:o.version,primaryKeys:c})}),r={regions:[a]},o.pageItemsToSubmit&&(r.pageItems=o.pageItemsToSubmit),this._addParentItems(r.regions[0]),l=$(o,this),n=this._callServer(r,l),n.done((e=>{let t;if(!this._destroyed){if(e.regions&&e.regions.length>0){let i=e.regions[0];i.fetchedData&&i.id===o.regionId&&(t=i.fetchedData.values)}if(t)this._updateData(t),u.resolve();else{let e=H(h);i.error("Failed update data.",e),u.reject(e)}}})).fail((function(e,t,i){u.reject(H("Error fetching records.",e,0,i))})),s=u.promise(),t&&s.always(t),s)},save:function(e){let t,i,n,s=$(this._options,this),r=S(),l={};return i=this.addChangesToSaveRequest(l),i?(t=this._callServer(l,s),i(t),t.done((function(e){e.errors?r.reject(e.errors):e.error?r.reject(e.error):r.resolve(null,e)})).fail((function(e,t,i){r.reject(H("Error saving data.",e,0,i))})),n=r.promise(),e&&n.always(e),n):null},saveInProgress:function(){return!!this._requestsInProgress.save},addChangesToSaveRequest:function(e){let t,s,r,l,a,o,d,c=this,u=this._options,f=this._metaKey,g=[],_=[],p={},y=[],I=0;function m(){delete c._requestsInProgress.save,c._changes=c._pendingChanges.concat(c._changes)}function v(e){let t,i,n,s,r,l,a=e.record;r=e.inserted&&!e.originalId,t=u.recordIsArray?[]:{};for(let s=0;s<_.length;s++)n=_[s],i=a[n],null!==i&&q(i)&&(i=i.v),l=p[n],e.fields&&e.fields[l]&&e.fields[l].disabled&&(i=""),!r||!c.isIdentityField(l)||e.original&&i!==e.original[n]||(i=""),"string"==typeof i&&(i=i.replace(/\n/g,"\r\n")),u.recordIsArray?t.push(E(i)):t[n]=E(i);s=null,e.deleted?s="d":e.inserted?s="i":e.updated&&(s="u"),t[f]||(t[f]={}),s&&(t[f].op=s),t[f].recordId=c._getIdentity(a),e.originalId&&(t[f].originalId=e.originalId),u.saveSelection&&(t[f].sel=e.sel?"Y":"N"),y.push(t)}if(u.pageItemsToSubmit){let t,i=e.pageItems;if(i||(i=[],e.pageItems=i),D(i)){t=u.pageItemsToSubmit,D(t)||(t=O(t));for(let e=0;e<t.length;e++)i.includes(t[e])||i.push(t[e])}}if(this._requestsInProgress.save||0===this._changes.length&&!u.saveSelection)return null;for(let e in u.fields)k(u.fields,e)&&(t=u.fields[e],t.virtual||(I+=1),t.volatile||t.virtual||(s=u.recordIsArray?t.index:e,_.push(s),p[s]=e,u.recordIsArray&&t.index===this._metaKey&&(f=_.length-1)));u.recordIsArray&&_.sort((function(e,t){return e-t})),f||(f=u.recordIsArray?_.length:"_meta");for(let e=0;e<this._changes.length;e++)r=this._changes[e],r.autoInserted&&!r.updated&&g.push(r.record);g.length&&this.deleteRecords(g);for(let e=0;e<this._changes.length;e++)r=this._changes[e],v(r);if(this._pendingChanges=this._changes,this._changes=[],u.saveSelection)for(const e of this._selection.values())e.inserted||e.deleted||e.updated||v(e);l=e.regions,l||(e.regions=l=[]);for(let e=0;e<l.length&&(a=l[e],a.id!==u.regionId);e++)a=null;return a||(a=F({},u.regionData,{id:u.regionId,ajaxIdentifier:u.ajaxIdentifier,saveData:{models:[]}}),l.push(a)),o=a.saveData.models,d=F({},u.saveData,{instance:this.instance,version:u.version,values:y}),this._addParentItems(d),o.push(d),this._requestsInProgress.save=!0,function(e){e.done((function(e){let t,s;if(!c._destroyed){if(e.errors){for(let t=0;t<e.errors.length;t++){let i=e.errors[t],s=i.message;i.unsafe||(s=n.unescapeHTML(s)),i.regionStaticId===u.regionStaticId&&i.recordId&&i.instance==c.instance&&c.setValidity("error",i.recordId,i.columnName||null,s)}m()}else if(e.regions){let n,r=!1,l=null;for(let i=0;i<e.regions.length;i++){if(t=e.regions[i],t.id===u.regionId){n=t.fetchedData.models;for(let e=0;e<n.length;e++)if(n[e].instance==c.instance){l=n[e].values,c._metaKey||(s=u.recordIsArray?I:"_meta"),l&&(c._updateData(l,s),r=!0);break}break}t=null}if(!r){let t=H(h);i.error("Failed update data after save.",t),e.error=t}c._clearChanges("_pendingChanges")}delete c._requestsInProgress.save}})).fail((function(){m()}))}},setData:function(e,t=0,i=null,n=!1){let s={clearDataPending:!1};this._options.shape===a&&(s.keepPagination=!1),null===i&&e&&!n&&(i=e.length),this._checkClearPending(),this._addData(t,t,e,i,n,!1),0!==t&&null!==t||N(this,c,s)},clearData:function(e=!0,t=!1){const i=this._options;let n=this._requestsInProgress,s={clearDataPending:!1};return!n.fetch&&!n.save&&(i.shape===a&&(s.keepPagination=Boolean(t)),i.delayClearData?(this._clearDataPending=!0,s.clearDataPending=!0):this._clear(),e&&N(this,c,s),!0)},getTotalRecords:function(e){let t=this._options;return t.shape===a?this._haveAllData||t.paginationType===v?this._data.length:this._totalRecords<0&&!0!==e?this._totalRecords:Math.max(this._data.length,this._totalRecords):t.shape===d?e&&null===this._data?0:1:t.shape===o?this._index.size:void 0},getServerTotalRecords:function(){const e=this._options;return e.shape===a?this._totalRecords<0?this._totalRecords:this._totalRecords+this._numInsertedRecords-this._numDeletedRecords:e.shape===d?1:e.shape===o?-1:void 0},getDataOverflow:function(){return!!this._dataOverflow},forEach:function(e,t){const i=this._options,n=this._data;if(i.shape===d)throw Y("forEach");if(i.shape===o){let i=0;n&&this.walkTree(n,{node:n=>{j(t,e,n,i,this._getIdentity(n)),i+=1}})}else{const i=n.length;for(let s=0;s<i;s++){let i=n[s];i&&j(t,e,i,s,this._getIdentity(i,s))}}},transform:function(e,t){var i,n,s,r,l,a=/^\[\W*([^ \t/]+)\W*]$/,o=e.template,d=e.showNullAs,h=o.length,c=[],u={},f=this;function g(e,t){var i;return(i=e[t])||(i={values:{},paths:[]},e[t]=i),i}function _(e,t,i,n,s,r){var l,o,d,h,c,u,f,_;if(e){for(c=e.split("/"),u=n,f=null,_=null,d=null,l=0;l<c.length;l++){if(d=c[l],o=a.exec(d)){g(r,o[1]).paths[t]=c.slice(l+1).join("/");break}f=u,_=d,k(u,d)||(u[d]={}),u=u[d]}f?(D(f[_])?(h=f[_]).length=0:h=[],f[_]=h):h=n,s[t]=h}else{if(!D(n))throw new Error("Context must be an array when there is no path");s[t]=n}i&&g(r,i)}function p(e,i,n,s){var r,l,a,o,h=!1;return"string"==typeof e?(r=e.length,a=e.charAt(0),o=e.charAt(r-1),"'"===a&&"'"===o?e.substring(1,r-1):("("===a&&")"===o&&(e=e.substring(1,r-1),h=!0),null!==(l=f.getValue(i,e))&&"object"==typeof l&&k(l,"d")&&(l=h?l.v:l.d),h||!d||null!==l&&""!==l||(l=d),l)):K(e)?e.call(t,f,i,n,s):null===e?e:D(e)?function(e,t,i,n,s){var r,l;for(r=0;r<e.length;r++)void 0!==(l=p(e[r],i,n,s))&&(t[r]=l);return t}(e,[],i,n,s):"object"==typeof e?function(e,t,i,n,s){var r,l;for(r in e)k(e,r)&&void 0!==(l=p(e[r],i,n,s))&&(t[r]=l);return t}(e,{},i,n,s):void 0}function y(e,t,i,n){var s,r,l,o=[];if(e)for(e=e.split("/"),s=0;s<e.length;s++)r=e[s],(l=a.exec(r))&&o.push({key:l[1],value:p(l[1],t,i,n)});return o}function I(i,n,s){var a,d,I,m,v,R,x,w,M,b,k;if(!(n<r||l>0&&n>=r+l)&&(e.includeAggregates||!f._metaKey||!i[f._metaKey].agg)&&(!e.filter||e.filter.call(t,f,i,n,s)))for(a=0;a<h;a++)if(R=null,I=o[a],m=c[a],!I.filter||I.filter.call(t,f,i,n,s)){if(I.uniqueIndexField&&(R=u[I.uniqueIndexField],x=p(I.uniqueIndexField,i,n,s),void 0!==R.values[x]))continue;if(void 0!==(v=p(I.item,i,n,s))){if(R)R.values[x]={index:m.length,arrays:[],indexes:{}};else for(w=y(I.path,i,n,s),k=u,d=0;d<w.length;d++)void 0===(M=(R=g(k,w[d].key)).values[w[d].value])&&(M={index:m.length,arrays:[],indexes:{}},b=""===R.paths[a]?[]:{},m.push(b),R.values[w[d].value]=M),b=m[M.index],M.arrays[a]||_(R.paths[a],a,null,b,M.arrays,M.indexes),m=M.arrays[a],k=M.indexes;m.push(v)}}}for(null!==t&&"object"==typeof t||(t={}),function(){var e,i;for(e=0;e<o.length;e++)_((i=o[e]).path,e,i.uniqueIndexField,t,c,u)}(),r=0,e.offset>=0&&(r=e.offset),l=e.fetchData?this._options.pageSize:null,e.count>0&&(l=e.count),e.fetchData?this.forEachInPage(r,l,I):this.forEach(I),i=0;i<h;i++)n=o[i],s=c[i],n.sort&&s.array.sort(n.sort);return t},forEachInPage:function(e,t,n,s){const r=this,l=this._options,o=this._data;let d,h,c=e;function u(l){const a=t-(l-e);let o,d;i.trace("Model: "+r.modelId()+". forEachInPage fetching more data starting at: ",l),r._waitingPages.push({offset:l,callback:n,thisArg:s,next:function(){r.forEachInPage(l,a,n,s)}}),r._requestsInProgress.fetch||(d=r.fetch(l,(function(e){e||setTimeout((function(){r._waitingPages.length>0&&(o=r._waitingPages.shift(),o.next())}),1)})),d||(r._waitingPages.pop(),j(s,n,null,-1,null)))}if(l.shape!==a)throw Y("forEachInPage");if(t>l.pageSize&&(l.pageSize=10*Math.floor((t+9)/10)),l.paginationType===m&&(c=e-this._offset),this._clearDataPending)u(e);else if(c<0||c>=o.length)this._haveAllData?(j(s,n,null,-1,null),this._drainWaiters()):u(e);else{d=c+t,h=e;for(let e=c;e<d;e++){let t,i=o[e];if(void 0===i)return void(this._haveAllData&&e>=o.length?(j(s,n,null,-1,null),this._drainWaiters()):u(e+this._offset));i&&(void 0!==o[e+1]||this._haveAllData&&e+1>=o.length||(t=!1),j(s,n,i,h,this._getIdentity(i,e),t),h+=1)}this._drainWaiters()}},indexOf:function(e){const t=this._options.shape;if(t===d)throw Y("indexOf");if(e&&void 0!==this._identityKeys){let i=this.getRecordMetadata(this._getIdentity(e));if(t===o)return i&&i.parent?i.parent[this._childrenKey].indexOf(e):-1;if(i)return i.index}return this._data.indexOf(e)},recordAt:function(e){if(this._options.shape!==a)throw Y("recordAt");return this._data[e]||null},getRecordId:function(e){return this._getIdentity(e)},getControlBreakId:function(e){let t=null;if(this._controlBreakKeys?.length>0){t="";for(let i=0;i<this._controlBreakKeys.length;i++){let n=e[this._controlBreakKeys[i]];n?.v&&(n=n.v),t.length>0&&(t+="|"),t+=n}}return t},hasControlBreaks:function(){return Boolean(this._controlBreakKeys)},getControlBreaks:function(e){if(!this._controlBreakKeys)return null;const t=(e,t)=>({id:e,firstId:t.firstId,lastId:t.lastId,firstIndex:t.firstId?this.getRecordMetadata(t.firstId)?.index:null,lastIndex:t.lastId?this.getRecordMetadata(t.lastId)?.index:null});if(e){const i=this._controlBreaksMap.get(e);return i?t(e,i):null}let i=[];for(const[e,n]of this._controlBreaksMap)i.push(t(e,n));return i.sort(((e,t)=>e.firstIndex-t.firstIndex)),i},getAggregateRecord:function(e,t){let i,n,s,r,l=null;if(null!=t){if(s=this._controlBreaksMap.get(t)?.lastId,s&&(i=this.indexOf(this.getRecord(s))),i>=0)for(r=!1;i<this._data.length;i++)if(l=this._data[i],n=l[this._metaKey],n&&n.agg){if(r=!0,n.agg===e)break}else if(r){l=null;break}}else for(i=this._data.length-1;i>=0;i--){if(l=this._data[i],n=l[this._metaKey],!(n&&n.agg&&n.grandTotal)){l=null;break}if(n.agg===e)break}return l},isIdentityField:function(e){return void 0!==this._identityKeys&&this._identityKeys.includes(this.getFieldKey(e))},getRecordMetadata:function(e){const t=this._options;let i,n;return n=e||t.shape!==d?U(e):t.identityField?this.getRecordId(this._data):"0",i=this._index.get(n),i||null},metadataChanged:function(e,t=null,i=null){let n=this._index.get(U(e));n&&N(this,"metaChange",{record:n.record,recordId:e,field:t,property:i})},getTypeMetadata:function(e){return this._options.types[e]||null},getFieldMetadata:function(e){return this._options.fields[e]||null},getFieldKey:function(e){const t=this._options;if(k(t.fields,e)&&!t.fields[e].virtual)return t.recordIsArray?t.fields[e].index:e},isChanged:function(){let e=0;if(0===this._changes.length)return!1;for(let t=0;t<this._changes.length;t++){let i=this._changes[t];i.autoInserted&&!i.updated||(e+=1)}return e>0},getChanges:function(){return this._changes},clearChanges:function(){this._clearChanges("_changes")},hasErrors:function(){return this._errors.length>0},getErrors:function(){return this._errors},setHiddenState:function(e,t){let i=this.getRecordMetadata(e);i&&i.hidden!==t&&(i.hidden=t,this.metadataChanged(e,null,"hidden"))},updateVisibility:function(e=null){const t=this._options,i=t.visibilityFilter;if(i){null!==e&&(t.visibilityFilterContext=e);let n=this,s=t.visibilityFilterContext;if(null===s)return;if(t.shape===o){let e=[];n.walkTree(n.root(),{node:function(t){if(!1===n.hasChildren(t)){let r=i(n,t,s);n.setHiddenState(n.getRecordId(t),!r),r&&(e[e.length-1]=r)}},beginChildren:function(){e.push(null)},endChildren:function(t){let r=!1,l=e.pop();0===e.length&&(r=!0,l=!0),null===l&&(l=i(n,t,s)),n.setHiddenState(n.getRecordId(t),!l),l&&!r&&(e[e.length-1]=l)}},null)}else t.shape===a&&n.forEach((function(e,t,r){let l=i(n,e,s);n.setHiddenState(r,!l)}))}},setDisabledState:function(e,t){let i=this.getRecordMetadata(e);i&&i.disabled!==t&&(i.disabled=t,this._numDisabledRecords+=t?1:-1,this.metadataChanged(e,null,"disabled"))},setSelectionState:function(e,t,i="set"){let n,s,r,l;const a=(e,t)=>!t.agg&&!this.isDisabled(e,t),o=(e,t)=>{let i=!1;for(let l=e;l<t;l++)r=this._data[l],r?(n=this._getIdentity(r,l),s=this._index.get(n),s&&a(r,s)&&(s.sel=!0,this._selection.set(n,s))):i=!0;return i};if("all"===i)l=o(0,this.getTotalRecords(!0)),l&&(this._selectRange=[]),this._selectAll=!0;else if("anchor"===i&&null==e)this._selectAnchor=null;else if(n=U(e),s=this._index.get(n),s){if(t=!!t,this._selectAll&&(this._selectAll=!1,["set","range"].includes(i)&&this.clearSelection()),"range"===i){let e,t,i=s.index;s=this._index.get(this._selectAnchor),s&&(t=s.index,i>t&&(e=i,i=t,t=e),l=o(i,t+1),l&&(this._selectRange=[i,t]))}else"anchor"===i?a(s.record,s)&&(this._selectAnchor=n):(a(s.record,s)&&(s.sel!==t&&(s.sel=t,t?this._selection.set(n,s):this._selection.delete(n)),this._selectAnchor=n),"toggle"!==i&&(this._selectRange=null));if(!this._selectAll){let e=this._index.size-this._numAggregateRecords-this._numDisabledRecords;this.getSelectedCount()===e&&(this._selectAll=!0)}}},clearSelection:function(){for(const e of this._selection.values())e.sel=!1;this._selection.clear(),this._selectAll=!1,this._selectRange=null},getSelectedCount:function(){return this._selection.size},getSelectedRecords:function(){return[...this._selection.values()].sort(((e,t)=>e.index-t.index)).map((e=>e.record))},getSelectionState:function(){return{selectAll:this._selectAll,incomplete:null!=this._selectRange,rangeAnchor:this._selectAnchor}},allowEdit:function(e){return this.check("canEdit",e)},allowDelete:function(e){const t=this._options;if(t.shape===d||t.shape===o&&e===this._data)return!1;if(t.shape===o){let t=!0,i=!1;if(this.walkTree(e,{node:e=>{if(i&&t&&(this.check("canDelete",e)||(t=!1)),!t)return!0},beginChildren:()=>{i=!0}}),!t)return!1}return this.check("canDelete",e)},allowAdd:function(e,t,i){const n=this._options;let s,r,l;if(n.shape===d)return!1;if(!(n.shape!==o||e&&e[this._childrenKey]))return!1;if(r=this.check("canAdd",e,t,i),r&&i&&n.shape===o&&(l=this._getType(e),s=void 0!==l.validChildren?l.validChildren:void 0===n.types.default.validChildren||n.types.default.validChildren,!0!==s))for(let e=0;e<i.length;e++)if(!s.includes(i[e][this._typeKey])){r=!1;break}return r},allowDrag:function(e){return this._options.shape!==d&&this.check("canDrag",e)},dragOperations:function(e){const t=this._options;let i,n;if(e){if(e.length>0&&this._typeKey){n=e[0][this._typeKey]||"default";for(let t=1;t<e.length;t++)if((e[t][this._typeKey]||"default")!==n){n="default";break}}else n="default";i=t.types[n].operations&&void 0!==t.types[n].operations.drag?t.types[n].operations.drag:t.types.default.operations.drag}else i=t.types.default.operations.externalDrag;return i},check:function(e,t,i,n){const s=this._options,r=this._getType(t);let l,a=!1;if(!s.editable||this._masterRecordIsDeleted||this._clearDataPending)return!1;if(t&&(l=this.getRecordMetadata(this._getIdentity(t)),l)){if(l.deleted||l.agg)return!1;if(l.inserted&&("canEdit"===e||"canDelete"===e))return!0}return l&&void 0!==l[e]?a=l[e]:r.operations&&void 0!==r.operations[e]?a=r.operations[e]:void 0!==s.types.default.operations[e]&&(a=s.types.default.operations[e]),K(a)&&(a=a.call(this,t,i,n)),K(s.check)&&(a=s.check(a,e,t,i,n)),a},isDisabled:function(e,t){const n=this._options,s=this._getType(e);let r=!1;return t?t.record!==e&&i.warn("Model: incorrect metadata or duplicate record id detected:",this.getRecordId(e)):t=this.getRecordMetadata(this.getRecordId(e)),null!=t.disabled?r=t.disabled:void 0!==s.isDisabled?r=s.isDisabled:void 0!==n.types.default.isDisabled&&(r=n.types.default.isDisabled),r},getValue:function(e,t){return void 0===t&&(t=e,e=this._data),e[this.getFieldKey(t)]},setValue:function(e,t,n,s){var r,l,a,d,h,c,u,f,g,_,p,I,m,v=this._options,R=!1;if(void 0===n&&(n=t,t=e,e=this._data),a=this.getFieldKey(t),!this.allowEdit(e))throw new Error("Set value not allowed for record");if(u=this._getIdentity(e),!(d=this.getRecordMetadata(u)))return null;if(m=v.fields[t],void 0===a||m.readonly&&!m.parentField||d.fields&&d.fields[t]&&d.fields[t].ck)throw new Error("Set value not allowed for field");if(this._controlBreakKeys?.includes(a)&&i.warn("Setting value of a control break field."),l=e[a],!A(l,n)){if(!s&&(t===v.sequenceField||t===v.parentIdentityField))if(f=g=_=null,t===v.sequenceField){if(v.shape===o?(g=this.parent())&&(f=g[this._childrenKey]):f=this._data,f){let t=parseFloat(n);for(r=0;r<f.length&&!(parseFloat(f[r][this._sequenceKey])>t);r++)_=f[r];_===e&&(_=null)}}else t===v.parentIdentityField&&(g=this.getRecord(n));if(d.original||(d.original=function(e){let t,i;if(D(e))for(i=[],t=0;t<e.length;t++)i[t]=E(e[t]);else for(t in i={},e)k(e,t)&&(i[t]=E(e[t]));return i}(e),R=!0),e[a]=n,(c=this._getIdentity(e))!==u){if(this._index.has(c))return e[a]=l,R&&delete d.original,"DUP";d.originalId||(d.originalId=u),this._index.delete(u),this._index.set(c,d),d.sel&&(this._selection.delete(u),this._selection.set(c,d))}return d.updated||d.deleted||d.inserted||this._addChange(d),v.trackChanges&&(d.updated=!0),d.fields||(d.fields={}),(h=d.fields[t])||(h={},d.fields[t]=h),v.trackChanges&&(h.changed=!0),(d.error||d.warning)&&this.setValidity("valid",c),N(this,y,{oldValue:l,oldIdentity:c!==u?u:null,recordId:c,record:e,field:t}),this._checkAggregates(t),(p=this._dependentFields[t])&&(m.calcValue&&((I={})[t]=1),ie(this,d,p,!0,I)),(g||_)&&this.moveRecords([e],g,_),"SET"}return"NC"},getRecordValue:function(e,t){return this.getValue(this.getRecord(e),t)},setRecordValue:function(e,t,i){this.setValue(this.getRecord(e),t,i)},setValidity:function(e,t,i,n){let s,r,l,a,o,d,h,c=this._index.get(U(t));if(c&&(i?(c.fields||(c.fields={}),r=c.fields[i],r||(r={},c.fields[i]=r)):r=c,o="valid",d=r.message||n,r.warning&&(o="warning"),r.error&&(o="error"),e!==o||d!==n)){switch(h="message",e){case"error":s="error",delete r.warning;break;case"warning":s="warning",delete r.error;break;case"valid":delete r.error,delete r.warning,delete r.message;break;default:throw new Error("Invalid value for pValidity parameter: "+e)}if(e!==o&&("valid"!==o&&(h+=","+o),s&&(h+=","+s)),s&&(r[s]=!0,r.message=n),l=c.error,!l&&c.fields)for(let e in c.fields)if(k(c.fields,e)&&c.fields[e].error){l=!0;break}l?(a=this._errors.indexOf(c),a>=0&&this._errors.splice(a,1),this._errors.push(c)):this._removeError(c),this.metadataChanged(t,i,h)}},deleteRecords:function(e){const t=this._options,n=[],s=[],r=[];let l=-1;if(t.shape===d)throw Y("deleteRecords");for(let s=0;s<e.length;s++){let r=e[s],l=this._getIdentity(r);this.getRecordMetadata(l)?this.allowDelete(r)?t.shape===o?this.walkTree(r,{postNode:e=>{n.push(e)}}):n.push(r):i.warn("Delete not allowed for record: "+l):i.warn("Record to delete not found: "+l)}for(let e=0;e<n.length;e++){const i=n[e],o=this._getIdentity(i),d=this.getRecordMetadata(o);t.shape===a&&(this._numDeletedRecords+=1),t.onlyMarkForDelete&&!d.inserted||(t.shape===a&&d.inserted&&(this._numDeletedRecords-=1,this._numInsertedRecords-=1),this._removeRecord(o,d),t.shape===a&&(-1===l||d.index<l)&&(l=d.index)),d.inserted?(delete d.inserted,delete d.autoInserted,delete d.updated,this._removeError(d),this._removeChange(d)):(L(d,!0),this._removeError(d),t.trackChanges&&(d.deleted=!0),this._addChange(d)),s.push(i),r.push(o)}return l>=0&&this._resequenceServerOffset(l),s.length>0&&(N(this,_,{records:s,recordIds:r}),this._checkAggregates()),s.length},canRevertRecord:function(e){const t=this.getRecordMetadata(this._getIdentity(e));return!(!t||!t.original&&!t.deleted)},revertRecords:function(e){const t=this._options;let n={},s=[],r=[];for(let l=0;l<e.length;l++){let h,c,u=e[l],f=this._getIdentity(u),g=this.getRecordMetadata(f);g?g.original||g.deleted?(t.shape===a?(h=this._data,c=g.index):t.shape===o&&(h=this.parent(g.record)[this._childrenKey],c=h.indexOf(g.record)),g.deleted?(t.shape===a&&(this._numDeletedRecords-=1),delete g.deleted):(g.originalId&&(this._index.set(g.originalId,g),this._index.delete(f),g.sel&&(this._selection.set(g.originalId,g),this._selection.delete(f)),n[f]=g.originalId,delete g.originalId),g.original&&(g.record=g.original,delete g.original),delete g.updated),L(g),this._removeError(g),this._removeChange(g),u=g.record,t.shape!==d&&h[c]!==u&&(h[c]=u),s.push(u),r.push(f)):i.warn("Nothing to revert for record "+f):i.warn("Record to revert not found: "+f)}return s.length>0&&(N(this,f,{records:s,recordIds:r,newIds:n}),this._checkAggregates()),s.length},insertNewRecord:function(e,t,i){const n=this._options;let s,r,l,h,c,u,f=!1,g=!1,_=null;if(n.shape===d)throw Y("insertNewRecord");if(h=this._initRecord(i,null,e),!this.allowAdd(e,"new",[h]))throw new Error("Insert not allowed for new record");if(n.shape===o?(u=e||this._data,c=u[this._childrenKey]):c=this._data,r=0,l=this._getIdentity(h),t){let e;if(_=this._getIdentity(t),e=this.getRecordMetadata(_),e&&(r=n.shape===a?e.index+1:c.indexOf(e.record)+1,this._controlBreakKeys&&e.endControlBreak)){const n=this.getControlBreakId(t);let s=this._controlBreaksMap.get(n);g=!0,i&&n!==this.getControlBreakId(h)?f=!0:(s.lastId=l,delete e.endControlBreak,this._metaKey&&delete t[this._metaKey].endControlBreak)}}else this._controlBreakKeys&&i&&this.getControlBreakId(this.recordAt(0))!==this.getControlBreakId(h)&&(f=!0,g=!0);if(this._sequenceKey){let e=parseFloat(h[this._sequenceKey])||null,[t,i]=G(c,r,this._sequenceKey);h[this._sequenceKey]=""+J(n.sequenceStep,t,i,1,1,e)}if(!i&&this._controlBreakKeys){const e=t||this.recordAt(0);if(e){const t=this.getControlBreakId(e);let i=this._controlBreaksMap.get(t);for(let e=0;e<this._controlBreakKeys.length;e++)h[this._controlBreakKeys[e]]=i.values[e]}else f=!0,g=!0}if(c.splice(r,0,h),s={record:h},n.shape===a&&(this._reindex(r+1),s.index=r),g&&(this._metaKey&&(h[this._metaKey].endControlBreak=!0),s.endControlBreak=!0),f){let e=this.getControlBreakId(h),t={values:this._controlBreakKeys.map((e=>h[e])),firstId:l,lastId:l};this._controlBreaksMap.set(e,t)}return n.trackChanges&&(s.inserted=!0),this._index.set(l,s),this._addChange(s),n.shape===o?s.parent=u:this._numInsertedRecords+=1,ne(this,s),N(this,"insert",{record:h,recordId:l,insertAfterId:_}),l},moveRecords:function(e,t,n){let s,r,l,a,h,c,u,f,g,_,p,y=this._options,I=[],m=[],v=null;if(y.shape===d)throw Y("moveRecords");y.shape===o?(t||(t=this._data),l=t[this._childrenKey]):l=this._data,r=0,n&&(v=this._getIdentity(n),s=this.getRecordMetadata(v),s&&(r=l.indexOf(s.record)+1),(!s||r<0)&&(i.warn("AfterRecord not found, move to beginning."),r=0)),this._sequenceKey&&([f,g]=G(l,r,this._sequenceKey)),p=0,_=this._data.length;for(let n=0;n<e.length;n++)if(c=e[n],u=this._getIdentity(c),s=this.getRecordMetadata(u),s){if(y.shape===o){if(a=this.parent(c),!a){i.warn("Move not allowed for root");continue}a=a[this._childrenKey]}else a=l;if(h=a.indexOf(c),y.shape!==o&&(h>p&&(p=h),h<_&&(_=h)),a.splice(h,1),l===a&&h<r&&(r-=1),m.push(c),I.push(u),l.splice(r,0,c),y.shape!==o&&(r>p&&(p=r),r<_&&(_=r)),r+=1,this._sequenceKey){let t=parseFloat(c[this._sequenceKey])||null;this.setValue(c,y.sequenceField,""+J(y.sequenceStep,f,g,e.length,n+1,t),!0)}y.shape===o&&(s.parent=t,this._parentIdKey&&this.setValue(c,y.parentIdentityField,this._getIdentity(t),!0))}else i.warn("Record to move not found: "+u);return y.shape!==o&&(this._reindex(_,p+1),this._resequenceServerOffset(_)),N(this,"move",{records:m,recordIds:I,insertAfterId:v}),I},copyRecords:function(e,t,n){const s=this,r=this._options;let l,a,h,c,u,f,g,_,p,y,I=[],m=[],v=null;if(r.shape===d)throw Y("copyRecords");r.shape===o?(_={node:function(e,t){if(t){const i=s._getIdentity(e),n={record:e,inserted:!0,parent:t};s._index.set(i,n),s._addChange(n)}}},t||(t=this._data),f=t[this._childrenKey]):f=this._data,a=0,n&&(v=this._getIdentity(n),l=this.getRecordMetadata(v),l&&(a=f.indexOf(l.record)+1),(!l||a<0)&&(i.warn("AfterRecord not found, copy to beginning."),a=0)),this._sequenceKey&&([p,y]=G(f,a,this._sequenceKey));for(let n=0;n<e.length;n++)h=e[n],u=this._getIdentity(h),l=this.getRecordMetadata(u),l?(c=this._initRecord(null,e[n],t),f.splice(a,0,c),this._sequenceKey&&(c[this._sequenceKey]=""+J(r.sequenceStep,p,y,e.length,n+1)),g=this._getIdentity(c),m.push(c),I.push(g),l={record:c,inserted:!0,index:a},this._index.set(g,l),this._addChange(l),r.shape===o?(l.parent=t,this.walkTree(c,_,null)):this._numInsertedRecords+=1,a+=1):i.warn("Record to copy not found: "+u);return this._reindex(a),N(this,"copy",{records:m,recordIds:I,insertAfterId:v}),this._checkAggregates(),I},root:function(){if(this._options.shape!==o)throw Y("root");return this._data},child:function(e,t){const i=e[this._childrenKey];if(i)return i[t]},parent:function(e){if(this._identityKeys){let t=this._getIdentity(e),i=this.getRecordMetadata(t);if(i&&k(i,"parent"))return i.parent?i.parent:null}},childCount:function(e){const t=e[this._childrenKey];return null===t?null:t?t.length:0},hasChildren:function(e){const t=e[this._childrenKey];return null===t?null:!!t&&t.length>0},fetchChildNodes:function(e,t){let i,n,s,r,l,a=this._options,o=S();return l=F({},a.regionData,{id:a.regionId,ajaxIdentifier:a.ajaxIdentifier,fetchData:F({},a.fetchData,{version:a.version,parentId:e?this._getPrimaryKey(e):null})}),s={regions:[l]},a.pageItemsToSubmit&&(s.pageItems=a.pageItemsToSubmit),this._addParentItems(s.regions[0]),r=$(a,this),e&&delete r.loadingIndicator,i=this._callServer(s,r),i.done((t=>{if(this._destroyed)return;let i,n=t.regions[0].fetchedData;if(e){let t=n[this._childrenKey];this._addData(e,null,t),i=t.length}else this._addData(null,null,n.root),i=1;o.resolve(i)})).fail((function(e,t,i){o.reject(H("Error fetching child nodes.",e,0,i))})),n=o.promise(),t&&n.always(t),n},clearChildNodes:function(e){e[this._childrenKey]=null},walkTree:function(e,t,i){let n,s,r,l;if(e&&(void 0===i&&(i=null,n=this._getIdentity(e),n&&(s=this.getRecordMetadata(n),s&&(i=s.parent))),!t.node||(l=t.node(e,i),!l))){if(r=e[this._childrenKey],r&&r.length>0){t.beginChildren&&t.beginChildren(e);for(let i=0;i<r.length;i++)this.walkTree(r[i],t,e);t.endChildren&&t.endChildren(e)}t.postNode&&t.postNode(e,i)}},subscribe:function(e){let t=e.viewId;return t||(t="v::"+w,w+=1,e.viewId=t),this._listeners.push(e),t},unSubscribe:function(e){for(let t=0;t<this._listeners.length;t++)this._listeners[t].viewId===e&&this._listeners.splice(t,1)},getOption:function(e){const t=this._options[e];if(void 0===t)throw new Error("No such option: "+e);return t},setOption:function(e,t){const n=this._options;if(b.has(e)){if("editable"===e&&!n.identityField&&n.shape!==d)throw Q();"trackChanges"===e&&!t&&n.onlyMarkForDelete&&(n.onlyMarkForDelete=!1),"onlyMarkForDelete"===e&&!1===n.trackChanges&&(t&&i.warn(e+" cannot be true when trackChanges is false"),t=!1),n[e]=t}else i.warn("Option cannot be set: "+e)},_callServer:function(e,i){return(this._options.callServer||t.plugin)(e,i)},_drainWaiters:function(e){for(let t=0;t<this._waitingPages.length;t++){let i=this._waitingPages[t];if((this._haveAllData||this._data[i.offset]||e)&&(this._waitingPages.splice(t,1),t-=1,e&&0!==e.status?j(i.thisArg,i.callback,null,-1,null,e):i.next(),this._requestsInProgress.fetch))return}},_getServerOffset:function(e){var t,i,n,s=e-1;for(n=this._data[s];n;){if(t=this._getIdentity(n,s),(i=this.getRecordMetadata(t))&&i.serverOffset>=0)return i.serverOffset+1;s-=1,n=this._data[s]}return e},_clear:function(){let e=this._options;(this._requestsInProgress.fetch||this._requestsInProgress.save)&&i.error("Model cleared during ajax request"),this._haveAllData=!1,this._clearDataPending=!1,e.shape===a?(this._data=[],e.hasTotalRecords?this._totalRecords=0:this._totalRecords=-1,this._offset=0,this._numInsertedRecords=0,this._numDeletedRecords=0,this._numAggregateRecords=0,this._numDisabledRecords=0,this._masterRecordIsInserted&&(this._haveAllData=!0),this._dataOverflow=!1):this._data=null,this._changes=[],this._errors=[],this._index.clear(),this._selection.clear(),this._controlBreaksMap.clear(),this._selectAll=!1,this._selectRange=null,this._selectAnchor=null,this._controlBreakKeys=null;let t=[];for(const[i,n]of Object.entries(e.fields))n.controlBreakIndex>0&&t.push({n:i,i:n.controlBreakIndex});t.sort(((e,t)=>e.i-t.i)),t.length>0&&(this._controlBreakKeys=t.map((e=>this.getFieldKey(e.n))))},_checkClearPending(){this._clearDataPending&&this._clear()},_saveDataState:function(){this._saveState={_data:this._data,_totalRecords:this._totalRecords,_haveAllData:this._haveAllData,_offset:this._offset,_numInsertedRecords:this._numInsertedRecords,_numDeletedRecords:this._numDeletedRecords,_numAggregateRecords:this._numAggregateRecords,_numDisabledRecords:this._numDisabledRecords,_dataOverflow:this._dataOverflow,_changes:this._changes,_errors:this._errors,_index:this._index,_controlBreaksMap:this._controlBreaksMap,_selection:this._selection,_selectAll:this._selectAll,_selectRange:this._selectRange},this._index=new Map,this._selection=new Map,this._controlBreaksMap=new Map},_restoreDataState:function(){const e=this._saveState;this._data=e._data,this._totalRecords=e._totalRecords,this._haveAllData=e._haveAllData,this._offset=e._offset,this._numInsertedRecords=e._numInsertedRecords,this._numDeletedRecords=e._numDeletedRecords,this._numAggregateRecords=e._numAggregateRecords,this._numDisabledRecords=e._numDisabledRecords,this._dataOverflow=e._dataOverflow,this._changes=e._changes,this._errors=e._errors,this._index=e._index,this._controlBreaksMap=e._controlBreaksMap,this._selection=e._selection,this._selectAll=e._selectAll,this._selectRange=e._selectRange},_clearChanges:function(e){const t=[],i=[],n=this._options,s=this[e];let r=-1,l=!1;for(let e=0;e<s.length;e++){const o=s[e],d=this._getIdentity(o.record);o.deleted&&n.onlyMarkForDelete&&(this._removeRecord(d,o),n.shape===a&&(l=!0)),o.deleted?t.push(d):(o.inserted||o.updated)&&(i.push(d),o.inserted&&n.shape===a&&(o.serverOffset=0,l=!0)),l&&(-1===r||o.index<r)&&(r=o.index),delete o.deleted,delete o.recordId,delete o.inserted,delete o.autoInserted,delete o.updated,delete o.original}l&&this._resequenceServerOffset(r),this._totalRecords>=0&&(this._totalRecords+=this._numInsertedRecords,this._totalRecords-=this._numDeletedRecords),this._numInsertedRecords=0,this._numDeletedRecords=0,this[e]=[],N(this,p,{deletedIds:t,changedIds:i})},_reindex:function(e,t){const i=this._data;let n=i.length;null!=t&&t<n&&(n=t);for(let t=e;t<n;t++)if(void 0!==i[t]){let e=this._getIdentity(i[t]);this.getRecordMetadata(e).index=t}},_resequenceServerOffset:function(e=0){const t=this._data;let i,n,s=-1;for(;e>0&&(i=t[e-1],s=this.getRecordMetadata(this.getRecordId(i)).serverOffset,void 0===s);)e-=1;for(let r=e;r<t.length;r++)i=t[r],i?(n=this.getRecordMetadata(this.getRecordId(i)),n.serverOffset>=0&&(s+=1,n.serverOffset=s)):s+=1},_addData:function(e,t,n,s,r,l){const h=this._options,c=this,f=this._calculatedFields.length>0;let g,_,p,y,I,R,x,w,M,b,k,D,C;function K(e,t,i,n){const s={record:n};return c._metaKey&&(F(s,n[c._metaKey]),s.sel=!0===s.sel||"Y"===s.sel,null!=s.disabled&&(s.disabled=!0===s.disabled||"Y"===s.disabled),s.agg&&(!e||c._identityKeys&&!n[c._identityKeys[0]])&&(c._assignTempIdentity(n),e=c._getIdentity(n)),z(s)),null!=t&&(s.serverOffset=t),null!=i&&(s.index=i),s.agg&&(c._numAggregateRecords+=1),s.disabled&&(c._numDisabledRecords+=1),c._index.set(e,s),(s.sel||c._selectAll||c._selectRange&&i>c._selectRange[0]&&i<=c._selectRange[1])&&(s.agg||s.disabled?delete s.sel:(s.sel=!0,c._selection.set(e,s))),h.visibilityFilter&&h.visibilityFilterContext&&(s.hidden=!h.visibilityFilter(c,n,h.visibilityFilterContext)),te(n,h.fields,h.recordIsArray),f&&!s.agg&&ne(c,s),s}function S(e,t,i){let n=0;for(let s=0;s<c._aggregateRecs.length;s++){let r,l,a,o,d=c._aggregateRecs[s];t[d]||(l=c._initRecord(!1),o=c._getIdentity(l),a={agg:d},i&&(a.grandTotal=i),l[c._metaKey]=a,r=e+n,c._data[r]?c._data.splice(r,0,l):c._data[r]=l,K(o,null,r,l),n+=1)}return n}function A(e,t,i,n,s){if(c._data.length>0&&c._haveAllData&&c._aggregateRecs.length>0){if(n){if(t&&t.grandTotal){for(e=c._data.length-1;e>=0&&(i=c._data[e],(t=c._metaKey&&i[c._metaKey])&&t.agg&&t.grandTotal);e--);e+=1}e+=S(e,s),c._reindex(e)}(e=S(c._data.length,s,!0))>0&&c._checkAggregates()}}function T(){if(null!==c._selectRange){let e=c._selectRange[0]+1,t=c._selectRange[1]-1;c._selectAll&&(e=0,t=c.getTotalRecords(!0));for(let i=e;i<t;i++)if(!c._data[i])return;c._selectRange=null}}function O(e,t,i,n){const s=c.getControlBreakId(e);let r,l;null!=s&&(r=c._controlBreaksMap.get(s),r||(r={values:c._controlBreakKeys.map((t=>e[t]))},c._controlBreaksMap.set(s,r)),"start"===n?(l=r.firstId?c.getRecordMetadata(r.firstId):null,(!l||i<l.serverOffset)&&(r.firstId=t)):"end"===n&&(l=r.lastId?c.getRecordMetadata(r.lastId):null,(!l||i>l.serverOffset)&&(r.lastId=t)))}if(h.shape===a?((0===e&&!this.isChanged()||h.paginationType===v)&&this._clear(),h.paginationType===m&&(this._offset=e),this._totalRecords=-1,null!=s?this._totalRecords=s:h.hasTotalRecords&&i.warn("Model missing total records"),this._haveAllData||r||(this._haveAllData=!0),l&&(this._dataOverflow=!0)):h.shape===d&&this._clear(),h.shape===o&&e)i.trace("Model: "+this.modelId()+". add data subtree: ",e),R=e,R[this._childrenKey]=n,h.identityField&&c.walkTree(R,{node:function(e,t){if(t){K(c._getIdentity(e),null,null,e).parent=t}}},null),N(this,u,{parentNode:R,offset:0,count:n.length});else if(null===this._data||0===this._data.length||h.shape!==a||h.paginationType===m){if(i.trace("Model: "+this.modelId()+". add data set: ",e,n?.length,s,r),this._data=n,this._numInsertedRecords=0,this._numDeletedRecords=0,this._numAggregateRecords=0,this._numDisabledRecords=0,h.shape!==d)if(M={offset:0,count:n.length},x=t,h.shape===o&&this.root())h.identityField&&this.walkTree(this.root(),{node:function(e,t){let i,n=c._getIdentity(e);c._metaKey&&e[c._metaKey].agg?w=null:(w=x,x+=1),i=K(n,w,null,e),i.parent=t}},null),M.parentNode=null,M.count=1;else{let e;for(b=!0,D=!1,C={},e=0;e<this._data.length;e++)p=this._data[e],g=this._getIdentity(p,e),_=this._metaKey&&p[this._metaKey],_&&_.agg?(w=null,C[_.agg]=1):(w=x,x+=1,D&&(e+=S(e,C)),D=!1),_&&this._controlBreakKeys&&b&&!_.agg&&(O(p,g,w,"start"),b=!1),_&&_.endControlBreak&&(O(p,g,w,"end"),b=!0,this._aggregateRecs.length>0&&(D=!0,C={})),K(g,w,e,p);A(e,_,p,D,C),T()}else this._data?(this._haveAllData=!0,M={offset:0,count:1},K(this._getIdentity(this._data),null,null,this._data)):(this._haveAllData=!0,M={offset:0,count:0});N(this,u,M)}else{let l;for(b=!0,i.trace("Model: "+this.modelId()+". add data merge: ",e,n?.length,s,r),y=e,x=t,k=[],D=!1,C={},l=0;l<n.length;l++){if(p=n[l],g=this._getIdentity(p,y),_=this._metaKey&&p[this._metaKey],_&&_.agg?(w=null,C[_.agg]=1):(w=x,x+=1),I=this.getRecordMetadata(g),I){if(I.updated||I.inserted||I.deleted)continue;this._data[I.index]=p,te(p,h.fields,h.recordIsArray),I.record=p,x-=1,_&&F(I,_),k.push(g),f&&!I.agg&&ne(this,I)}else this._data[y]?this._data.splice(y,0,p):this._data[y]=p,K(g,w,y,p),y+=1;_&&(_&&this._controlBreakKeys&&b&&!_.agg&&(O(p,g,w,"start"),b=!1),_.agg||(D&&(y+=S(y,C)),D=!1),_.endControlBreak&&(O(p,g,w,"end"),b=!0,this._aggregateRecs.length>0&&(D=!0,C={})))}A(l,_,p,D,C),T(),M={offset:e,count:y-e},k.length&&(M.replacedIds=k),N(this,u,M)}},_updateData:function(e,t){const i=this._options,n=[],s=[],r=[],l=[],a={},o=t||this._metaKey;let d=!1,h=-1;for(let d=0;d<e.length;d++){const c=e[d],u=c[o];let f,g,_=u?u.recordId:null;if(u&&_&&u.notFound)f=this.getRecordMetadata(_),this._removeRecord(_,f),r.push(f.record),l.push(_),(-1===h||f.index<h)&&(h=f.index);else if(g=this._getIdentity(c),_===g&&(_=null),f=this.getRecordMetadata(_||g),f){if(_&&(a[_]=g,this._index.set(g,f),this._index.delete(_),this._selection.delete(_),f.sel&&this._selection.set(g,f),(-1===h||f.index<h)&&(h=f.index),f.serverOffset=0,this._controlBreakKeys))for(const[,e]of this._controlBreaksMap)e.lastId===_&&(e.lastId=g),e.firstId===_&&(e.firstId=g);n.push(c),s.push(_||g),this._data[f.index]=c,te(c,i.fields,i.recordIsArray),f.record=c,o&&u?(F(!0,f,u),f.highlight&&void 0===u.highlight&&delete f.highlight,z(f),delete f.recordId):t&&(i.recordIsArray?c.splice(t,1):delete c[t]),i.visibilityFilter&&i.visibilityFilterContext&&(f.hidden=!i.visibilityFilter(this,c,i.visibilityFilterContext)),ne(this,f),delete f.deleted,delete f.inserted,delete f.autoInserted,delete f.updated,delete f.original,L(f),this._removeError(f),this._removeChange(f)}}h>=0&&this._resequenceServerOffset(h),n.length>0&&(N(this,g,{records:n,recordIds:s,newIds:a}),d=!0),r.length>0&&(this._totalRecords>=r.length&&(this._totalRecords-=r.length),N(this,_,{records:r,recordIds:l}),d=!0),d&&this._checkAggregates()},_initRecord:function(t,i,n){const s=this._options;let r,l,a,d,h=!0;if(t)l=t;else{!1===t&&(h=!1),l=s.recordIsArray?[]:{};for(let t in s.fields)if(k(s.fields,t)){let n,r,o=s.fields[t],c=s.recordIsArray?o.index:t;if(!o.virtual)if(!i||o.noCopy){if(o.parentField&&s.parentModel&&(a||(a=e.get(s.parentModel),a&&!d&&s.parentRecordId&&(d=a.getRecord(s.parentRecordId))),d)){l[c]=a.getValue(d,o.parentField);continue}n="",h&&(r=o.defaultValue,void 0!==r&&(n="function"==typeof r?r(this,i):r)),c!==this._metaKey&&(l[c]=n)}else this._identityKeys.includes(c)||(l[c]=i[c])}}if(a&&e.release(s.parentModel),this._identityKeys&&this._assignTempIdentity(l),this._metaKey&&void 0===l[this._metaKey]&&(l[this._metaKey]={}),s.shape===o&&(this._parentIdKey&&(l[this._parentIdKey]=this._getIdentity(n)),r=[],l[this._childrenKey]=r,i)){let e=i[this._childrenKey];if(e)for(let t=0;t<e.length;t++)r.push(this._initRecord(null,e[t],l))}return l},_assignTempIdentity:function(e){for(let t=0;t<this._identityKeys.length;t++)e[this._identityKeys[t]]||(e[this._identityKeys[t]]=this._options.genIdPrefix+P(this.name))},_getIdentity:function(e,t){let i=null;if(void 0!==this._identityKeys)if(1===this._identityKeys.length)i=e[this._identityKeys[0]]+"";else{i=[];for(let t=0;t<this._identityKeys.length;t++)i.push(e[this._identityKeys[t]]+"")}else null!=t?i=t+"":this._options.shape===d&&(i="0");return null!==i?U(i):i},_getPrimaryKey:function(e){let t;if(void 0!==this._identityKeys){t=[];for(let i=0;i<this._identityKeys.length;i++)t.push(e[this._identityKeys[i]]+"")}return t},_getType:function(e){let t="default",i=this._options;return e&&void 0!==this._typeKey&&(t=e[this._typeKey],null!==t&&q(t)&&(t=t.v),t||(t="default")),i.types[t]||i.types.default},_getRecordById:function(e){let t=this._index.get(U(e));return t?t.record:null},_removeRecord:function(e,t){const i=this._options;let n,s,r;if(i.shape===a?(n=this._data,r=t.index):i.shape===o&&(n=t.parent[this._childrenKey],r=n.indexOf(t.record),delete t.parent),this._controlBreakKeys&&t.endControlBreak){let e=n[r-1],i=this.getControlBreakId(t.record);if(e&&i===this.getControlBreakId(e)){let t=this.getRecordId(e),n=this.getRecordMetadata(t);this._controlBreaksMap.get(i).lastId=t,n.endControlBreak=!0,this._metaKey&&(e[this._metaKey].endControlBreak=!0)}else this._controlBreaksMap.delete(i)}n.splice(r,1),this._reindex(r),s=U(e),this._index.delete(s),t.sel&&this._selection.delete(s)},_addChange:function(e){if(!this._options.trackChanges)return;let t=this._changes.indexOf(e);t>=0&&this._changes.splice(t,1),this._changes.push(e)},_removeChange:function(e){if(!this._options.trackChanges)return;let t=this._changes.indexOf(e);t>=0&&!e.deleted&&!e.updated&&!e.inserted&&this._changes.splice(t,1)},_removeError:function(e){let t=this._errors.indexOf(e);t>=0&&this._errors.splice(t,1)},_addParentItems:function(t){var i,n,s,r,l,a,o={values:[]},d=this._options;if(d.parentModel&&d.parentRecordId){for(i in d.fields)k(d.fields,i)&&(n=d.fields[i]).parentField&&(s||(s=e.get(d.parentModel))&&!r&&(r=s.getRecord(d.parentRecordId),a=s.getRecordMetadata(d.parentRecordId)),r&&(l={n:n.parentField,v:s.getValue(r,n.parentField)},o.values.push(l)));a&&(a.salt&&(o.salt=a.salt),a.protected&&(o.protected=a.protected)),s&&e.release(d.parentModel),t.parentRecordId=d.parentRecordId,o.values.length>0&&(t.parentItems=o)}},_updateAggregates:function(){var e,t,i,n,s,l,a=this._options.fields,o=[];if(!(this._staleAggFields.length<=0)){for(e=0;e<this._staleAggFields.length;e++)for(i=a[n=this._staleAggFields[e]],t=0;t<i.aggregates.length;t++)"string"==typeof(s=i.aggregates[t])&&(s=se[s]),(l={name:s.name,fieldName:n,key:this.getFieldKey(this._staleAggFields[e]),state:{dataType:i.dataType,formatMask:i.formatMask},agg:s}).agg.init(l.state),o.push(l);this.forEach((function(e,t,i){var n,s,a,d=this.getRecordMetadata(i);for(n=0;n<o.length;n++)if(l=o[n],d.agg){if(d.agg===l.name){let t=l.state.dataType,n=l.state.formatMask;a=e[l.key],s=l.agg.get(l.state,!d.grandTotal)+"",s="NUMBER"===t&&n?r.formatNumber(s,n):""+s,e[l.key]=s,N(this,y,{oldValue:a,oldIdentity:null,recordId:i,record:e,field:l.fieldName})}}else d.deleted||(s=e[l.key],l.agg.add(l.state,s))}),this),this._staleAggFields=[]}},_checkAggregates:function(e){if(e)this._aggregatedFields[e]&&this._staleAggFields.indexOf(e)<0&&(this._staleAggFields.push(e),this._debouncedUpdateAggregates());else for(let e in this._aggregatedFields)k(this._aggregatedFields,e)&&this._checkAggregates(e)},_recalculate:function(e){this.forEach((function(t,i,n){const s=this.getRecordMetadata(n);s.agg||ie(this,s,e,!0)}),this)}},le={shape:a,recordIsArray:!1,hasTotalRecords:!1,genIdPrefix:"t",regionId:null,ajaxIdentifier:null,pageItemsToSubmit:null,regionData:{},fetchData:{},saveData:{},requestOptions:{},version:1,parentModel:null,parentRecordId:null,editable:!1,trackChanges:!0,onlyMarkForDelete:!0,identityField:null,typeField:null,childrenField:null,parentIdentityField:null,sequenceField:null,metaField:null,sequenceStep:10,saveSelection:!1,types:{default:{isDisabled:!1,validChildren:!0,operations:{canAdd:!0,canEdit:!0,canDelete:!0,canDrag:!0,drag:{normal:"move",ctrl:"copy"},externalDrag:{normal:"add"}}}},check:null,sortCompare:null,callServer:null,paginationType:v,pageSize:100,preFetch:!1,visibilityFilterContext:null,visibilityFilter:null,delayClearData:!1},ae=new Set([a,o,d]),oe=new Set([v,m,"progressive"]);function de(e){const t=B(e);let i=R[t[0]];return i&&(i=t[1]?i.instances[t[1]]:i.model),i}function he(e,t,i,n){let s=n?B(n):null,r=[];function l(n){let r=!(!i&&!n._options.regionId);return r&&("change"===e?r=n.isChanged():"error"===e&&(r=n.hasErrors()),r&&t&&(r=function(e){let t,i=e,n=B(i.modelId());for(;n;){if(n[0]===s[0]&&(n[1]===s[1]||null===s[1]))return!0;n=null,t=i.getOption("parentModel"),t&&(i=de(t),i&&(n=B(t)))}return!1}(n))),r}function a(e,t){r.push({id:e,model:t})}function o(e,t){e.model&&l(e.model)&&a(t,e.model);for(let i in e.instances)k(e.instances,i)&&l(e.instances[i])&&a([t,i],e.instances[i])}if(s||(t=!1),!t&&s&&s[0]){let e=s[0],t=R[e];t&&(s[1]?t.instances[s[1]]&&l(t.instances[s[1]])&&a([e,s[1]],t.instances[s[1]]):o(t,e))}else for(let e in R)if(k(R,e)){o(R[e],e)}return r}function ce(e){let t=x.indexOf(e);t>=0&&x.splice(t,1)}e.create=function(t,r,h,u,m,w){const b=B(t),C=Object.create(re);let K,S,A,T,O,q,V,P,E,j,z;function U(e,t){const n=K.fields[e];(n.calcValue||n.dependsOn||n.aggregates&&n.aggregates.length>0)&&(i.warn("Model "+t+" field does not support calculations"),delete n.calcValue,delete n.dependsOn)}if(C.name=b[0],C.instance=b[1],C._requestsInProgress={},C._listeners=[],C._waitingPages=[],S=r.fields,C._options=F(!0,{},le,r),C._options.fields=S,K=C._options,!K.fields)throw new Error("The fields option is required");if(!ae.has(K.shape))throw new Error("Invalid shape option: "+K.shape);if(!oe.has(K.paginationType))throw new Error("Invalid paginationType option: "+K.paginationType);if(K.editable&&!K.identityField&&K.shape!==d)throw Q();if(K.shape===o&&!K.childrenField)throw new Error("A tree shaped model requires a childrenField");if(K.shape===a&&K.paginationType===v&&void 0===r.hasTotalRecords&&(K.hasTotalRecords=!0),!K.trackChanges&&K.onlyMarkForDelete&&(r.onlyMarkForDelete&&i.warn("Model forcing onlyMarkForDelete to false"),K.onlyMarkForDelete=!1),C._dependentFields={},C._calculatedFields=[],C._aggregatedFields={},C._aggregateRecs=[],function(e,t,i,r,a){let o,d,h,c,u,f,g,_=[],p={};const y=function(e){const t=e.target.id;C._recalculate(C._dependentFields[":"+t])};for(d in e)if(k(e,d)){if(h=e[d],h.calcValue&&i.push(d),c=h.dependsOn,c)for(let i=0;i<c.length;i++){if(f=c[i],":"===f.substr(0,1)){if(g=f.substr(1),!s(g).node)throw Z(d,g);_.push(g)}else if(!e[f])throw Z(d,f);I=d,t[m=f]||(t[m]=[]),t[m].push(I)}if(h.aggregates){for(let e=0;e<h.aggregates.length;e++){if(o=h.aggregates[e],"string"==typeof o&&!se[o]||"object"==typeof o&&!(o.name&&o.init&&o.add&&o.get))throw new Error(`Field '${d}' has invalid aggregate`);u=o.name||o,p[u]||a.push(u),p[u]=1}r[d]=1}}var I,m;_.length>0&&(C._externalItems$=l(_.map((e=>"#"+n.escapeCSS(e))).join(",")),C._externalItems$.on("change",y),C._externalItemsHandler=y)}(K.fields,C._dependentFields,C._calculatedFields,C._aggregatedFields,C._aggregateRecs),C._staleAggFields=[],C._debouncedUpdateAggregates=n.debounce((function(){C._updateAggregates()}),250),K.identityField)if(D(K.identityField)){C._identityKeys=[];for(let e=0;e<K.identityField.length;e++){if(C._identityKeys.push(C.getFieldKey(K.identityField[e])),void 0===C._identityKeys[e])throw ee("Identity",K.identityField[e]);U(K.identityField[e],"identity")}}else{if(C._identityKeys=[C.getFieldKey(K.identityField)],void 0===C._identityKeys[0])throw ee("Identity",K.identityField);U(K.identityField,"identity")}if(K.typeField){if(C._typeKey=C.getFieldKey(K.typeField),void 0===C._typeKey)throw ee("Type",K.typeField);U(K.typeField,"type")}if(K.childrenField){if(C._childrenKey=C.getFieldKey(K.childrenField),void 0===C._childrenKey)throw ee("Children",K.childrenField);U(K.childrenField,"children")}if(K.parentIdentityField){if(C._parentIdKey=C.getFieldKey(K.parentIdentityField),void 0===C._parentIdKey)throw ee("Parent identity",K.parentIdentityField);U(K.parentIdentityField,"parentIdentity")}if(K.sequenceField){if(C._sequenceKey=C.getFieldKey(K.sequenceField),void 0===C._sequenceKey)throw ee("Sequence",K.sequenceField);U(K.sequenceField,"sequence")}if(K.metaField){if(C._metaKey=C.getFieldKey(K.metaField),void 0===C._metaKey)throw ee("Meta",K.metaField);U(K.metaField,"meta")}if(K.shape!==d?K.identityField?C.getRecord=C._getRecordById:K.shape===a?C.getRecord=C.recordAt:C.getRecord=function(){return null}:C.getRecord=function(){return C._data},C._index=new Map,C._selection=new Map,C._controlBreaksMap=new Map,C._clear(),h?(P=K.paginationType!==v&&(null!=m?m:null==u||h.length<u),C._addData(0,0,h,u,P,w)):(null!=u&&(C._totalRecords=u),K.shape===d&&!1===m&&(C._haveAllData=!0)),K.parentModel&&K.parentRecordId&&!h&&(z=e.get(K.parentModel),z)){j=z.getRecordMetadata(K.parentRecordId),j.inserted&&(C._masterRecordIsInserted=!0,C._clear()),j.deleted&&(C._saveDataState(),C._masterRecordIsDeleted=!0,C._clear(),C._addData(0,0,[],0,!1,!1)),O=C._parentFieldsMap={};for(let e in K.fields)k(K.fields,e)&&(T=K.fields[e],T.parentField&&(O[T.parentField]||(O[T.parentField]=[]),O[T.parentField].push(e)));C.parentModelViewId=z.subscribe({onChange:function(t,i){let n;if(t===_||t===f||t===g||t===p){n=i.recordIds||i.deletedIds;for(let s=0;s<n.length;s++)if(n[s]===K.parentRecordId){if(t===_)C._saveDataState(),C._masterRecordIsDeleted=!0,C._clear(),C._addData(0,0,[],0,!1,!1),N(C,c,{});else if(t!==f&&t!==g||!C._masterRecordIsDeleted)if(t===g&&i.newIds&&i.newIds[C.instance]){const t=i.newIds[C.instance];let n=[];K.parentRecordId=t,e.renameInstance(C.modelId(),t),C.forEach(((e,t,i)=>{let s=C.getRecordMetadata(i);s.autoInserted&&!s.updated&&n.push(s.record)})),n.length&&C.deleteRecords(n)}else t===p&&C._masterRecordIsDeleted&&delete C._saveState;else delete C._masterRecordIsDeleted,C._restoreDataState(),N(C,c,{});break}t===p&&C._masterRecordIsInserted&&delete C._masterRecordIsInserted}else t===y&&(i.oldIdentity||i.recordId)===K.parentRecordId?(q=i.field,q in O&&(A=O[q],V=z.getValue(i.record,q),C.forEach((function(e){let t;if(!C._metaKey||!e[C._metaKey].agg)for(let n=0;n<A.length;n++)t=A[n],i.oldValue===C.getValue(e,t)&&C.setValue(e,t,V)}))),i.oldIdentity&&(K.parentRecordId=i.recordId,e.renameInstance(C.modelId(),i.recordId))):t===c&&C._masterRecordIsDeleted?(delete C._masterRecordIsDeleted,C._restoreDataState(),N(C,c,{})):t===I&&(K.parentModel=null,C.parentModelViewId=null,delete C._masterRecordIsDeleted,delete C._masterRecordIsInserted)},progressView:"m:"+t}),e.release(K.parentModel)}return x.length>=M&&(E=function(){for(let e=0;e<x.length;e++){let t=x[e];if(!t.isChanged())return t}return null}(),E&&(i.info("Model: cache overflow; remove model from cache: "+E.modelId()),e.destroy(B(E.modelId())))),E=R[b[0]],E||(E={instances:{},instancesRef:{}},R[b[0]]=E),b[1]?(E.instances[b[1]]&&(e.destroy(b),R[b[0]]=E),E.instancesRef[b[1]]=1,E.instances[b[1]]=C):(E.model&&(e.destroy(b),R[b[0]]=E),E.modelRef=1,E.model=C),i.info("Model: created model: "+t+" refCount: 1"),C},e.list=function(e,t,i){return he(null,i,e,t).map((e=>e.id))},e._resetTempIds=function(){V.clear()},e._getStats=function(){let e,t,i=[];for(let n in R)if(k(R,n)){const s=R[n],r=s.model;for(t in r&&(e={name:r.name,instance:null,refCount:s.modelRef,cachePos:x.indexOf(r),subscribers:r._listeners.length,progressViews:r._listeners.map((function(e){return e.progressView||null}))},i.push(e)),s.instances)if(k(s.instances,t)){const n=s.instances[t];e={name:n.name,instance:n.instance,refCount:s.instancesRef[t],cachePos:x.indexOf(n),subscribers:n._listeners.length,progressViews:n._listeners.map((function(e){return e.progressView||null}))},i.push(e)}}return i},e.anyChanges=function(e,t,i){return he("change",i,e,t).length>0},e.anyErrors=function(e,t,i){return he("error",i,e,t).length>0},e.addChangesToSaveRequest=function(e,t,i){let n=[],s=he("change",i,!1,t);if(s.length<=0)return null;for(let t=0;t<s.length;t++){let i=s[t].model.addChangesToSaveRequest(e);i&&n.push(i)}return function(e){for(let t=0;t<n.length;t++)n[t](e)}},e.save=function(e,i,n,s,r){let l,a,o,d;if(e=e||{},i=i||{},o=he("change",s,!1,n),l=apex.model.addChangesToSaveRequest(e,n,s),l){if(n&&void 0===i.loadingIndicator&&void 0===i.loadingIndicatorPosition){d=[];for(let e=1;e<o.length;e++)d.push(o[e].model);i.loadingIndicator=W(o[0].model,d)}return a=(r||t.plugin)(e,i),l(a),a}return null},e.multipleFetch=function(e,i,n,s){let r,l=[];if(e=e||{},i=i||{},n.forEach((t=>{let i,n=he(null,!1,!1,t);n.length>0&&(i=n[0].model._addToFetchRequest(e,0),i&&l.push(i))})),l.length>0){r=(s||t.plugin)(e,i);for(let e=0;e<l.length;e++)l[e](r);return r}return null},e.equalModelIds=function(e,t){return"string"==typeof e&&"string"==typeof t?e===t:!(!D(e)||!D(t)||2!==e.length||2!==t.length)&&n.arrayEqual(e,t)},e.get=function(e){const t=B(e),n=R[t[0]];let s,r;return n&&(t[1]?(s=n.instances[t[1]],s&&(r=n.instancesRef[t[1]]+=1)):(s=n.model,s&&(r=n.modelRef+=1)),s&&(ce(s),i.info("Model: get model: "+e+" refCount: "+r))),s},e.renameInstance=function(e,t){const n=B(e),s=n[0],r=n[1],l=R[s];if(l&&r){let e,n=l.instances[r];l.instances[t]&&i.error("Model: Error rename model to one that already exists.",t),n.instance=t,e=l.instancesRef[r],delete l.instances[r],delete l.instancesRef[r],l.instances[t]=n,l.instancesRef[t]=e,i.info("Model: rename model "+s+" instance: "+r+" to "+t),N(n,"instanceRename",{oldInstance:r,newInstance:t})}},e.release=function(t){const n=B(t);let s,r=R[n[0]];r&&(n[1]?r.instancesRef[n[1]]?(s=r.instancesRef[n[1]]-=1,r=r.instances[n[1]]):r=null:(s=r.modelRef-=1,r=r.model),r&&(i.info("Model: release model: "+t+" refCount: "+s),s<=0&&(r._options.parentModel&&de(r._options.parentModel)?(i.info("Model: save in cache model: "+t),function(e){let t=x.indexOf(e);t>=0&&x.splice(t,1),x.push(e)}(r)):r.isChanged()||e.destroy(n))))},e.destroy=function(t){const n=B(t);let s,r=R[n[0]];function l(n){if(n){if(ce(n),n.parentModelViewId){let t=n._options.parentModel,i=e.get(t);i&&(i.unSubscribe(n.parentModelViewId),n.parentModelViewId=null,e.release(t))}n._externalItems$&&n._externalItems$.off("change",n._externalItemsHandler),N(n,I,{}),n._data=null,n._index=null,n._selection=null,n._controlBreaksMap=null,n._destroyed=!0,i.info("Model: destroy model: "+t)}}if(r){if(n[1])l(r.instances[n[1]]),delete r.instancesRef[n[1]],delete r.instances[n[1]];else if(l(r.model),delete r.model,delete r.modelRef,"string"==typeof t&&!n[1])for(s in r.instances)k(r.instances,s)&&(l(r.instances[s]),delete r.instancesRef[s],delete r.instances[s]);0!==Object.keys(r.instances).length||r.model||delete R[n[0]]}},e.getMaxCachedModels=function(){return M},e.setMaxCachedModels=function(e){M=parseInt(e,10)||10},e.initialModelData=function(e){let t=!0;if("string"==typeof e)try{e=JSON.parse(l("#"+e).text())}catch(e){i.error("Failed to parse initial model data.",e),t=!1}return null!=e&&(D(e)||"object"!=typeof e)&&(t=!1),t||(i.error("Invalid model data. Proceeding with no data."),e={values:null}),e};const ue=new Map,fe=apex.WebComponent,ge={modelId:{type:fe.dataTypes.string},recordId:{type:fe.dataTypes.string,default:""},explicitStore:{type:fe.dataTypes.boolean,default:!1},syncWith:{type:fe.dataTypes.string,default:""}};fe._addHyphenCaseAttrNames(ge);const _e=fe._configObservedAttributes(ge),pe=class extends fe{#e=null;#t=null;#i=-1;#n=!1;#s=!1;#r=[];#l=null;#a=null;#o=null;#d=!1;#h=null;#c={modelId:null,recordId:null,explicitStore:null,syncWith:null};constructor(){super(),this._configPrivateState(this.#c);let e=this;this.#h=apex.actions.createContext("modelCursor",this),this.#h.add([{name:"cursor-next",action:function(){e.nextRecord()}},{name:"cursor-previous",action:function(){e.previousRecord()}}])}getModel(){return this.#e}getCurrentRecord(){return this.#t}firstRecord(){let e;if(this.#n){if(e=this.#e.getRecord(),e)return this.recordId=this.#e.getRecordId(e),!0}else if(this.#s);else if(e=this.#e.recordAt(0),e)return this.recordId=this.#e.getRecordId(e),this.#i=0,!0;return!1}nextRecord(){if(this.#n)return!1;let e,t=this.#i;if(this.#s);else if(t<0&&this.#t&&(this.#i=t=this.#e.indexOf(this.#t)),t>=0&&(t+=1,e=this.#e.recordAt(t),e))return this.recordId=this.#e.getRecordId(e),this.#i=t,!0;return!1}previousRecord(){if(this.#n)return!1;let e,t=this.#i;if(this.#s);else if(t<0&&this.#t&&(this.#i=t=this.#e.indexOf(this.#t)),t>=0){if(t-=1,t<0)return!1;if(e=this.#e.recordAt(t),e)return this.recordId=this.#e.getRecordId(e),this.#i=t,!0}return!1}lastRecord(){let e,t=0;if(this.#n){if(e=this.#e.getRecord(),e)return this.recordId=this.#e.getRecordId(e),!0}else if(this.#s);else{let i=this.#e.getTotalRecords(!0);if(i>0&&(t=i-1),e=this.#e.recordAt(t),e)return this.recordId=this.#e.getRecordId(e),this.#i=t,!0}return!1}store(){l(this).trigger("apexbindstore")}subscribe(e,t,i){this.#r.push({field:t,recordId:e,notify:i})}unsubscribe(e,t,i){let n=this.#r.findIndex((n=>n.notify===i&&n.recordId===e&&n.field===t));return n>=0&&this.#r.splice(n,1),0===this.#r.length}attributeChangedCallback(e,t,i){if(super.attributeChangedCallback(e,t,i),"model-id"===e){let e=this.#c.modelId;if(e.startsWith("[")&&e.endsWith("]"))try{e=JSON.parse(e),D(e)&&2===e.length||(e=null)}catch(t){e=null}this.#u(e)}else if("record-id"===e)t!==i&&this.#f(this.#c.recordId);else if("sync-with"===e&&t!==i){let e=apex.region(i),t=this;this.#o&&this.#o.off("interactivegridselectionchange.ig"),e&&"InteractiveGrid"===e.type&&(this.#o=e,e.on("interactivegridselectionchange.ig",n.debounce(((e,i)=>{const n=i.selectedRecords[0];n&&(t.#d=!0,t.recordId=i.model.getRecordId(n))}),100)))}}#u(t){let s=!0,r=!1;const l=(e,t)=>{if(e===c)0===this.#e._data.length&&(this.#t=null);else if(e===I)this.modelId="";else if(e===u){let e=this.#i;this.#f(this.#c.recordId),e>0&&null!==this.#t&&(this.#i=this.#e.indexOf(this.#t))}else if(e===g||e===f)for(let e=0;e<t.recordIds.length;e++){let i=t.recordIds[e];i===this.#c.recordId&&(this.#t=t.records[e]),this.#g(i,null)}else"move"===e||e===p||t.recordIds||"set"!==e&&"metaChange"!==e||this.#g(t.recordId,t.field)};this.#e&&(this.#e.unSubscribe(this.#l),s=D(this.#a)&&D(t)?!n.arrayEqual(this.#a,t):this.#a!==t,s&&(e.release(this.#a),this.#e=null,this.#t=null,r=!0));let a=this.recordId;if(t){s&&(this.#e=e.get(t),this.#e?this.#a=t:(this.#a=null,i.error("Model not found: ",this.#c.modelId)));let n=this.#e,a=n.getOption("shape");if(this.#n=a===d,this.#s=a===o,this.#l=n.subscribe({onChange:l}),r&&this.#c.recordId){let e=this.#n?n.getRecord():n.recordAt(0);e?(this.recordId=n.getRecordId(e),this.#i=0):this.recordId=""}else if(this.#n){let e="";n.getOption("identityField")&&(e=n.getRecordId(n.getRecord())),this.recordId=e}}else r&&this.#c.recordId&&(this.recordId="");this.#c.recordId===a&&this.#f(this.#c.recordId)}#g(e,t){const i=this.#r,n=this.#n;for(let s=0;s<i.length;s++){let r=i[s],l=r.recordId;l||n||(l=this.#c.recordId),!n&&e&&l!==e||t&&r.field!==t||r.notify()}}#f(e){(e||this.#n)&&this.#e?this.#t=this.#e.getRecord(e):this.#t=null,this.#i=-1,this.#g(null,null),this.#o&&(this.#d||this.#o.call("setSelectedRecords",[this.#t],!1,!1),this.#d=!1)}static get observedAttributes(){return _e}static get componentMetaData(){return ge}};apex.gPageContext$.on("apexreadyend",(()=>{customElements.define("a-model-cursor",pe)})),apex.binding.addDataRefType("model",{priority:10,subscribe:function(e,t){if(!e.field||!(e.cursor&&!e.modelId||!e.cursor&&e.modelId&&"string"==typeof e.modelId))return void i.error("Invalid model data reference: ",e);let s=e.cursor;if(!s){const t=e.modelId;if(s=ue.get(t),!s){let e=l(`<a-model-cursor model-id="${n.escapeHTMLAttr(t)}" style="display:none;"></a-model-cursor>`);e.appendTo("body"),s=e[0],ue.set(t,s)}}s.subscribe(e.recordId||null,e.field,t)},unsubscribe:function(e,t){let i=e.modelId,n=i?null:e.cursor;if(n||(n=ue.get(i)),n){n.unsubscribe(e.recordId||null,e.field,t)&&i&&(ue.delete(i),l(n).remove())}},_getCursorFromRef:function(e){let t=e.cursor;return t||(t=ue.get(e.modelId)),t||null},getValue:function(e){const t=this._getCursorFromRef(e),i=t?.getModel();if(!i)return"";let n,s="";return n=e.recordId?i.getRecord(e.recordId):t.getCurrentRecord(),n&&(s=i.getValue(n,e.field)),s},setValue:function(e,t,n,s,r){const l=this._getCursorFromRef(e),a=l?.getModel(),o=e.field;if(!a)return void i.warn("setValue no model",e);let d,h;if("record"!==a.getOption("shape")?(h=e.recordId||e.cursor.recordId,d=a.getRecord(h)):d=a.getRecord(),d){let e,i=a.getValue(d,o);if(null!==i&&"object"==typeof i&&k(i,"v")&&(t={v:t,d:n}),e=a.setValue(d,o,t),"DUP"===e);else{let e=a.getRecordId(d);s.valid?a.setValidity("valid",e,o):a.setValidity("error",e,o,r)}}},parse:function(e,t){let i,n=l(t).closest("[data-bind-model],[data-bind-cursor],a-model-cursor"),s=l(t).closest("[data-bind-record],.a-GV-row[data-id]"),r=s.attr("data-bind-record")||s.attr("data-id"),a=null;return n[0]?(i=n.attr("data-bind-cursor"),i&&(n=l("#"+i)),n.is("a-model-cursor")&&(i=n[0]),a={type:"model",field:e},i?a.cursor=i:a.modelId=n.attr("data-bind-model"),r&&(a.recordId=r),a):a}})}(apex.model,apex.server,apex.debug,apex.util,apex.item,apex.locale,apex.jQuery);