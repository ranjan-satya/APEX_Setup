/*!
 * Copyright (c) 2024, Oracle and/or its affiliates.
 */
!function(){"use strict";const{jQuery:e,da:t,debug:a,ai:s,item:i,util:n,lang:r,server:o}=apex,c="ITEM",l="JAVASCRIPT",p="Consent not granted",u="AI service for dynamic action not enabled";t.openAIAssistant=(o,l,m)=>{const g="DIALOG",b=c,y="a-ChatItem-row--context",d=c,A="ICON_CLASS",C="IMAGE_URL",f="INITIALS",v=r.getMessage("APEX.AI.USE_THIS"),T="chat";let I={aiEnabled:o.action.aiEnabled,welcomeMessage:n.applyTemplate(o.action.aiWelcomeMessage||""),displayAs:o.action.attribute01||g,selector:o.action.attribute03,initialPrompt:{type:o.action.attribute04,item:o.action.attribute05,message:n.applyTemplate(o.action.attribute06||""),actionPrompt:n.applyTemplate(o.action.attribute07||""),javascript:o.action.attribute08},response:{type:o.action.attribute09,item:o.action.attribute10,javascript:o.action.attribute11,buttonLabel:n.applyTemplate(o.action.attribute12||""),detectionJavascript:o.action.attribute13},quickAction:{message1:n.applyTemplate(o.action.attribute14||""),message2:n.applyTemplate(o.action.attribute15||"")},app:l||{},useChatContext:null,chat:{ajaxId:o.action.ajaxIdentifier,processMessage:null},view:{focus:!0,title:o.action.attribute02?n.applyTemplate(o.action.attribute02||""):void 0,quickActions:[]}};if(I.app.aiAvatarType)switch(I.app.aiAvatarType){case A:I.chat.aiUserData={avatar:{iconClasses:I.app.aiIconClasses}};break;case C:I.chat.aiUserData={avatar:{imageUrl:I.app.aiImageUrl}};break;case f:I.chat.aiUserData={avatar:{initials:I.app.aiInitials}}}if(I.app.userAvatarType)switch(I.app.userAvatarType){case A:I.chat.currentUserData={avatar:{iconClasses:I.app.userIconClasses}};break;case C:I.chat.currentUserData={avatar:{imageUrl:I.app.userImageUrl}};break;case f:I.chat.currentUserData={avatar:{initials:I.app.userInitials}}}I.quickAction.message1&&I.view.quickActions.push({title:I.quickAction.message1,message:I.quickAction.message1}),I.quickAction.message2&&I.view.quickActions.push({title:I.quickAction.message2,message:I.quickAction.message2}),I.response.type&&(I.chat.processMessage=(e,t)=>{if(t.user!==e.getAiUser()||t.excludeFromCommits||t.hidden)return;let a=t.fullContent;return I.response.detectionJavascript&&I.response.detectionJavascript instanceof Function&&(a=I.response.detectionJavascript.call(t)),a?{quickActions:[{label:I.response.buttonLabel||v,action:e=>{if(I.response.type===d)i(I.response.item).setValue(a);else if("JAVASCRIPT"===I.response.type&&I.response.javascript&&I.response.javascript instanceof Function){const e=new String(a);e.data={response:a},I.response.javascript.call(e)}e.destroy()}}]}:{}}),m&&m instanceof Function&&(I=m(I)),a.trace("da.openAIAssistant",I);const h=async e=>{let t,a=!1;const s=(t,a)=>{let s=t||"";return s&&(s instanceof Object?(s.cssClasses=y,s.content=s.content||s.fullContent,s.type=s.type||e.constructor.messageTypes.TEXT,s.fullContent&&(s.fullContent=["###",s.fullContent.replaceAll("#","\\#"),"###"].join("\n"))):("string"==typeof s||s instanceof String)&&(s={content:a||s,type:a?e.constructor.messageTypes.HTML:e.constructor.messageTypes.TEXT,cssClasses:y,fullContent:["###",s.replaceAll("#","\\#"),"###"].join("\n")})),s};if(I.initialPrompt.type){let n;if(I.initialPrompt.type===b){const r=i(I.initialPrompt.item),o=!r.isEmpty();n=r.getValue(),a=o&&I.initialPrompt.actionPrompt,o&&(t=s(Array.isArray(n)?n.join(" "):n,I.initialPrompt.message)),a&&await e.addUserMessage({content:I.initialPrompt.actionPrompt,type:e.constructor.messageTypes.TEXT,cssClasses:"a-ChatItem-row--action",fullContent:I.initialPrompt.actionPrompt})}else"JAVASCRIPT_EXPRESSION"===I.initialPrompt.type&&I.initialPrompt.javascript&&I.initialPrompt.javascript instanceof Function&&(t=s(I.initialPrompt.javascript.call(o)),a=!!t.commit);t&&await e.addUserMessage(t),a&&e.commit()}I.welcomeMessage&&!a&&await e.addAiMessage({content:I.welcomeMessage,type:e.constructor.messageTypes.HTML,fullContent:I.welcomeMessage,excludeFromCommits:!0})};I.aiEnabled?s.getUserConsent().then((i=>{i?(async()=>{let a;const i=new s.Chat(I.chat);if(I.displayAs===g)a=i.createDialogView(I.view),await h(i),a.one("dialogclose",(()=>{i.destroy()}));else if("INLINE"===I.displayAs){const t=e(I.selector,apex.gPageContext$).first(),s=t.data(T);s&&(s.destroy(),t.removeData(T)),t.data(T,i),a=i.createInlineView({el:t[0],...I.view}),await h(i)}I.useChatContext&&I.useChatContext instanceof Function&&I.useChatContext.call(o,i,a),t.resume(o.resumeCallback,!1)})():(a.warn(p),t.resume(o.resumeCallback,!0))})):(a.warn(u),t.resume(o.resumeCallback,!0))},t.generateTextAI=function(){const e=this,r=this.action,m=r.attribute01,g=r.attribute02,b=r.attribute03,y=r.attribute04,d=r.attribute05,A=r.attribute06,C="Y"===r.attribute07,f=this.resumeCallback;let v;function T(e){e&&void 0!==e.value&&(y===c?i(d).setValue(e.value,"",C):y===l&&A.call({data:{response:e.value}})),t.resume(f,!1)}function I(e,a,s){t.handleAjaxErrors(e,a,s,f),y===c?i(d).setValue("","",C):y===l&&A.call({error:s})}a.trace("da.generateTextAI",r),r.aiEnabled?s.getUserConsent().then((s=>{if(s){let t;d&&(t="#"+n.escapeCSS(d)),m===c?v=i(g).getValue():m===l?v=b.call(e):"SYSTEM_PROMPT"===m&&(v=""),v&&"string"!=typeof v&&(v=JSON.stringify(v)),o.plugin(r.ajaxIdentifier,{p_clob_01:v},{dataType:"json",loadingIndicator:t,success:T,error:I,async:!0,target:this.browserEvent.target})}else a.warn(p),t.resume(e.resumeCallback,!0)})):(a.warn(u),t.resume(e.resumeCallback,!0))}}();