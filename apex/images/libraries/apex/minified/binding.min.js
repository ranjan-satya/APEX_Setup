/*!
 Copyright (c) 2022, 2023, Oracle and/or its affiliates.
 */
apex.binding=function(e,t,n,i){"use strict";const a="apexBinding",r=Object.values,o=Object.entries,s="none",l="html",c=new Map,u=[],f=new Map,d="item";let p=1;function m(e,t){if(c.has(e))throw new Error("Redefined data reference type: "+e);t._name=e,c.set(e,t),u.push(t),u.sort(((e,t)=>e.priority-t.priority))}function g(e){return new Error("Unknown data reference type: "+e)}function h(e){return new Error("Unknown UI binding type: "+e)}function b(e,t){const n=e.type;if(!c.has(n))throw g(n);c.get(n).subscribe(e,t)}function y(e,t){const n=e.type;if(!c.has(n))throw g(n);c.get(n).unsubscribe(e,t)}function w(e,t){let n=null;for(const i of u)if(n=i.parse(e,t),n)break;return n}m(d,{priority:20,subscribe:function(a,r){const o=a.name,s=i(o);if(!s.node)return void n.error("No such item: ",o);let l=f.get(o);l||(l={subscribers:[],lastValue:s.getValue(),watchId:"bindWatch"+p},p+=1,e(s.node).on("change."+l.watchId,(function(){let e=i(o).getValue();t.equalValue(e,l.lastValue)||(l.lastValue=e,l.subscribers.forEach((e=>{e()})))})),f.set(o,l)),l.subscribers.push(r)},unsubscribe:function(t,n){const a=t.name,r=f.get(a);if(r){const t=i(a);let o=r.subscribers.findIndex((e=>e===n));o>=0&&(r.subscribers.splice(o,1),0===r.subscribers.length&&(e(t.node).off("change."+r.watchId),f.delete(a)))}},getValue:function(e){return i(e.name).getValue()},setValue:function(e,t,n){i(e.name).setValue(t,n)},parse:function(e){if(i.isItem(e))return{type:d,name:e}}});const x=new Map;function v(e,t){if(x.has(e))throw new Error("Redefined binding type: "+e);x.set(e,t)}function E(e){if(!(e&&e instanceof HTMLElement))throw new Error("Invalid binding; missing element")}const V=new Set(["allowfullscreen","async","checked","controls","default","disabled","formnovalidate","inert","ismap","itemscope","loop","multiple","muted","novalidate","open","playsinline","readonly","required","reversed","selected"]),M=["T","t","Y","y","1","F","f","N","n","0"],k=M.slice(5);v("attribute",{validate:function(e){if(E(e.element),!e.attribute||"string"!=typeof e.attribute||0===e.attribute.length)throw new Error("Invalid binding; missing attribute")},key:function(e){return e.type+":"+e.attribute},escapeMode:s,apply:function(t,n){const i=e(t.element);V.has(t.attribute)&&M.includes(n)?k.includes(n)?i.removeAttr(t.attribute):i.attr(t.attribute,""):i.attr(t.attribute,n)}}),v("text",{validate:function(e){E(e.element)},key:function(e){return e.type},escapeMode:s,apply:function(t,n){e(t.element).text(n)}}),v("html",{validate:function(e){E(e.element)},key:function(e){return e.type},escapeMode:l,apply:function(t,n){const i=t.element;let a,r=document.activeElement;e(r).closest(i).length&&(a=r.id),e(i).html(n),a&&e("#"+a).focus()}}),v("visible",{validate:function(e){E(e.element)},key:function(e){return e.type},escapeMode:s,apply:function(t,n){const a=t.element,r=e(a);let o=!1,s=document.activeElement,l=!0;if(e(s).closest(a).length&&(o=!0),(!1===n||""===n||["F","f","N","n","H","h","0"].includes(n))&&(l=!1),o&&!l){let t=e(":tabbable"),n=t.index(a);t.eq(n-1).trigger("focus")}if(a.id&&i.isItem(a.id)){let e=i(a.id);l?e.show():e.hide()}else r.toggle(l)}});let N=!1;var R;v("item-value",{validate:function(e){const t=e.itemName;if(E(e.element),!t||!i.isItem(t))throw new Error("Invalid binding; missing itemName")},key:function(e){return e.type},escapeMode:s,apply:function(e,t){N=!0,i(e.itemName).setValue(t),N=!1},onChange:function(t,n){let a,r,o=i(t.itemName);t.storeElement?(a=e(t.storeElement),r="apexbindstore.uiBinding"):(a=o.element,r="change.uiBinding"),n?a.on(r,(function(){if(!N){let e=i(t.itemName),a=e.getValue(),r=e.getValidity();n(a,e.displayValueFor(a),r,r.valid?"":e.getValidationMessage())}})):a.off(r)}}),e.cleanData=(R=e.cleanData,function(t){let n;for(let i=0;null!=(n=t[i]);i++)e.data(n,a)&&F(n);R(t)});const L=new Map;let I=null,C=[];function T(e,t){for(const n of t)if("model"===n.type){n.cursor&&(e.model=n.cursor.getModel(),e.record=n.cursor.getCurrentRecord());break}}function A(e,t){if(L.has(e))throw new Error("Redefined expression processor: "+e);L.set(e,t),t.default?I=t:t.prefix&&(C.push(t),C.sort(((e,t)=>t.prefix.length-e.prefix.length)))}A("template",{default:!0,extractNames:function(e,n){return t.extractTemplateDependencies(e,n).map((e=>e.name))},process:function(e,n,i,a){return a.defaultEscapeFilter=e!==s&&e.toUpperCase(),T(a,n),t.applyTemplate(i,a)}}),A("assign",{prefix:"=",extractNames:function(e){return[e.replace(/%.*$/,"")]},process:function(e,n,i,a){let r;return T(a,n),r=t.dataValue(i,a),e===l?r=t.escapeHTML(r):"attr"===e&&(r=t.escapeHTMLAttr(r)),r}});const B=new Set,O=new Set;let q=!1;function H(e,t){return!!q&&(!(B.size>0&&!B.has(e))&&!(O.size>0&&!O.has(t)))}function S(e){let t=e.nodeName.toLowerCase();return e.id&&(t+="#"+e.id),e.classList.length>0&&(t+="."+e.classList.value.replaceAll(" ",".")),t}function W(t,i,r){const o=t.type;if(!x.has(o))throw h(o);0===i.length&&n.error("binding with no data refs",t);const s=x.get(o);s.validate(t);const l=s.key(t);if(1===i.length&&s.onChange){let e=i[0],a=e.type;if(!c.has(a))throw g(a);s.onChange(t,((i,r,o,s)=>{let u=c.get(a);H(t.element,l)&&n.log("Write back value: ",l,S(t.element),i),u.setValue(e,i,r,o,s)})),r=function(){return c.get(a).getValue(e)}}let u=0;const f=()=>{u<=0&&(u=1,queueMicrotask((()=>{let e=r(s.escapeMode,i);H(t.element,l)&&n.log("Apply binding value: ",l,S(t.element),e),s.apply(t,e),u=0})))},d={dataRefs:i,listener:f},p=e(t.element);let m,y=p.data(a);y||(y={},p.data(a,y)),m=y[l],m&&D(t),y[l]=d;for(const e of i)b(e,f);s.apply(t,r(s.escapeMode,i))}function D(t){const n=t.type;if(!x.has(n))throw h(n);if(!(t.element&&t.element instanceof HTMLElement))return;const i=e(t.element),r=x.get(n),o=r.key(t);let s,l=i.data(a);if(l&&(s=l[o],s)){r.onChange&&r.onChange(t,null);for(const e of s.dataRefs)y(e,s.listener);delete l[o]}}function F(t){const n=e(t).data(a);if(n)for(const e of r(n))for(const t of e.dataRefs)y(t,e.listener)}function U(e,t,n={}){let i,a=[],r=I;if(t.startsWith("[")){let e,n=t.indexOf("]");n&&(e=t.substring(1,n),L.has(e)&&(r=L.get(e),t=t.substring(n+1)))}else for(const e of C)if(t.startsWith(e.prefix)){r=e,t=t.substring(e.prefix.length);break}i=r.extractNames(t,n);for(const t of i){let n=w(t,e.element);n&&a.push(n)}W(e,a,((e,i)=>r.process(e,i,t,n)))}function j(t){let n=t.querySelectorAll("*");for(const t of n)for(const n of t.getAttributeNames())if(n.startsWith("ab-")){let i,a=t.getAttribute(n),r=n.substring(3);x.has(r)||(i=r,r="attribute");let o={element:t,type:r};if(i&&(o.attribute=i),"item-value"===r&&(o.itemName=t.id),x.get(r).onChange){let n=e(t).closest("[data-bind-cursor],a-model-cursor"),i=n.attr("data-bind-cursor");i=i?e("#"+i)[0]:n[0],i&&!0===i.explicitStore&&(o.storeElement=i)}U(o,a)}}return apex.gPageContext$.on("apexreadyend",(()=>{setTimeout((()=>{j(document.body)}),0)})),{watch:b,unwatch:y,bindExpression:U,bind:W,unbind:D,applyBindings:j,list:function(){let t=[];return e(":data(apexBinding)").each((function(){const n=this,i=e(this).data("apexBinding");for(const[e,a]of o(i))t.push({element:n,type:e,dataRefs:a.dataRefs})})),t},traceOn:function(e=[],t=[]){q=!0,B.clear(),O.clear(),e.forEach((e=>{B.add(e)})),t.forEach((e=>{O.add(e)})),0===n.getLevel()&&n.setLevel(n.LOG_LEVEL.ERROR)},traceOff:function(){q=!1,B.clear(),O.clear()},addDataRefType:m,addBindingType:v,addExpressionProcessor:A}}(apex.jQuery,apex.util,apex.debug,apex.item);