(()=>{var e=class{#e=0;#t={};on(e,t,{priority:s=0,once:i=!1,scope:n}={}){const[r,...a]=e.split(".");r&&(a.length?a.forEach((e=>this.#s(`${r}.${e}`,t,s,n,i))):this.#s(r,t,s,n,i))}one(e,t,{priority:s=0,scope:i}={}){this.on(e,t,{priority:s,scope:i,once:!0})}off(e,t,s){let i,n=arguments.length>2;if(!arguments.length)return void(this.#t={});if(null==e&&null==t&&s){return void Object.keys(this.#t).forEach((e=>{let t=this.#t[e];t=t.filter((e=>e.scope!==s)),t.length?this.#t[e]=t:delete this.#t[e]}))}const[r,...a]=e.split(".");(r||a.length)&&(i=Object.entries(this.#t).filter((([e])=>{const[t,s]=e.split(".");return(!r||r===t)&&(!a.length||a.includes(s))})).map((([e,t])=>({[e]:t}))),i.length&&i.forEach((e=>{const[i,r]=Object.entries(e)[0],a=t?r.filter((e=>{const i=e.callback!==t;return n&&!i?e.scope!==s:i})):[];a.length?this.#t[i]=a:delete this.#t[i]})))}offAllScoped(e){this.off(null,null,e)}triggerEvent(e,...t){const[s,...i]=e.split("."),n=[];s&&(Object.entries(this.#t).filter((([e])=>{const t=e.split(".");return t[0]===s&&(!i?.length||t.some((e=>i.includes(e))))})).forEach((([e,r])=>{r.forEach((r=>{const{callback:a,scope:o,priority:c,once:l}=r;l&&n.push({name:e,fn:a}),a.call(o||this,{type:s,namespace:i||void 0,currentTarget:this,target:this,registered:e,priority:c,callback:a},...t)}))})),n.length&&n.forEach((e=>{this.off(e.name,e.fn)})))}relayEvents(e,t=[],s=""){let i=[];return t.forEach((t=>{const n=(e,...i)=>{this.triggerEvent(`${s}${t}`,...i)};e.on(t,n),i.push({origin:e,eventName:t,fn:n})})),()=>{i.forEach((({origin:e,eventName:t,fn:s})=>{e.off(t,s)})),i=[]}}#s(e,t,s,i,n){this.#t[e]??=[];const r=this.#t[e];r.filter((e=>e.callback===t)).some((e=>e.scope===i))||(this.#e+=1,r.push({callback:t,priority:s,scope:i,once:n,id:this.#e}),r.sort(((e,t)=>0!==e.priority||0!==t.priority?t.priority-e.priority:e.id-t.id)))}},t={TEXT:"text",MARKDOWN:"markdown",HTML:"html"},s={LOAD_COMPLETE:"loadcomplete",LOAD_ERROR:"loaderror",CONTENT_CHANGE:"contentchange",QUICK_ACTIONS_CHANGE:"quickactionschange",CODE_BLOCK_QUICK_ACTIONS_CHANGE:"codeblockquickactionchange",CSS_CLASSES_CHANGE:"cssclasseschange",EXPIRE:"expire"},i="loading",n="loadcomplete",r="loaderror",a=class extends e{#i;#n;#r;#a;#o;#c;#l=!1;#h=!1;#d=[];#u=[];#g=0;#C;#E;#m=[];#A=!1;constructor({user:e,content:t,fullContent:a,promise:o,type:c,excludeFromCommits:l=!1,hidden:h=!1,quickActions:d,codeBlockQuickActions:u,processMessageFn:g,cssClasses:C}){super(),this.#i=Date.now(),this.#n=e,this.#r=t,this.#c=this.#p(c),this.#a=a||t,this.#l=l,this.#h=h,this.#E=g,this.#d=this.#k(d),this.#u=this.#M(u),this.#m=this.#f(C),o?(this.#o=o,this.#C=i,o.then((e=>{this.#C=n,this.#r=e,this.#a=e,this.#I(),this.triggerEvent(s.LOAD_COMPLETE,e)})).catch((e=>{this.#C=r,this.triggerEvent(s.LOAD_ERROR,e)}))):this.#I()}get user(){return this.#n}get content(){return this.#r}set content(e){const t=this.#r;this.#r=e,this.triggerEvent(s.CONTENT_CHANGE,e,t)}get fullContent(){return this.#a}get type(){return this.#c}get promise(){return this.#o}get excludeFromCommits(){return this.#l}get hidden(){return this.#h}get timestamp(){return this.#i}set quickActions(e){this.#A||(this.#d=this.#k(e),this.triggerEvent(s.QUICK_ACTIONS_CHANGE,this.#d))}get quickActions(){return this.#d}set codeBlockQuickActions(e){this.#u=this.#M(e),this.triggerEvent(s.CODE_BLOCK_QUICK_ACTIONS_CHANGE,this.#u)}get codeBlockQuickActions(){return this.#u}set cssClasses(e){this.#m=this.#f(e),this.triggerEvent(s.CSS_CLASSES_CHANGE,this.#m)}get cssClasses(){return this.#m}set expired(e){this.#d?.length&&(this.quickActions=[]),this.#A=!!e,this.triggerEvent(s.EXPIRE,e)}get expired(){return this.#A}isLoading(){return this.#C===i}isLoaded(){return!this.#o||this.#C===n}isErrored(){return this.#C===r}#k(e){let t=[];return Array.isArray(e)&&(t=e.filter((e=>e.label))),t}#M(e){let t=[];return Array.isArray(e)&&(t=e.filter((e=>e.label||e.iconClasses)),t.forEach((e=>{e.id=""+this.#g++}))),t}#p(e){if(Object.values(t).includes(e))return e;throw new Error(`Invalid message type (${e}).`)}#f(e){if(e){if("string"==typeof e)return e.split(" ");if(Array.isArray(e))return e}return[]}#I(){const e=this.#E;if("function"==typeof e){const{message:s,quickActions:i,codeBlockQuickActions:n,cssClasses:r}=e(this)||{};if(s){const e=typeof s;if("string"===e)this.#r=s;else if("object"===e){const{type:e=t.TEXT,content:i}=s;this.#c=this.#p(e),this.#r=i}}Array.isArray(i)&&i.length&&(this.#d=this.#k(i)),Array.isArray(n)&&n.length&&(this.#u=this.#M(n)),r&&(this.#m=this.#f(r))}}};a.events=Object.freeze(s);var o=class{#v;#T;#L;#_;#y;#O;constructor({id:e,name:t,messageStyle:s="outbound",avatar:i}){this.#v=e,this.#T=t,this.#_=s,this.#y=i?.imageUrl,this.#O=i?.iconClasses,this.#L=i?.initials||""}get messageStyle(){return this.#_}get avatarInitials(){return this.#L}get name(){return this.#T}get avatarImageUrl(){return this.#y}get avatarIconClasses(){return this.#O}get id(){return this.#v}},c={MESSAGE_ADDED:"messageadded",CLEAR:"clear",CHAT_LOCK:"chatlocked",CHAT_UNLOCK:"chatunlocked",MESSAGE_LOAD_COMPLETE:"messageloadcomplete",MESSAGE_LOAD_ERROR:"messageloaderror",HISTORY_RESTORED:"historyrestored",COMMIT:"commit"},l=class extends e{#S=new Map;#R=[];#b=1;#w;#E;constructor({users:e=[],processMessage:t}={}){super(),this.#E=t,e.forEach((e=>{let t=e.id??"u"+this.#b++;if(this.#S.has(t))throw new Error(`User ${t} already exists`);this.#S.set(t,e instanceof o?e:new o({id:t,name:e.name||""}))}))}restoreHistory(e){const{messages:s=[]}=e,i=s.map((e=>{const{userId:s,content:i,fullContent:n=i,type:r=t.TEXT,promise:o,excludeFromCommits:c,hidden:l,quickActions:h,codeBlockQuickActions:d}=e,u=this.getUser(s);if(!u)throw new Error("Invalid user ID in history.");return new a({user:u,content:i,fullContent:n,type:r,promise:o,excludeFromCommits:c,hidden:l,quickActions:h,codeBlockQuickActions:d})}));return i.forEach((({content:e},t)=>{if(!e)throw new Error(`History's message at index ${t} is missing content.`)})),this.#R=i,i}addMessage(e,t,s,{fullContent:i,excludeFromCommits:n=!1,hidden:r=!1,cssClasses:o}={}){let l;"object"==typeof t&&"then"in t&&(l=t,t=void 0);const h=new a({user:e,promise:l,content:t,fullContent:i,type:s,excludeFromCommits:n,hidden:r,cssClasses:o,processMessageFn:this.#E});return this.#R.push(h),l&&(h.one(a.events.LOAD_COMPLETE,this.onMessageLoadComplete,{scope:this}),h.one(a.events.LOAD_ERROR,this.onMessageLoadError,{scope:this})),this.triggerEvent(c.MESSAGE_ADDED,h),h}getHistory(){return{messages:[...this.getMessages()]}}getMessages(){return this.#R}getUser(e){return this.#S.get(e)}lock(){this.#w||(this.#w=!0,this.triggerEvent(c.CHAT_LOCK))}unlock(){this.#w&&(this.#w=!1,this.triggerEvent(c.CHAT_UNLOCK))}isLocked(){return this.#w}destroy(e=!0){this.#R.forEach((e=>e.offAllScoped(this))),e&&this.off()}onMessageLoadComplete(e,t){const s=e.target;s.off(a.events.LOAD_ERROR,this.onMessageLoadError,this),this.triggerEvent(c.MESSAGE_LOAD_COMPLETE,s,t)}onMessageLoadError(e,t){const s=e.target;s.off(a.events.LOAD_COMPLETE,this.onMessageLoadComplete,this),this.triggerEvent(c.MESSAGE_LOAD_ERROR,s,t)}clear(){this.#R.forEach((e=>e.offAllScoped(this))),this.#R=[],this.triggerEvent(c.CLEAR),this.unlock()}expire(){this.#R.forEach((e=>e.expired=!0))}};l.events=Object.freeze(c);var{util:h,message:d}=apex;function u(){return h.getTopApex().jQuery({}).uniqueId()[0].id}function g(e=0,t){return new Promise((s=>setTimeout((()=>{s(t)}),e)))}var C=class e{static uniqueId=0;#x;#D;#N;constructor(){e.uniqueId+=1,this.#x="aiSpinner"+e.uniqueId,h.delayLinger.start(this.#x,(()=>{this.#N=!0,this.#D=apex.util.showSpinner()}))}finish(){return new Promise((e=>{this.#N?h.delayLinger.finish(this.#x,(()=>{this.#D.remove(),e()})):(h.delayLinger.finish(this.#x),e())}))}},{debug:E,lang:m}=apex,A=m.getMessage("APEX.ERROR"),p="user",k="assistant",M="new_message",f=class extends l{#U;#Q;#G;#q;constructor({currentUser:e,aiUser:t,ajaxCallback:s,history:i,processMessage:n}){if(!(e instanceof o))throw new Error("currentUser must be a User instance.");if(!(t instanceof o))throw new Error("aiUser must be a User instance.");if(super({users:[e,t],history:i,processMessage:n}),this.#U=e,this.#Q=t,null==s)throw new Error("ajaxCallback is required.");this.#G=s}addMessage(e,s,i,n={},r,a){const{fullContent:o=s,excludeFromCommits:c=!1,hidden:l=!1,cssClasses:h}=n;if(i??=e===this.#U?t.TEXT:t.MARKDOWN,r??=e===this.#U,e===this.#U)return this.addUserMessage(s,i,{fullContent:o,excludeFromCommits:c,hidden:l,cssClasses:h},r,a);if(e===this.#Q)return this.addAiMessage(s,i,{fullContent:o,excludeFromCommits:c,hidden:l,cssClasses:h},r,a);throw new Error("Invalid user.")}async addUserMessage(e,s=t.TEXT,{fullContent:i,excludeFromCommits:n=!1,hidden:r=!1,cssClasses:a}={},o=!0,c=200){if(this.isLocked())throw new Error("Cannot add message, the model is locked.");return super.addMessage(this.#U,e,s,{fullContent:i,excludeFromCommits:n,hidden:r,cssClasses:a}),o?this.commit(c):e}async addAiMessage(e,s=t.MARKDOWN,{fullContent:i=e,excludeFromCommits:n=!1,hidden:r=!1,cssClasses:a},o=!1,c=0,l=!0){if(this.isLocked())throw new Error("Cannot add message, the model is locked.");if(l){this.lock(),await g(100);const t=g(400,e);return super.addMessage(this.#Q,t,s,{fullContent:i,excludeFromCommits:n,hidden:r,cssClasses:a}),await t,o?this.commit(c):(this.unlock(),t)}return super.addMessage(this.#Q,e,s,{fullContent:i,excludeFromCommits:n,hidden:r,cssClasses:a}),o?this.commit(c):e}getCurrentUser(){return this.#U}get currentUser(){return this.#U}getAiUser(){return this.#Q}get aiUser(){return this.#Q}async commit(e=0){this.lock(),await g(e);const s=new Promise(((e,t)=>{Promise.all([g(800),new Promise(((e,t)=>{const s=this.getMessages().filter((e=>!e.excludeFromCommits&&!e.expired)).map((e=>({role:this.#U.id===e.user.id?p:k,message:e.fullContent}))),i=this.#G({mode:M,messages:s});i.then((({response:t})=>{e(t)})).catch((({responseJSON:e})=>{E.error(e),t(A)})),this.triggerEvent(c.COMMIT,s,i)}))]).then((t=>e(t[1]))).catch((e=>t(e))).finally((()=>this.unlock()))}));return this.#q=super.addMessage(this.#Q,s,t.MARKDOWN),s}onMessageLoadComplete(){this.#q=null,super.onMessageLoadComplete(...arguments)}onMessageLoadError(){this.#q=null,super.onMessageLoadError(...arguments)}restoreHistory(e){const{commit:t=!1}=e;super.restoreHistory(e),t&&this.commit()}getHistory(){const e=super.getHistory();return e.loadingMessage=this.#q,e}};f.events=Object.freeze(c);var I={QUICK_ACTION_TRIGGER:"quickactiontrigger",CODE_BLOCK_QUICK_ACTION_TRIGGER:"codeblockquickactiontrigger",AFTER_LOAD_RENDER:"afterloadrender",AFTER_QUICK_ACTIONS_RENDER:"afterquickactionsrender"},{lang:v,util:T}=apex,L=v.getMessage("APEX.PROCESSING"),_=v.getMessage("APEX.AI.USER_AVATAR"),y=v.getMessage("APEX.ERROR"),O=`\n    <div class="u-vh">${T.escapeHTML(L)}</div>\n    <span class="a-ChatLoader"></span>`,S="a-ChatItem-row",R="a-ChatItem-bubble",b="a-ChatItem-bubble--processing",w="a-ChatItem-message",x="a-ChatItem-pre",D=(()=>{const e=new marked.Renderer;return e.html=function({text:e,block:t}){return t?`<p role="none">${T.escapeHTML(e)}</p>\n`:`<span>${T.escapeHTML(e)}</span>`},e.paragraph=function({tokens:e}){return`<p role="none">${this.parser.parseInline(e)}</p>\n`},e})(),N=new marked.Marked({gfm:!0,breaks:!0,tables:!0,mangle:!1,xhtml:!1,headerIds:!1,renderer:D}),U=class extends e{#H;#B;#$;#K;#d=new Map;#F=[];#V;#P=e=>{const t=this.#d.get(e.currentTarget);this.triggerEvent(I.QUICK_ACTION_TRIGGER,t)};#j=e=>{const{target:t}=e,s=t.closest(".a-ChatItem-button"),i=s?.dataset.codeBlockActionId;if(i){const e=s.closest(`.${x}`).querySelector("pre"),t=this.#H.codeBlockQuickActions.find((e=>e.id===i));t&&this.triggerEvent(I.CODE_BLOCK_QUICK_ACTION_TRIGGER,t,s,e)}};constructor(e,t={}){super(),this.#H=e,this.#V=t.highlightCodeFn,this.#B=this.#z(e),this.#$=this.#X(e),e.isLoading()?(e.one(a.events.LOAD_COMPLETE,this.#W,{scope:this}),e.one(a.events.LOAD_ERROR,this.#Y,{scope:this})):this.#J(),e.on(a.events.CONTENT_CHANGE,this.#Z,{scope:this}),e.on(a.events.QUICK_ACTIONS_CHANGE,this.#ee,{scope:this}),e.on(a.events.CODE_BLOCK_QUICK_ACTIONS_CHANGE,this.#te,{scope:this}),e.on(a.events.CSS_CLASSES_CHANGE,this.#se,{scope:this}),e.on(a.events.EXPIRE,this.#ie,{scope:this}),this.#$.addEventListener("click",this.#j),this.#ne(e.cssClasses),this.#re(e.quickActions)}get markup(){return this.#B}get el(){return this.#$}get model(){return this.#H}destroy(){this.#H.offAllScoped(this),this.#d.size&&this.#d.forEach(((e,t)=>{t.removeEventListener("click",this.#P)})),this.#$.removeEventListener("click",this.#j)}#re(e){if(this.#ae(),!e.length)return;const t=document.createElement("div");t.classList.add("a-ChatItem-messageActions"),this.#K=t,e.forEach((e=>{const s=document.createElement("button"),i=document.createTextNode(e.label||"");s.append(i),s.type="button",s.classList.add("a-ChatItem-messageButton"),this.#d.set(s,e),s.addEventListener("click",this.#P),t.appendChild(s)})),this.#$.querySelector(`.${R}`).appendChild(t),this.triggerEvent(I.AFTER_QUICK_ACTIONS_RENDER)}#ae(){this.#d.size&&(this.#d.forEach(((e,t)=>{t.removeEventListener("click",this.#P)})),this.#d.clear(),this.#K.remove(),this.#K=null)}#W(){const{content:e,quickActions:t,cssClasses:s}=this.#H;this.#H.off(a.events.LOAD_ERROR,this.#Y,this),this.#oe(e),t.length&&this.#re(t),s.length&&this.#ne(s)}#Y(e,t){throw this.#H.off(a.events.LOAD_COMPLETE,this.#W,this),this.#oe(y),this.#$.classList.add("a-ChatItem-row--error"),t}#Z(e,t){this.#oe(t)}#ee(e,t){this.#re(t)}#te(){this.#oe(this.#H.content)}#se(e,t){this.#ne(t)}#ie(e,t){this.#$.classList[t?"add":"remove"]("a-ChatItem-row--expired")}#ne(e=[]){this.#ce(),this.#F=e.map((e=>T.escapeHTMLAttr(e))),this.#$.classList.add(...this.#F)}#ce(){this.#$.classList.remove(...this.#F)}#oe(e){this.#$.querySelector(`.${R}`).classList.remove(b),e=this.#le(e);this.#$.querySelector(`.${w}`).replaceChildren(document.createRange().createContextualFragment(e)),this.#J(),this.triggerEvent(I.AFTER_LOAD_RENDER,e)}#X(){return document.createRange().createContextualFragment(this.#B).firstElementChild}#J(){this.el.querySelectorAll("code[class*=language]").forEach((e=>{const t=this.#V;"function"==typeof t?t(this,e):Prism.highlightElement(e)}))}#z(e){const{user:t}=e;let s="";return s=e.isLoading()?O:this.#le(e.content),`\n            <li class="${S} ${S}--${T.escapeHTMLAttr(t.messageStyle)}">\n                <div class="a-ChatItem">\n                    <div class="a-ChatItem-body">\n                        <div class="a-ChatItem-visual" role="img" aria-label="${T.escapeHTMLAttr(t.name)}">\n                            <div class="a-ChatItem-avatar">${this.#he(t)}</div>\n                        </div>\n                        <div class="${R} ${e.isLoading()?b:""}">\n                            <span class="u-vh">${v.formatMessage("APEX.AI.NAME_COMMA_MESSAGE",t.name," ")}</span>\n                            <div class="${w} is-markdownified">${s}</div>\n                        </div>\n                    </div>\n                </div>\n            </li>`}#he(e){const{avatarInitials:t,avatarImageUrl:s,avatarIconClasses:i}=e;return s?`<img class="a-ChatItem-image" src="${T.escapeHTMLAttr(s)}" alt="${T.escapeHTMLAttr(_)}">`:i?`<span class="a-ChatItem-icon ${T.escapeHTMLAttr(i)}"></span>`:T.escapeHTML(t)}#le(e=""){const{type:s,codeBlockQuickActions:i}=this.#H;return s===t.MARKDOWN?e=((e,t=[])=>(D.code=function({text:e,lang:s,escaped:i}){s=(s||"").match(/^\S*/)?.[0],i||(e=T.escapeHTML(e));const n=t.reduce(((e,t)=>{const{id:s,iconClasses:i,label:n,ariaLabel:r}=t;return`${e}\n                <button class="a-ChatItem-button" data-code-block-action-id="${T.escapeHTMLAttr(s)}" type="button"${r?` aria-label="${T.escapeHTMLAttr(r)}"`:""}>\n                    ${i?`<span class="a-ChatItem-buttonIcon a-Icon ${T.escapeHTMLAttr(i)}" aria-hidden="true"></span>`:""}\n                    ${n?`<span class="a-ChatItem-buttonLabel">${T.escapeHTML(n)}</span>`:""}\n                </button>`}),""),r=T.escapeHTMLAttr(s||"");let a,o="";return(s||n)&&(a=u(),o=`\n                <div class="a-ChatItem-preHeader">\n                    <span class="a-ChatItem-preLang" id="${a}">${r}</span>\n                    <div class="a-ChatItem-preActions">${n}</div>\n                </div>`),`\n            <div class="${x}" role="group"${o?` aria-labelledby="${a}`:""}">\n                ${o}\n                <pre><code${s?` class="language-${r}" data-lang="${r}"`:""}>${e}</code></pre>\n            </div>`},N.setOptions({renderer:D}),N.parse(e)))(e,i):s===t.HTML||(e=(e=T.escapeHTML(e)).replace(/\n/g,"<br>")),e}};U.events=Object.freeze(I);var{jQuery:Q,lang:G,util:q}=apex,H="a-ChatTranscript",B="a-ChatItems",$="a-ChatInputContainer",K="a-ChatInput-textPreview",F="a-ChatInput-text",V="a-ChatInput-button",P={INLINE:"inline",DIALOG:"dialog",NONE:"none"},j=G.getMessage("APEX.AI.TEXTAREA_LABEL"),z=G.getMessage("APEX.AI.DIALOG_TITLE"),X=G.getMessage("APEX.AI.CONVERSATION_HISTORY"),W=G.getMessage("APEX.AI.TEXTAREA_PLACEHOLDER"),Y=G.getMessage("APEX.AI.WARN_UNSENT_MESSAGE"),J=G.getMessage("APEX.AI.SEND_MESSAGE"),Z=G.getMessage("APEX.AI.MAIN_QUICK_ACTIONS_ARIA_LABEL"),ee=`\n    <div class="a-ChatClient">\n        <div class="${H}" role="region" aria-label="${q.escapeHTMLAttr(X)}">\n            <div class="a-ChatTranscript-log" role="log">\n                <ul class="${B}" tabindex="0" aria-label="${q.escapeHTMLAttr(X)}">\n                </ul>\n            </div>\n        </div>\n        <div class="${$}">\n            <div class="a-ChatInput" role="region" aria-label="${q.escapeHTMLAttr(j)}">\n                <div class="a-ChatInput-textWrap">\n                    <textarea class="${F}" aria-label="${q.escapeHTMLAttr(j)}" enterkeyhint="send" rows="1"></textarea>\n                    <span class="${K}" aria-hidden="true"></span>\n                </div>\n                <div class="a-ChatInput-actions">\n                    <button class="${V} ${V}--send" title="${q.escapeHTMLAttr(J)}" aria-label="${q.escapeHTMLAttr(J)}">\n                        <span class="a-ChatInput-icon a-Icon icon-arrow-up" aria-hidden="true">\n                        </span>\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>`,te=0,se={MESSAGE_VIEW_RENDER:"messageviewrender",MESSAGE_QUICK_ACTION_TRIGGER:"messageviewquickactiontrigger",MESSAGE_CODE_BLOCK_QUICK_ACTION_TRIGGER:"messagecodeblockquickactiontrigger",QUICK_ACTION_TRIGGER:"quickactiontrigger",HIDE:"hide",DIALOG_CLOSE:"dialogclose",DESTROY:"destroy"},ie=class extends e{#H;#de;#v;#ue;#$;#ge;#Ce;#Ee;#me;#Ae;#pe;#d=new Map;#ke=[];#Me;#fe=!1;#Ie=!1;#h=!0;#ve=!1;#Te=!0;#Le=()=>{this.#_e(),this.#ye()};#Oe=e=>{const{which:t,shiftKey:s}=e;13!==t||s||(e.preventDefault(),this.#Se())};#Re=()=>{this.#Se()};#be=e=>{if(this.#H.isLocked())return;const s=this.#d.get(e.currentTarget),{message:i}=s;i&&this.#H.addUserMessage(i,t.TEXT),this.removeQuickActions(),this.#me.focus(),this.triggerEvent(se.QUICK_ACTION_TRIGGER,s)};#we=e=>{const{target:t}=e;this.#Te=t.scrollHeight-t.scrollTop-t.clientHeight<1};constructor(e,t){if(super(),this.#v="main-view-"+te++,this.#de=Q.extend({user:null,el:null,focus:!0,disclaimer:null,highlightCodeFn:null,mode:P.DIALOG,title:z,placeholder:W,width:500,height:600},t),!(e instanceof l))throw new Error("A valid Chat instance must be provided");this.#H=e,this.#xe()}findMessageViewByModel(e){return this.#ke.find((t=>t.model===e))}show(e=!0){if(!this.#h)return;const{mode:t}=this.#de;t===P.DIALOG?this.#ue.dialog("open"):Q(this.#$).show(),e&&this.#me.focus(),this.#h=!1}hide(){if(this.#h)return;this.#h=!0;const{mode:e}=this.#de;e===P.DIALOG?(this.#Ie=!0,this.#ue.dialog("close"),this.#Ie=!1,this.triggerEvent(se.DIALOG_CLOSE)):Q(this.#$).hide(),this.triggerEvent(se.HIDE)}close(){this.hide()}destroy(e=!0){if(this.#ve)return;this.#ve=!0;const{mode:t}=this.#de;this.close();const s=this.#H;this.#ke.forEach((e=>{e.destroy(),e.off()})),s.offAllScoped(this),e&&this.off(),this.#d.size&&this.#d.forEach(((e,t)=>{t.removeEventListener("click",this.#be)})),this.#me.removeEventListener("input",this.#Le),this.#me.removeEventListener("keydown",this.#Oe),this.#Me.removeEventListener("click",this.#Re),this.#ge.removeEventListener("scroll",this.#we),t===P.DIALOG?this.#ue.dialog("destroy").remove():this.#$.remove(),this.triggerEvent(se.DESTROY)}isDestroyed(){return this.#ve}get destroyed(){return this.#ve}hasUncommittedInput(){return!this.#ve&&!this.#h&&""!==this.#me.value}get id(){return this.#v}#xe(){let e,t,s;const i=this.#H,{quickActions:n,mode:r,el:a,title:o,focus:c,width:l,height:h,disclaimer:d}=this.#de;if(r===P.INLINE)e=Q(a);else{if(r!==P.DIALOG)throw new Error("Invalid option for mode");e=apex.message.showDialog("",{okButton:!1,confirm:!1,alert:!1,height:h,width:l,minHeight:400,minWidth:300,autoOpen:!1,dialogClass:"ui-dialog--chat-client",id:u(),isPopup:!1,noOverlay:!1,draggable:!0,resizable:!0,title:o,unsafe:!1,takeFocus:!0,beforeClose:()=>this.#Ie?void 0:this.hasUncommittedInput()?(apex.message.confirm(Y,(e=>{e&&this.close()})),!1):(this.close(),!1)})}if(t=document.createRange().createContextualFragment(ee).firstElementChild,e[0].append(t),s=t.querySelector(`.${V}`),s.disabled=!0,this.#ue=e,this.#$=t,this.#Me=s,this.#ge=t.querySelector(`.${H}`),this.#Ce=t.querySelector(`.${B}`),this.#Ee=t.querySelector(`.${$}`),this.#me=t.querySelector(`.${F}`),this.#Ae=t.querySelector(`.${K}`),d){const e=document.createElement("div");e.classList.add("a-ChatTranscript-disclaimer"),e.appendChild(document.createTextNode(d)),this.#ge.prepend(e)}this.#De(),this.#Ne(),Array.isArray(n)&&n.length&&this.createQuickActions(n),i.getHistory().messages.forEach((e=>this.#Ue(e))),i.isLocked()&&this.#Qe(),this.show(c)}createQuickActions(e=[]){if(this.removeQuickActions(),e.length){const t=document.createElement("div");t.classList.add("a-ChatActions-quickPicks"),t.setAttribute("role","region"),t.setAttribute("aria-label",Z),this.#pe=t,e.forEach((e=>{const s=document.createElement("button");s.type="button",s.classList.add("a-Button");const{title:i,description:n,disabled:r}=e;if(i){const e=document.createElement("span"),t=u();e.textContent=i,e.classList.add("a-Button-label","a-Button-label--title"),e.id=t,s.setAttribute("aria-labelledby",t),s.appendChild(e)}if(n){const e=document.createElement("span"),t=u();e.textContent=n,e.classList.add("a-Button-label","a-Button-label--description"),e.id=t,s.setAttribute("aria-describedby",t),s.appendChild(e)}r&&(s.disabled=!0),this.#d.set(s,e),s.addEventListener("click",this.#be),t.appendChild(s)})),this.#$.insertBefore(t,this.#Ee),this.#Te&&this.scrollTranscriptToBottom(!0)}return this.getQuickActionButtons()}removeQuickActions(){this.#d.size&&(this.#d.forEach(((e,t)=>{t.removeEventListener("click",this.#be)})),this.#d.clear(),this.#pe.remove(),this.#pe=null)}getQuickActionButtons(){return Array.from(this.#d.entries()).map((([e,t])=>({button:e,actionObj:t})))}getMessageViews(){return[...this.#ke]}get el(){return this.#$}#Ne(){this.#H.on(c.MESSAGE_ADDED,this.#Ge,{scope:this}),this.#H.on(c.CHAT_LOCK,this.#Qe,{scope:this}),this.#H.on(c.CHAT_UNLOCK,this.#qe,{scope:this}),this.#H.on(c.CLEAR,this.#He,{scope:this}),this.#me.addEventListener("input",this.#Le),this.#me.addEventListener("keydown",this.#Oe),this.#Me.addEventListener("click",this.#Re),this.#ge.addEventListener("scroll",this.#we)}#_e(){this.#Me.disabled=this.#fe||!this.#me.value}#Ge(e,t){this.#Ue(t)}#Qe(){this.#fe=!0,this.#Me.disabled=!0,this.#pe?.querySelectorAll("button").forEach((e=>e.disabled=!0))}#qe(){this.#fe=!1,this.#_e(),this.#pe?.querySelectorAll("button").forEach((e=>e.disabled=!1))}#He(){this.#ke.forEach((e=>{e.destroy(),e.off(),e.el.remove()})),this.#ke=[]}#Ue(e){if(e.hidden)return;const t=new U(e,{highlightCodeFn:this.#de.highlightCodeFn});this.#ke.push(t),this.#Ce.append(t.el),this.#Be(t),t.on(I.QUICK_ACTION_TRIGGER,this.#$e,{scope:this}),t.on(I.CODE_BLOCK_QUICK_ACTION_TRIGGER,this.#Ke,{scope:this}),t.on(I.AFTER_LOAD_RENDER,this.#Fe,{scope:this}),t.on(I.AFTER_QUICK_ACTIONS_RENDER,this.#Ve,{scope:this}),this.triggerEvent(se.MESSAGE_VIEW_RENDER,t)}#$e(e,t){this.triggerEvent(se.MESSAGE_QUICK_ACTION_TRIGGER,e.target,t)}#Ke(e,t,s,i){this.triggerEvent(se.MESSAGE_CODE_BLOCK_QUICK_ACTION_TRIGGER,e.target,t,s,i)}#Fe(e){this.#Be(e.target)}#Ve(e){this.#Be(e.target)}#De(){const e=this.#de,t=this.#me;e.placeholder&&t.setAttribute("placeholder",e.placeholder)}#Se(){if(this.#fe)return!1;const e=this.#me,s=e.value;return s.length&&(this.#pe&&this.removeQuickActions(),this.#H.addUserMessage(s,t.TEXT),e.value="",this.#ye(),this.#_e(),this.#me.focus()),!0}isTranscriptScrolledToBottom(){const e=this.#ge;return e.scrollHeight-e.scrollTop-e.clientHeight<1}scrollTranscriptToBottom(e=!1){const t=this.#ge;t.scroll({top:t.scrollHeight,behavior:e?"instant":"smooth"})}#Be(e){const t=e.el;this.#ge.scroll({top:t.offsetTop,behavior:"smooth"})}#ye(){this.#Ae.innerText=this.#me.value}};ie.events=se;var{jQuery:ne,lang:re,server:ae}=apex,oe=re.getMessage("APEX.AI.NAME_USER"),ce=re.getMessage("APEX.AI.NAME_ASSISTANT"),le=re.getMessage("APEX.AI.COPY"),he=re.getMessage("APEX.AI.COPIED"),de={MESSAGE_QUICK_ACTION_TRIGGER:"messagequickactiontrigger",MESSAGE_CODE_BLOCK_QUICK_ACTION_TRIGGER:"messagecodeblockquickactiontrigger",MESSAGE_RENDER:"messagerender",QUICK_ACTION_TRIGGER:"quickactiontrigger",CHAT_LOCK:c.CHAT_LOCK,CHAT_UNLOCK:c.CHAT_UNLOCK,MESSAGE_ADDED:c.MESSAGE_ADDED,MESSAGE_LOAD_COMPLETE:c.MESSAGE_LOAD_COMPLETE,MESSAGE_LOAD_ERROR:c.CHAT_LOCK},ue={COPY:{label:le,iconClasses:"icon-copy",action:function(e,t,s,i,n,r){const a="is-copied",o="ui-icon-check",{iconClasses:c}=i,l=(e,t)=>{const s="copyTimeoutId";if(parseInt(n.dataset[s],10))return;const i=n.querySelector(".a-ChatItem-buttonLabel"),r=n.querySelector(".a-ChatItem-buttonIcon");let l;n.classList.add(a),null!=e&&i&&(i.innerText=e),null!=t&&(l=n.getAttribute("aria-label"),n.setAttribute("aria-label",t)),r&&(c&&r.classList.toggle(...c.split(" ")),o&&r.classList.toggle(...o.split(" "))),n.dataset[s]=setTimeout((()=>{delete n.dataset[s],n.classList.remove(a),null!=l&&n.setAttribute("aria-label",l),i&&(i.innerText=le),r&&(c&&r.classList.toggle(...c.split(" ")),o&&r.classList.toggle(...o.split(" ")))}),3e3)};if(navigator.clipboard)try{navigator.clipboard.writeText(r.innerText.replace(/\u00a0/g," ")),l(he)}catch(e){}else{!function(e){const t=window.getSelection(),s=document.createRange();s.selectNodeContents(e),t.removeAllRanges(),t.addRange(s)}(r);try{document.execCommand("copy")&&l(he)}catch(e){}finally{window.getSelection().removeAllRanges()}}}}},ge=class extends e{#Pe;#U;#Q;#je;#ve=!1;#G;#ze=[];constructor(e={}){const{ajaxCallback:t,ajaxId:s,processMessage:i,history:n,currentUserData:r={},aiUserData:a={}}=e;let c;super();const l=new o(ne.extend({id:"1",name:oe,messageStyle:"outbound",avatar:pe()},r));this.#U=l;const h=new o(ne.extend({id:"2",name:ce,messageStyle:"inbound",avatar:{iconClasses:"a-Icon icon-apex-assistant"}},a));if(this.#Q=h,s)this.#G=e=>ae.plugin(s,{p_widget_name:"ai",...e});else{if(!t)throw new Error("Either ajaxId or ajaxCallback is required");this.#G=t}"function"==typeof i&&(c=e=>i(this,e)),this.#Xe({history:n,processMessage:c})}async addMessage(e,t,s,i={}){return this.#Pe.addMessage(e,t,s,i,!1)}async addAiMessage(e,s=!1){let i,n,r,a=t.MARKDOWN,o=!1,c=!1;return"string"==typeof e?i=n=e:({content:i,type:a=t.MARKDOWN,fullContent:n,excludeFromCommits:o=!1,hidden:c=!1,cssClasses:r}=e),this.#Pe.addAiMessage(i,a,{fullContent:n,excludeFromCommits:o,hidden:c,cssClasses:r},!1,0,s)}async addUserMessage(e){let s,i,n,r=t.TEXT,a=!1,o=!1;return"string"==typeof e?s=i=e:({content:s,type:r=t.TEXT,fullContent:i,excludeFromCommits:a=!1,hidden:o=!1,cssClasses:n}=e),this.#Pe.addUserMessage(s,r,{fullContent:i,excludeFromCommits:a,hidden:o,cssClasses:n},!1)}commit(){return this.#Pe.commit()}isLocked(){return this.#Pe.isLocked()}getHistory(){let e=this.#Pe.getHistory(),t=!1;const{messages:s,loadingMessage:i}=e,n={};if(!s.length)return{messages:[],commit:!1};if(i)t=!0,s.pop();else{const e=s[s.length-1];e.promise&&!e.isLoaded()&&s.pop()}return n.messages=s.map((e=>({content:e.content,fullContent:e.fullContent,userId:e.user.id,type:e.type,excludeFromCommits:e.excludeFromCommits,hidden:e.hidden,quickActions:e.quickActions}))),n.commit=t,n}createDialogView({title:e,quickActions:t,focus:s,width:i,height:n,disclaimer:r,highlightCode:a}={}){return this.#We({mode:P.DIALOG,title:e,quickActions:t,focus:s,width:i,height:n,disclaimer:r,highlightCode:a})}createInlineView({el:e="body",quickActions:t,focus:s,disclaimer:i,highlightCode:n}={}){return this.#We({mode:P.INLINE,el:e,quickActions:t,focus:s,disclaimer:i,highlightCode:n})}registerView(e){e.on(ie.events.MESSAGE_QUICK_ACTION_TRIGGER,this.#$e,{scope:this}),e.on(ie.events.MESSAGE_CODE_BLOCK_QUICK_ACTION_TRIGGER,this.#Ke,{scope:this}),e.on(ie.events.QUICK_ACTION_TRIGGER,this.#Ye,{scope:this}),e.on(ie.events.MESSAGE_VIEW_RENDER,this.#Je,{scope:this}),e.on(ie.events.DESTROY,this.#Ze,{scope:this})}setViewQuickActions(e,t=[]){return e.createQuickActions(t)}setAllViewsQuickActions(e=[]){this.#ze.forEach((t=>t.createQuickActions(e)))}getViewQuickActionButtons(e){return e.getQuickActionButtons()}getAllViewsQuickActionsButtons(){return this.#ze.reduce(((e,t)=>(e.set(t,t.getQuickActionButtons()),e)),new Map)}getViews(){return[...this.#ze]}closeView(e){e.close()}hideView(e){e.hide()}showView(e){e.show()}destroyView(e){e.destroy()}getCurrentUser(){return this.#U}getAiUser(){return this.#Q}getModel(){return this.#Pe}clearMessages(){this.#Pe.clear()}expireMessages(){this.#Pe.expire()}get model(){return this.#Pe}destroy(){const e=this.#Pe;this.#ve=!0,this.#je(),e.destroy(),this.#ze.forEach((e=>{e.destroy()}))}isDestroyed(){return this.#ve}get destroyed(){return this.#ve}#Xe({history:e,processMessage:t}){const s=new f({currentUser:this.#U,aiUser:this.#Q,ajaxCallback:this.#G,processMessage:t});this.#Pe=s,e&&s.restoreHistory(e),this.#et()}#et(){this.#je=this.relayEvents(this.#Pe,[c.CHAT_LOCK,c.CHAT_UNLOCK,c.MESSAGE_ADDED,c.MESSAGE_LOAD_COMPLETE,c.MESSAGE_LOAD_ERROR,c.COMMIT])}#We(e){const{mode:t}=e;if(t&&Object.values(P).includes(t)){const{el:s,quickActions:i,focus:n,disclaimer:r,title:a,width:o,height:c,highlightCode:l}=e;let h;"function"==typeof l&&(h=(e,t)=>l(this,d,e,t));const d=new ie(this.#Pe,{user:this.#U,mode:t,el:s,quickActions:i,focus:n,disclaimer:r,title:a,width:o,height:c,highlightCodeFn:h});return this.registerView(d),this.#ze.push(d),d}throw new Error("Invalid render mode for the view.")}#$e(e,t,s){const i=s.action,n=e.currentTarget;i&&"function"==typeof i&&i(this,n,t,s),this.triggerEvent(de.MESSAGE_QUICK_ACTION_TRIGGER,n,t,s)}#Ke(e,t,s,i,n){const r=s.action,a=e.currentTarget;r&&"function"==typeof r&&r(this,a,t,s,i,n),this.triggerEvent(de.MESSAGE_CODE_BLOCK_QUICK_ACTION_TRIGGER,a,t,s,i,n)}#Je(e,t){const s=e.currentTarget;this.triggerEvent(de.MESSAGE_RENDER,s,t)}#Ye(e,t){const s=t.action,i=e.target;s&&"function"==typeof s&&s(this,i,t),this.triggerEvent(de.QUICK_ACTION_TRIGGER,i,t)}#Ze(e){const t=e.target,s=this.#ze.findIndex((e=>e===t));s>-1&&this.#ze.splice(s,1)}};ge.events=Object.freeze(de),ge.renderModes=Object.freeze(P),ge.messageTypes=Object.freeze(t),ge.actions=Object.freeze(ue);var Ce,{lang:Ee,server:me}=apex,Ae=!1,pe=()=>Ce,ke=(()=>{let e,t;const s="get_consent_message",i="save_consent",n=Ee.getMessage("APEX.AI.CONSENT_ACCEPT"),r=Ee.getMessage("APEX.AI.CONSENT_DENY"),a=e=>me.widget("ai",e),o=async()=>{if(!t){const e=new C;t=(await a({mode:s})).message,await e.finish()}const e=await(o=t,c={confirmLabel:n,cancelLabel:r,dialogClasses:"ui-dialog--ai-consent",unsafe:!1},new Promise((e=>{d.confirm(o,(t=>{e(t)}),c)})));var o,c;return e&&(a({mode:i}),Ae=!1),e};return async()=>!Ae||(e||(e=o(),e.then((()=>{e=void 0}))),await e)})();apex.ai={configure:({userConsentNeeded:e,userAvatar:t})=>{Ae=e,Ce=t},getUserConsent:ke,Chat:ge}})();
/*!
 * Copyright (c) 2024, Oracle and/or its affiliates.
 */