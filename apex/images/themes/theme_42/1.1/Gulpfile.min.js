"use strict";!function(){var buildStart=(new Date).getTime(),coreBuild=require("../../../../internal_utilities/apex_node_build/build.js"),gulp=require("gulp"),config=require("./config.json"),gutil=require("gulp-util"),function_replacements=require("./node_modules/function_replacements.js"),sassReplacements=function_replacements.concat(require("./node_modules/less_replacements.js")),lessBuilds=[];!function(){for(var key in config.dir){var dir=config.dir[key];dir.less&&(lessBuilds.push(key),dir.paths=(dir.paths||[]).concat([[".*less/",""],[".*less-src","theme/"+key+"/less-src"]]),dir.watch=["./scss/theme/"+key+"/**/*.scss"],dir.clean=["./less/theme/"+key+"/**/*.less"],dir.outputDir="theme/",dir.cwd="./",dir.src.forEach((function(src,index,arr){arr[index]="./scss/"+arr[index]})),dir.originalSrc=dir.src,dir.src=[],dir.originalSrc.forEach((function(src){dir.src.push(src.replace(/scss/g,"less"))})),dir.override&&(dir.originalSrc.unshift("!./scss/theme/"+dir.override+"/_variables.scss"),dir.originalSrc.push("./scss/theme/"+dir.override+"/**/*.scss")))}}();var rq=coreBuild(gulp,config,{apex:{require:require}});lessBuilds.forEach((function(dir){var configDir=config.dir[dir];configDir.alterSrc=function(piped){return require("merge2")(piped,gulp.src(["less/less-src/**/*.less"],{base:"./less"}).pipe(rq("gulp-replace")(/@import.*_variables/,'@import "../theme/'+dir+"/_variables")))},configDir.buildCSS=function(vinyl){var piped=gulp.src(configDir.originalSrc),replace=rq("gulp-replace"),rename=rq("gulp-rename"),clone=rq("gulp-clone"),merge=require("merge2"),convertSassToLess=function(){var convert=function(piped,replacements){return replacements.forEach((function(replacement){piped=piped.pipe(replace(replacement.pattern,replacement.replacement))})),piped};convert(piped,sassReplacements);var concatPipe=(piped=piped.pipe(replace(/\.\.\/\.\.\/modules\//,"")).pipe(replace(/"variables/,'"_variables')).pipe(rq("gulp-chmod")(777))).pipe(clone());return vinyl||(configDir.override&&(concatPipe=merge(convert(gulp.src("./scss/theme/"+configDir.override+"/_variables.scss"),sassReplacements),concatPipe)),merge(concatPipe,convert(gulp.src("./less/less-src/**/*.less"),function_replacements).pipe(replace(".*@import.*",""))).pipe(replace(/.*@import.*/g,"")).pipe(rq("gulp-concat")(config.dir[dir].name+".less")).pipe(gulp.dest("less/theme/"))),piped.pipe(rename({extname:".less"})).pipe(gulp.dest("./less/theme/"+dir).on("end",(function(){return rq("apex").buildCSS(dir,vinyl)}))),piped};if(vinyl)if("add"!==vinyl.event&&"unlink"!==vinyl.event);else if("unlink"===vinyl.event)return rq("del")([vinyl.path.replace(/scss/g,"less")]).then(convertSassToLess),piped;return convertSassToLess()},configDir.preProcessor=function(){return require("gulp-less")({compress:!0}).on("error",(function(err){gutil.log(err.message)}))}})),gulp.task("clean",(function(){return rq("del")(["!.git","css/**/*.css","less/theme/**/*.less"])})),gulp.task("build:js",(function(){jsBuild()}));var jsBuild=function(){rq("del")(["js/tmp","js/theme42.js"]),console.log("in js build"),gulp.src(config.scripts.modules).pipe(rq("gulp-concat")("theme42_modules.js")).pipe(rq("gulp-chmod")(777)).pipe(gulp.dest("js/tmp/").on("end",(function(){var fs=require("fs");console.log("after require fs");var modulesFilename=fs.readFileSync(require("path").join(__dirname,"js/tmp")+"/theme42_modules.js","utf8");gulp.src(config.scripts.src).pipe(rq("gulp-replace")(/\/\* @import_modules \*\//gi,modulesFilename)).pipe(rq("gulp-rename")("theme42.js")).pipe(rq("gulp-chmod")({owner:{read:!0,write:!0,execute:!1},group:{read:!0,write:!1,execute:!1},others:{read:!0,write:!1,execute:!1}})).pipe(gulp.dest("js/").on("end",(function(){gutil.log("Finished building theme42.js"),rq("del")(["js/tmp"])})))})))};gutil.log("Finished setting up UT 1.1 build. (Took "+((new Date).getTime()-buildStart)+" ms )"),gulp.task("watch-apex",(function(cb){rq("browser-sync").init({proxy:{target:"myapex/apex51"}}),rq("apex").watch(cb)})),gulp.task("watch-server",(function(cb){rq("gulp-watch")(["./js/src/**/*.js","!./js/src/tmp/*"],(function(vinyl){gutil.log("File "+vinyl.basename+" modified."),jsBuild()})),rq("apex").watchServer(cb)})),gulp.task("build",(function(){console.log("Building Production UT"),jsBuild(),rq("apex").build("prod")})),gulp.task("build-dev",(function(){console.log("Building Development UT"),jsBuild(),rq("apex").build("dev")}))}();